<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Hello</title>
</head>
<body>
    <div id="walletInteractionWrapper" style="display: none">
        <h1>Request to sign the credential</h1>

        <label for="holderDid">Holder DID</label><br>
        <input type="text" id="holderDid" name="holderDid"><br>

        <label for="claimKey">Key of the claim</label><br>
        <input type="text" id="claimKey" name="claimKey"><br>

        <label for="claimValue">Value of the claim</label><br>
        <input type="text" id="claimValue" name="claimValue"><br>

        <input id="credentialIssuingRequestButton" type="button" value="Request signature of these credentials" />
        <input id="credentialIssuingRequestButtonIframe" type="button" value="Request signature of these credentials (iframe)" />
        <p id="statusCredentialIssuingResponseOperationId"></p>
        <p id="statusCredentialIssuingResponseBatchId"></p>
        <p id="statusCredentialIssuingResponsePrismCredential"></p>
        <p id="statusCredentialIssuingResponseMerkleInclusionProof"></p>

        <h1>Request proof of a credential</h1>

        <label for="holderDid">Issued by DID</label><br>
        <input type="text" id="issuerDid" name="holderDid"><br>

        <label for="claimKey">Key of the claim that should be existing in VC</label><br>
        <input type="text" id="claimKeyRequired" name="claimKeyRequired"><br>

        <label for="claimValue">Value of the claim that should be existing in VC</label><br>
        <input type="text" id="claimValueRequired" name="claimValueRequired"><br>

        <input id="credentialProofRequestButton" type="button" value="Request proof" />
        <input id="credentialProofRequestButtonIframe" type="button" value="Request proof (iframe)" />
        <p id="statusCredentialProofResponseBatchId"></p>
        <p id="statusCredentialProofResponsePrismCredential"></p>
        <p id="statusCredentialProofResponseMerkleInclusionProof"></p>

        <h1>Sign in with DID</h1>

        <input id="signInRequestButton" type="button" value="Sign in" />
        <input id="signInRequestButtonIframe" type="button" value="Sign in (iframe)" />
        <p id="statusSignInResponseNonce"></p>
        <p id="statusSignInResponseSignedNonce"></p>
        <p id="statusSignInResponseHolderDid"></p>
    </div>
    <div id="walletInstallation" style="">
        <a href="https://github.com/bsandmann/blocktrust-identity-wallet">Install the blocktrust Identity Wallet</a>
    </div>

    <script>
        if (typeof blocktrust !== 'undefined') {
            document.getElementById("walletInteractionWrapper").style.display = "block";
            document.getElementById("walletInstallation").style.display = "none";
        }
        else {
            document.getElementById("walletInteractionWrapper").style.display = "none";
            document.getElementById("walletInstallation").style.display = "block";
        }

        /* This script is to enable callbacks and registered listeners can interact with the injected MainContentScript functions,
        *  and / or the IsolatedContentScript, which interacts with the extension's component(s).
        */
        function callbackCredentialIssuingRequest(result) {
            document.getElementById("statusCredentialIssuingResponse").innerHTML = result;
        }

        function callbackCredentialProofRequest(result) {
            document.getElementById("statusCredentialProofResponse").innerHTML = result;
        }

        function callbackSignInRequest(result) {
            document.getElementById("statusSignInResponse").innerHTML = result;
        }

        document.getElementById("credentialIssuingRequestButton").addEventListener(
            // Sends a message to the MainContentScript
            "click",
            () => {
                holderDid = document.getElementById("holderDid").value.trim();
                claimKey = document.getElementById("claimKey").value.trim();
                claimValue = document.getElementById("claimValue").value.trim();
                let claimsMap = [{ [claimKey]: claimValue }];
                sendWalletRequest({
                    type: "CREDENTIAL_ISSUING_REQUEST",
                    content: { 'holderDid': holderDid, 'claims': claimsMap },
                    iframeMode: false,
                }, callbackCredentialIssuingRequest)
                console.log(claimsMap)
            },
            false
        );
        document.getElementById("credentialIssuingRequestButtonIframe").addEventListener(
            // Sends a message to the content-script
            "click",
            () => {
                holderDid = document.getElementById("holderDid").value.trim();
                claimKey = document.getElementById("claimKey").value.trim();
                claimValue = document.getElementById("claimValue").value.trim();
                let claimsMap = [{ [claimKey]: claimValue }];
                sendWalletRequest({
                    type: "CREDENTIAL_ISSUING_REQUEST",
                    content: { 'holderDid': holderDid, 'claims': claimsMap },
                    iframeMode: true
                }, callbackCredentialIssuingRequest)
                console.log(claimsMap)
            },
            false
        );

        document.getElementById("credentialProofRequestButton").addEventListener(
            // Sends a message to the content-script
            "click",
            () => {
                issuerDid = document.getElementById("issuerDid").value;
                claimKeyRequired = document.getElementById("claimKeyRequired").value.trim();
                claimValueRequired = document.getElementById("claimValueRequired").value.trim();
                let claimsMap = [{ [claimKeyRequired]: claimValueRequired }];
                sendWalletRequest({
                    type: "CREDENTIAL_PROOF_REQUEST",
                    content: { 'issuerDid': issuerDid, 'claims': claimsMap },
                    iframeMode: false
                }, callbackCredentialProofRequest)
            },
            false
        );

        document.getElementById("credentialProofRequestButtonIframe").addEventListener(
            // Sends a message to the content-script
            "click",
            () => {
                issuerDid = document.getElementById("issuerDid").value;
                claimKeyRequired = document.getElementById("claimKeyRequired").value.trim();
                claimValueRequired = document.getElementById("claimValueRequired").value.trim();
                let claimsMap = [{ [claimKeyRequired]: claimValueRequired }];
                sendWalletRequest({
                    type: "CREDENTIAL_PROOF_REQUEST",
                    content: { 'issuerDid': issuerDid, 'claims': claimsMap },
                    iframeMode: true
                }, callbackCredentialProofRequest)
            },
            false
        );

        document.getElementById("signInRequestButton").addEventListener(
            // Sends a message to the content-script
            "click",
            () => {
                nonce = makeid(32);
                sendWalletRequest({
                    type: "SIGNIN_REQUEST",
                    content: { 'nonce': nonce },
                    iframeMode: false
                }, callbackSignInRequest)
            },
            false
        );

        document.getElementById("signInRequestButtonIframe").addEventListener(
            // Sends a message to the content-script
            "click",
            () => {
                nonce = makeid(32);
                sendWalletRequest({
                    type: "SIGNIN_REQUEST",
                    content: { 'nonce': nonce },
                    iframeMode: true
                }, callbackSignInRequest)
            },
            false
        );

        //Refactor into IntegratedScript
        function makeid(length) {
            var result = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        (() => {
            window.addEventListener(
                "message",
                (event) => {
                    // console.log(event.data)
                    if (event.data && event.data.messageType === 'WALLET_RESPONSE_MSG') {
                        // console.log("continue")
                        if (window.location.origin.toLowerCase() !== event.data.content.sourceOrigin.toLowerCase()) {
                            console.log("invalid source. Expected " + event.data.content.sourceOrigin + " , but found " + window.location.origin)
                        } else if (event.data.timestamp < 10000) {
                            //TODO
                            console.log("invalid timestamp")
                        } else {
                            // console.log(event.data.content);
                            var walletResponseType = event.data.content.walletResponseType;
                            if (walletResponseType === "CREDENTIAL_ISSUING_RESPONSE") {
                                console.log("HTML received credential issuing response:");
                                document.getElementById("statusCredentialIssuingResponseOperationId").innerHTML = "operationId:" + event.data.content.operationId;
                                document.getElementById("statusCredentialIssuingResponseBatchId").innerHTML = "batchId:" + event.data.content.batchId;
                                document.getElementById("statusCredentialIssuingResponsePrismCredential").innerHTML = "PrismCredential:" + event.data.content.prismCredential;
                                document.getElementById("statusCredentialIssuingResponseMerkleInclusionProof").innerHTML = "MerkleProof:" + event.data.content.merkleInclusionProof;
                            } else if (walletResponseType === "CREDENTIAL_PROOF_RESPONSE") {
                                console.log("HTML received credential proof response:")
                                document.getElementById("statusCredentialProofResponseBatchId").innerHTML = "batchId:" + event.data.content.batchId;
                                document.getElementById("statusCredentialProofResponsePrismCredential").innerHTML = "PrismCredential:" + event.data.content.prismCredential;
                                document.getElementById("statusCredentialProofResponseMerkleInclusionProof").innerHTML = "MerkleProof:" + event.data.content.merkleInclusionProof;
                            } else if (walletResponseType === "SIGNIN_RESPONSE") {
                                console.log("HTML received signIn response:")
                                document.getElementById("statusSignInResponseNonce").innerHTML = "nonce:" + event.data.content.nonce;
                                document.getElementById("statusSignInResponseSignedNonce").innerHTML = "signed nonce:" + event.data.content.signedNonce;
                                document.getElementById("statusSignInResponseHolderDid").innerHTML = "holderDID:" + event.data.content.holderDid;
                            }
                        }
                    } else if (event.data && event.data.messageType === 'CLOSE_IFRAME_MSG') {
                        // already handled by the IntegratedScript. No need to do anything here
                    }
                }
                ,
                false
            )
        })();
    </script>
</body>
</html>