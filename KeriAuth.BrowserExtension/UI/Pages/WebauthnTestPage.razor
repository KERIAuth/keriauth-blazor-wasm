@page "/Webauthn"
@layout Layouts.MainLayout

@using KeriAuth.BrowserExtension.Helper
@using KeriAuth.BrowserExtension.Models
@using KeriAuth.BrowserExtension.Services
@using KeriAuth.BrowserExtension
@using KeriAuth.BrowserExtension.UI.Components
@using KeriAuth.BrowserExtension.Services.SignifyService
@using KeriAuth.BrowserExtension.Services.SignifyService.Models
@using static KeriAuth.BrowserExtension.Helper.PreviousPage
@using static KeriAuth.BrowserExtension.AppConfig;
@using static KeriAuth.BrowserExtension.Helper.UIHelper;
@using static KeriAuth.BrowserExtension.Services.SignifyService.SignifyServiceConfig
@using FluentResults
@using JsBind.Net
@using JsBind.Net.Configurations
@using System.Diagnostics;
@using System.Text.Json;
@using System.Text.Json.Nodes
@using Blazor.BrowserExtension
@using WebExtensions.Net
@using WebExtensions.Net.Runtime
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@using JsonSerializer = System.Text.Json.JsonSerializer
@using static System.Net.WebRequestMethods
@using System.ComponentModel.DataAnnotations
@using System.Linq
@using System.Text
@using System.Security.Cryptography

@inject IPreferencesService preferencesService
@inject IStorageService storageService
@inject IStateService stateService
@inject IExtensionEnvironmentService extensionEnvironmentService
@inject ILogger<WebauthnTestPage> logger
@inject HttpClient http
@inject NavigationManager navManager
@inject IJSRuntime js
@inject ISignifyClientService signifyClientService
@inject ISnackbar snackbar
@inject IWebExtensionsApi webExtensionsApi
@inject IWebauthnService webauthnService
@inject IJsRuntimeAdapter jsra
@inject ILogger<WebauthnService> loggerForWAS

@code {
    async Task RegisterAuthenticatorAndAttest()
    {
        var res = await webauthnService.RegisterAttestStoreAuthenticator();
        if (res.IsFailed)
        {
            snackbar.Add("Authenticator not registered", Severity.Warning);
            logger.LogWarning("RegisterCredential failed: {x}", res.Errors.ToArray());
        }
        else
        {
            snackbar.Add("Authenticator successfully registered.", Severity.Success);
        }
        navManager.NavigateTo(AppConfig.RouteToAuthenticators); // TODO P3 or wherever thay came from
    }

    async Task authenticateCredential()
    {
        var res = await webauthnService.AuthenticateAKnownCredential();
        logger.LogWarning("authenticateCredential: {r}",  res);
        return;
        // TODO P0 retrieve all credentials and pass in their Ids and merged transports (or an everything set)
        // var res = await webauthnService.AuthenticateCredential(credentialIdBase64, transports);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main" style="justify-content:center;">
        <MudStack>
            <MudButton OnClick="RegisterAuthenticatorAndAttest">Register Authenticator And Attest</MudButton>
            <hr />
            <MudButton OnClick="authenticateCredential">authenticate Credential</MudButton>
        </MudStack>
    </div>
</div>