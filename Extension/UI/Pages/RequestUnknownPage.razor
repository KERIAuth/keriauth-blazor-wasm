@page "/RequestUnknown.html"
@layout Layouts.DialogLayout
@inherits Extension.UI.Components.TabDialogPageBase

@using System.Text.Json
@using Extension.Models.Storage
@using MudBlazor

@inject ILogger<RequestUnknownPage> logger

@code {
    // Page-specific fields
    private MudButton? cancelButton;

    // Page-specific properties
    PendingBwAppRequest? pendingRequest { get; set; }

    // Computed properties
    string pendingRequestPrettyPrint => pendingRequest is null ? "null" : JsonSerializer.Serialize(pendingRequest, new JsonSerializerOptions { WriteIndented = true });

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        logger.LogInformation("OnInitializedAsync");

        // Get the pending request from storage (set by BackgroundWorker before opening popup)
        // Note: We don't validate type here since this page handles any unimplemented request type
        pendingRequest = AppCache.NextPendingBwAppRequest;
        if (pendingRequest is null)
        {
            logger.LogWarning("OnInitializedAsync: No pending request found");
            return;
        }

        logger.LogWarning("OnInitializedAsync: No implemented page for request: {r}", pendingRequest);

        // Set base class state from pending request
        PageRequestId = pendingRequest.RequestId;
        TabId = pendingRequest.TabId ?? -1;
        OriginStr = pendingRequest.TabUrl ?? "unknown";

        // Load the active tab for display
        await LoadActiveTabAsync();

        IsInitialized = true;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetCancelButtonFocus();
        }
    }

    async Task SetCancelButtonFocus()
    {
        if (cancelButton is not null)
        {
            await cancelButton.FocusAsync();
        }
    }

    async Task Cancel()
    {
        await CancelAndReturnAsync("User canceled unknown request");
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Code == "NumpadEnter")
        {
            await Cancel();
        }
    }
}

@if (IsInitialized)
{
    <div id="@this.GetType().Name" class="bt-body-page">
        <MudStack Class="bt-main">
            <div class="bt-main-inside-scroll">
                <PageHeading Title="Request Received — Implementation Pending" />

                @if (ActiveTab is not null)
                {
                    <TabInteractionDisplay ActiveTab=@ActiveTab />
                }
                else
                {
                    <MudText Typo="Typo.body1" Class="mb-4">Unknown Page (tab not found)</MudText>
                }

                <MudAlert Severity="Severity.Warning" Class="mt-4 mb-2">
                    <MudText Typo="Typo.body2">This website has made a request that KERI Auth has not yet implemented.</MudText>
                </MudAlert>

                <MudText Class="bt-section-title">Details:</MudText>
                <MudText>(as modified from Page → ContentScript → BackgroundWorker → here)</MudText>
                <MudPaper Class="pa-2" Outlined="true" Style="max-height: 360px; overflow:auto;">
                    <MudText Typo="Typo.body2" Style="font-family: monospace;">
                        <pre style="margin:0; white-space: pre;">@pendingRequestPrettyPrint</pre>
                    </MudText>
                </MudPaper>
            </div>
        </MudStack>

        <MudStack Row="true" class="bt-button-tray">
            <MudButton @ref="cancelButton"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="Cancel"
                       @onkeydown="HandleKeyDown">
                       Cancel
            </MudButton>
        </MudStack>
    </div>
}

