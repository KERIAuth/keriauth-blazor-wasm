@page "/DeveloperTest.html"
@using Extension.Models
@using Extension.Services
@using Extension.Services.Port
@using Extension.Models.Messages.AppBw
@using System.Reactive.Linq
@inject NavigationManager navManager
@using static Extension.AppConfig;
@inject IJSRuntime js
@using static Extension.Helper.PreviousPage
@inject ILogger<PreferencesPage> logger
@inject AppCache appCache
@inject IAppBwPortService appBwPortService  // For port connection status
@using System.Linq.Expressions
@inject ISnackbar snackbar
@inject IDialogService dialogService

@implements IDisposable

@code
{
    private class BoolItem
    {
        public Expression<Func<bool>> Condition { get; set; } = default!;
        public string? Label { get; set; }
        public int Indent { get; set; }
        public BoolItem(Expression<Func<bool>> condition, string? label = null, int indent = 0)
        {
            Condition = condition;
            Label = label;
            Indent = indent;
        }
    }

    // private const string popupTestUrl = "chrome-extension://dkjahajaknoahpngklccdmbgdnjlempj/index.html?message=%257B%2522type%2522%253A%2522%252Fsignify%252Fauthorize%2522%252C%2522requestId%2522%253A%252247705f1b-d4ba-43b0-ac3b-7637bcd9c572%2522%252C%2522payload%2522%253A%257B%2522message%2522%253A%2522Message%25201765134849911%2522%257D%257D&origin=\"http%3a%2f%2flocalhost%3a5173%2f\"&popupType=SelectAuthorize&tabId=1716420357&environment=ActionPopup";
    private List<BoolItem> Conditions = new();

    // Computed properties for consistency checks
    bool IsSelectedPrefixConsistent => appCache.ValidateSelectedPrefixAmongIdentifiers();

    protected override async Task OnInitializedAsync()
    {
        await this.SubscribeToAppCache(appCache);

        logger.LogInformation("OnInitializedAsync");
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }

    async Task ShowMessageBoxExample()
    {
        var result = await dialogService.ShowMessageBox(
               "Delete Configuration",
               $"Are you sure you want to delete your local configuration and reload the extension?",
               yesText: "Yes, Delete",
               cancelText: "Cancel",
                options: new DialogOptions()
                {
                    CloseOnEscapeKey = true,
                }
            );
    }

    async Task ShowConfirmDeleteConfigExample()
    {
        // 1
        var parameters = new DialogParameters<ConfirmDeleteConfigDialog> {
            { x => x.ConfigAlias, "_config alias_" },
            { x => x.IsOnlyConfig, true },
            { x => x.PasskeyCount, 999 }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await dialogService.ShowAsync<ConfirmDeleteConfigDialog>("Delete Configuration", parameters, options);
    }

    async Task ShowAddProfileDialogExample()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            BackdropClick = false,
            CloseButton = true,
            Position = DialogPosition.Center,
        };
        var dialog = await dialogService.ShowAsync<AddProfileDialog>("Add Profile", parameters, options);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="Developer Test" />



            <MudText>Pages not on main menu</MudText>
            <div>
                <MudLink Href="@(Routes.PathFor<WelcomePage>())" Target="_self">Welcome</MudLink>
                <MudLink Href="@(Routes.PathFor<NewReleasePage>())" Target="_self">Release</MudLink>
                <MudLink Href="@(Routes.PathFor<TermsPage>())" Target="_self">Terms</MudLink>
                <MudLink Href="@(Routes.PathFor<ConfigurePage>())" Target="_self">Configure</MudLink>
                <MudLink Href="@(Routes.PathFor<UnlockPage>())" Target="_self">Unlock</MudLink>
                <MudLink Href="@(Routes.PathFor<ConnectingPage>())" Target="_self">Connecting</MudLink>
                <MudLink Href="@(Routes.PathFor<AddPasskeyPage>())" Target="_self">Add Passkey</MudLink>
                <MudLink Href="@(Routes.PathFor<DeletePage>())" Target="_self">Delete Local Config</MudLink>
                <MudLink Href="@(Routes.PathFor<GettingStartedPage>())" Target="_self">Getting Started</MudLink>
                <MudLink Href="@(Routes.PathFor<OfferPasskeyPage>())" Target="_self">Offer Passkey</MudLink>
            </div>
            <MudText>Dialog Pages</MudText>
            <div>
                <MudLink Href="@(Routes.PathFor<RequestCreateCredentialPage>())" Target="_self">Request Create Credential</MudLink>
                <MudLink Href="@(Routes.PathFor<RequestSignDataPage>())" Target="_self">Request Sign Data</MudLink>
                <MudLink Href="@(Routes.PathFor<RequestSignHeadersPage>())" Target="_self">Request Sign Headers</MudLink>
                <MudLink Href="@(Routes.PathFor<RequestSignInPage>())" Target="_self">Request Sign In</MudLink>
                <MudLink Href="@(Routes.PathFor<RequestUnknownPage>())" Target="_self">Request Unknown</MudLink>
            </div>
            <MudText>Parameterized Pages</MudText>
            <div>
                <MudLink Href="@(Routes.PathFor<KeriaConfigPage>() + "x")" Target="_self">KERIA Config</MudLink>
                <MudLink Href="@(Routes.PathFor<ProfilePage>() + "x")" Target="_self">Profile</MudLink>
                <MudLink Href="@(Routes.PathFor<WebsitePage>() + "x")" Target="_self">Website</MudLink>
            </div>
            <MudText>Dialogs</MudText>
            <div>
                <MudLink OnClick="@ShowAddProfileDialogExample">Add Profile</MudLink>
                <MudLink OnClick="@ShowConfirmDeleteConfigExample">Confirm Delete Config</MudLink>
                <MudLink OnClick="@ShowMessageBoxExample">Message Box</MudLink>
            </div>
            <MudText Class="pl-0">Other</MudText>
            <div>
                <MudLink OnClick='@(async () => snackbar.Add("testing testing testing testing"))'>Snackbar</MudLink>
            </div>
            <MudText>Port Testing</MudText>
            <MudStack>
                <MudText>To disconnect/stop/inactivate: navigate to chrome://serviceworker-internals and Stop the service-worker. Should restart based on its listener events.</MudText>
            </MudStack>
        </div>
    </div>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer />
    </MudStack>
</div>
