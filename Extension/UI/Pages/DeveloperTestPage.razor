@page "/DeveloperTest.html"
@using Extension.Models
@using Extension.Models.Storage
@using Extension.Services
@using Extension.Services.Port
@using Extension.Models.Messages.AppBw
@using Extension.Models.Messages.BwApp
@using Extension.Models.Messages.BwApp.Requests
@using System.Reactive.Linq
@inject NavigationManager navManager
@using static Extension.AppConfig;
@inject IJSRuntime js
@using static Extension.Helper.PreviousPage
@inject ILogger<PreferencesPage> logger
@inject AppCache appCache
@inject IAppBwPortService appBwPortService // For port connection status
@using System.Linq.Expressions
@inject ISnackbar snackbar
@inject IDialogService dialogService
@inject IPendingBwAppRequestService pendingBwAppRequestService
@inject IWebExtensionsApi webExtensionsApi
@inject IWebsiteConfigService websiteConfigService

@implements IDisposable

@code
{
    private class BoolItem
    {
        public Expression<Func<bool>> Condition { get; set; } = default!;
        public string? Label { get; set; }
        public int Indent { get; set; }
        public BoolItem(Expression<Func<bool>> condition, string? label = null, int indent = 0)
        {
            Condition = condition;
            Label = label;
            Indent = indent;
        }
    }

    private List<BoolItem> Conditions = new();

    // Computed properties for consistency checks
    bool IsSelectedPrefixConsistent => appCache.ValidateSelectedPrefixAmongIdentifiers();

    protected override async Task OnInitializedAsync()
    {
        await this.SubscribeToAppCache(appCache);

        logger.LogInformation("OnInitializedAsync");
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }

    async Task<int> GetCurrentTabIdAsync()
    {
        var currentTab = await webExtensionsApi.Tabs.GetCurrent();
        return currentTab?.Id ?? -1;
    }

    async Task SimulateDialogRequestAsync(string type, Func<int, object> payloadFactory, string targetRoute)
    {
        await pendingBwAppRequestService.ClearAllRequestsAsync();
        var tabId = await GetCurrentTabIdAsync();
        var pendingRequest = new PendingBwAppRequest {
            RequestId = Guid.NewGuid().ToString(),
            Type = type,
            Payload = payloadFactory(tabId),
            CreatedAtUtc = DateTime.UtcNow,
            TabId = tabId,
            TabUrl = "https://example.com/test"
        };
        await pendingBwAppRequestService.AddRequestAsync(pendingRequest);
        navManager.NavigateTo(targetRoute);
    }

    async Task SimulateRequestSignIn() => await SimulateDialogRequestAsync(
        BwAppMessageType.Values.RequestSelectAuthorize,
        tabId => new RequestSelectAuthorizePayload(
            Origin: "https://example.com",
            TabId: tabId,
            TabUrl: "https://example.com/test",
            OriginalRequestId: Guid.NewGuid().ToString(),
            OriginalType: "/signify/authorize"
        ),
        Routes.PathFor<RequestSignInPage>()
    );

    async Task SimulateRequestSignHeaders() => await SimulateDialogRequestAsync(
        BwAppMessageType.Values.RequestSignHeaders,
        tabId => new RequestSignHeadersPayload(
            Origin: "https://example.com",
            Url: "https://example.com/api/data",
            Method: "GET",
            Headers: new Dictionary<string, string>(),
            TabId: tabId,
            TabUrl: "https://example.com/test",
            OriginalRequestId: Guid.NewGuid().ToString(),
            OriginalType: "/signify/sign-request"
        ),
        Routes.PathFor<RequestSignHeadersPage>()
    );

    async Task SimulateRequestSignData() => await SimulateDialogRequestAsync(
        BwAppMessageType.Values.RequestSignData,
        tabId => new RequestSignDataPayload(
            Origin: "https://example.com",
            Message: "Please sign this data",
            Items: ["item-to-sign-1", "item-to-sign-2"],
            TabId: tabId,
            TabUrl: "https://example.com/test",
            OriginalRequestId: Guid.NewGuid().ToString(),
            OriginalType: "/signify/sign-data"
        ),
        Routes.PathFor<RequestSignDataPage>()
    );

    async Task SimulateRequestSignDataCustomized() => await SimulateDialogRequestAsync(
        BwAppMessageType.Values.RequestSignData,
        tabId => new RequestSignDataPayload(
            Origin: "https://example.com",
            Message: "{\"requestTitleText\":\"Authorize Credential Issuance\", \"requestText\":\"Review and approve the set of credential fields below\", \"itemsLabel\":\"Credential fields\", \"buttonText\":\"Authorize\"}",
            Items: ["item-to-sign-1", "item-to-sign-2"],
            TabId: tabId,
            TabUrl: "https://example.com/test",
            OriginalRequestId: Guid.NewGuid().ToString(),
            OriginalType: "/signify/sign-data"
        ),
        Routes.PathFor<RequestSignDataPage>()
    );

    async Task SimulateRequestCreateCredential() => await SimulateDialogRequestAsync(
        BwAppMessageType.Values.RequestCreateCredential,
        tabId => new RequestCreateCredentialPayload(
            Origin: "https://example.com",
            CredData: new { d = "", u = "", i = "", dt = "2025-01-01T00:00:00Z", LEI = "5493001KJTIIGC8Y1R17" },
            SchemaSaid: "EBfdlu8R27Fbx-ehrqwImnK-8Cm79sqbAQ4MmvEAYqao",
            TabId: tabId,
            TabUrl: "https://example.com/test",
            OriginalRequestId: Guid.NewGuid().ToString(),
            OriginalType: "/signify/credential/create/data-attestation"
        ),
        Routes.PathFor<RequestCreateCredentialPage>()
    );

    async Task SimulateRequestConnect() => await SimulateDialogRequestAsync(
        BwAppMessageType.Values.RequestConnectionInvite,
        _ => new ConnectionInviteRequestPayload(
            Oobi: "https://keria-ext.dev.idw-sandboxes.cf-deployments.org/oobi/EFMPf5HdMA3Wd09_Rq3hNjgRFw1XKhHeuIW6Noqhszd3/agent/EMhtGVe_k0b0NQXqJvJzm5NvhYkggbnLkKNaTtxmOcxe?name=CF%20Credential%20Issuance4",
            ResolvedAidPrefix: "EFMPf5HdMA3Wd09_Rq3hNjgRFw1XKhHeuIW6Noqhszd3",
            ResolvedAlias: "CF Credential Issuance4",
            TabUrl: "https://example.com/test"
        ),
        Routes.PathFor<RequestConnectPage>()
    );

    async Task SimulateRequestUnknown() => await SimulateDialogRequestAsync(
        "BwApp.UnknownType",
        _ => new { foo = "bar" } as object,
        Routes.PathFor<RequestUnknownPage>()
    );

    void NavigateToKeriaConfig()
    {
        var digest = appCache.MyKeriaConnectConfigs.Configs.Keys.FirstOrDefault();
        if (digest is null)
        {
            snackbar.Add("No KERIA configurations found in storage");
            return;
        }
        navManager.NavigateTo(Routes.PathFor<KeriaConfigPage>() + digest);
    }

    void NavigateToProfile()
    {
        var prefix = appCache.Aids.FirstOrDefault()?.Prefix;
        if (prefix is null)
        {
            snackbar.Add("No identifiers found in storage");
            return;
        }
        navManager.NavigateTo(Routes.PathFor<ProfilePage>() + prefix);
    }

    async Task NavigateToWebsite()
    {
        var listResult = await websiteConfigService.GetList();
        var origin = listResult.IsSuccess ? listResult.Value?.WebsiteList.FirstOrDefault()?.Origin : null;
        if (origin is null)
        {
            snackbar.Add("No websites found in storage");
            return;
        }
        navManager.NavigateTo(Routes.PathFor<WebsitePage>() + HttpUtility.UrlEncode(origin.OriginalString));
    }

    async Task ShowMessageBoxExample()
    {
        var result = await dialogService.ShowMessageBox(
               "Auto-approve safe requests?",
               $"Are you sure you want to auto-approve all safe HTTP requests?",
               yesText: "Yes, Auto-approve",
               cancelText: "Cancel",
                options: new DialogOptions()
                {
                    CloseOnEscapeKey = true,
                }
            );
    }

    async Task ShowConfirmDeleteConfigExample()
    {
        // 1
        var parameters = new DialogParameters<ConfirmDeleteConfigDialog> {
            { x => x.ConfigAlias, "_config alias_" },
            { x => x.IsOnlyConfig, true },
            { x => x.PasskeyCount, 999 }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await dialogService.ShowAsync<ConfirmDeleteConfigDialog>("Delete Configuration", parameters, options);
    }

    async Task ShowAddProfileDialogExample()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            BackdropClick = false,
            CloseButton = true,
            Position = DialogPosition.Center,
        };
        var dialog = await dialogService.ShowAsync<AddProfileDialog>("Add Profile", parameters, options);
    }

    async Task ShowConnectionChoiceDialogExample()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true, CloseButton = true };
        var dialog = await dialogService.ShowAsync<ConnectionChoiceDialog>("Add Connection", new DialogParameters(), options);
    }

    async Task ShowAddConnectionDialogExample()
    {
        var parameters = new DialogParameters<AddConnectionDialog> {
            { x => x.Mode, "receive" },
            { x => x.DefaultName, "" }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true, CloseButton = true };
        var dialog = await dialogService.ShowAsync<AddConnectionDialog>("Add Connection", parameters, options);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="Developer Test" />



            <MudText Typo="Typo.h6">Pages not on main menu</MudText>
            <div class="bt-link-list">
                <MudLink Href="@(Routes.PathFor<WelcomePage>())" Target="_self">Welcome</MudLink>
                <MudLink Href="@(Routes.PathFor<NewReleasePage>())" Target="_self">Release</MudLink>
                <MudLink Href="@(Routes.PathFor<TermsPage>())" Target="_self">Terms</MudLink>
                <MudLink Href="@(Routes.PathFor<ConfigurePage>())" Target="_self">Configure</MudLink>
                <MudLink Href="@(Routes.PathFor<UnlockPage>())" Target="_self">Unlock</MudLink>
                <MudLink Href="@(Routes.PathFor<ConnectingPage>())" Target="_self">Connecting</MudLink>
                <MudLink Href="@(Routes.PathFor<AddPasskeyPage>())" Target="_self">Add Passkey</MudLink>
                <MudLink Href="@(Routes.PathFor<DeletePage>())" Target="_self">Delete Local Config</MudLink>
                <MudLink Href="@(Routes.PathFor<GettingStartedPage>())" Target="_self">Getting Started</MudLink>
                <MudLink Href="@(Routes.PathFor<OfferPasskeyPage>())" Target="_self">Offer Passkey</MudLink>
                <MudLink Href="@(Routes.PathFor<ReleaseHistoryPage>())" Target="_self">Release History</MudLink>
            </div>
            <MudText Typo="Typo.h6">Dialog Pages (simulated)</MudText>
            <div class="bt-link-list">
                <MudLink OnClick="@SimulateRequestSignIn" Disabled="@(!appCache.IsConnectedToKeria)">Request Sign In</MudLink>
                <MudLink OnClick="@SimulateRequestSignHeaders" Disabled="@(!appCache.IsConnectedToKeria)">Request Sign Headers</MudLink>
                <MudLink OnClick="@SimulateRequestSignData" Disabled="@(!appCache.IsConnectedToKeria)">Request Sign Data</MudLink>
                <MudLink OnClick="@SimulateRequestSignDataCustomized" Disabled="@(!appCache.IsConnectedToKeria)">Request Sign Data (customized)</MudLink>
                <MudLink OnClick="@SimulateRequestCreateCredential" Disabled="@(!appCache.IsConnectedToKeria)">Request Create Credential</MudLink>
                <MudLink OnClick="@SimulateRequestConnect" Disabled="@(!appCache.IsConnectedToKeria)">Request Connection</MudLink>
                <MudLink OnClick="@SimulateRequestUnknown" Disabled="@(!appCache.IsConnectedToKeria)">Request Unknown</MudLink>
            </div>
            <MudText Typo="Typo.h6">Parameterized Pages</MudText>
            <div class="bt-link-list">
                <MudLink OnClick="@NavigateToKeriaConfig">KERIA Config</MudLink>
                <MudLink OnClick="@NavigateToProfile">Profile</MudLink>
                <MudLink OnClick="@NavigateToWebsite">Website</MudLink>
            </div>
            <MudText Typo="Typo.h6">Dialogs</MudText>
            <div class="bt-link-list">
                <MudLink OnClick="@ShowAddConnectionDialogExample">Add Connection</MudLink>
                <MudLink OnClick="@ShowConnectionChoiceDialogExample">Connection Choice</MudLink>
                <MudLink OnClick="@ShowAddProfileDialogExample">Add Profile</MudLink>
                <MudLink OnClick="@ShowConfirmDeleteConfigExample">Confirm Delete Config</MudLink>
                <MudLink OnClick="@ShowMessageBoxExample">Message Box Example</MudLink>
            </div>
            <MudText Typo="Typo.h6">Other</MudText>
            <div class="bt-link-list">
                <MudLink OnClick='@(async () => snackbar.Add("testing testing testing testing"))'>Snackbar</MudLink>
            </div>
            <MudText Typo="Typo.h6">Port Testing</MudText>
            <MudStack>
                <MudText>To disconnect/stop/inactivate: navigate to chrome://serviceworker-internals and Stop the service-worker. Should restart based on its listener events.</MudText>
            </MudStack>
        </div>
    </div>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer />
    </MudStack>
</div>