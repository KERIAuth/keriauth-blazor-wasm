@page "/Websites.html"
@layout Layouts.MainLayout
@inherits AuthenticatedPageBase
@implements IDisposable
@using Extension.Services.Storage
@using System.Text.Json.Serialization
@using System;
@using System.Collections.Generic;
@using Extension.Utilities

@inject IStorageService storageService
@inject NavigationManager navManager
@inject IJSRuntime js
@inject ILogger<WebsitesPage> logger
@inject IDialogService dialogService
@inject ISnackbar snackbar
@inject IWebsiteConfigService websiteConfigService
@inject IStorageService storageService
@inject IAppBwPortService appBwPortService
@using Extension.Services.Port
@inject IJSRuntime jsRuntime
@inject AppCache appCache

@code {
    // fields
    List<WebsiteConfig>? allWebsites;
    string selectedViewDefId = ViewDefIds.WebActive;
    string? SelectedWebsiteOrigin { get; set; }

    // ViewDef
    List<ViewDef<WebsiteConfig>> WebsiteViewDefs =>
    [
        new(ViewDefIds.WebActive, "Active profile",
            FilterSets: [new("ActiveProfile", [(WebsiteConfig w) => w.RememberedPrefixOrNothing == appCache.SelectedPrefix])],
            CountStyle: CountStyle.ForProfile),
        new(ViewDefIds.WebAll, "All profiles",
            CountStyle: CountStyle.Total)
    ];

    ViewDef<WebsiteConfig>? SelectedViewDef => WebsiteViewDefs.FirstOrDefault(v => v.Id == selectedViewDefId);
    List<WebsiteConfig> FilteredWebsites => allWebsites is not null
        ? ViewDefHelper.Apply(allWebsites, SelectedViewDef)
        : [];

    bool IsLoaded => allWebsites is not null;

    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation($"OnInitializedAsync");

        // Initialize base class for authentication-based render suppression
        InitializeAppCache(appCache);

        // Subscribe to AppCache changes - will trigger StateHasChanged when state updates
        await this.SubscribeToAppCache(appCache);

        // Restore persisted ViewDef selection
        var pageKey = GetType().Name;
        if (appCache.MyPreferences.SelectedViewDefIds.TryGetValue(pageKey, out var savedId)
            && WebsiteViewDefs.Any(v => v.Id == savedId))
        {
            selectedViewDefId = savedId;
        }
    }

    async Task OnViewDefChanged(string newId)
    {
        selectedViewDefId = newId;
        var updatedIds = new Dictionary<string, string>(appCache.MyPreferences.SelectedViewDefIds)
        {
            [GetType().Name] = newId
        };
        await storageService.SetItem(appCache.MyPreferences with { SelectedViewDefIds = updatedIds });
    }

    protected override async Task OnParametersSetAsync()
    {
        logger.LogInformation($"OnParametersSetAsync");
        var websitesRes = await websiteConfigService.GetList();
        if (websitesRes is not null && websitesRes.IsSuccess && websitesRes.Value is not null && websitesRes.Value.WebsiteList.Any())
        {
            allWebsites = websitesRes.Value.WebsiteList;
            SelectedWebsiteOrigin = allWebsites.First().Origin.OriginalString;
        }
        else
        {
            allWebsites = [];
            SelectedWebsiteOrigin = null;
        }
    }

    // Handle callback from the WebsiteConfigDisplay
    private void HandleValueChanged((string? selectedPrefix, string? selectedAlias, RecursiveDictionary? selectedCredentialOrNothing, WebsiteConfig? websiteConfig) value)
    {
        logger.LogError($"NOT YET IMPLEMENTED HandleValueChanged prefix {value.selectedPrefix} | selectedCredential {value.selectedCredentialOrNothing is not null}");
        StateHasChanged();
    }

    void navigateToWebsitePage(string origin)
    {
        navManager.NavigateTo(Routes.PathFor<WebsitePage>() + HttpUtility.UrlEncode(origin.ToString()));
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="Websites" />
            <ViewSelector T="WebsiteConfig"
                          ViewDefs="@WebsiteViewDefs"
                          SelectedViewDefId="@selectedViewDefId"
                          SelectedViewDefIdChanged="@OnViewDefChanged"
                          FilteredCount="@(IsLoaded ? FilteredWebsites.Count : (int?)null)"
                          TotalCount="@(IsLoaded ? allWebsites!.Count : (int?)null)" />
            @if (IsLoaded && FilteredWebsites.Any())
            {
                <MudPaper Elevation="0">
                    <MudTable Elevation="0" Items="FilteredWebsites" Hover="false" Striped="true" Style="table-layout: fixed; width: 100%;">
                        <HeaderContent>
                            <MudTh Style="width: 55%; white-space: normal; font-weight:600;">Website</MudTh>
                            <MudTh Style="width: 10%; white-space: normal; font-weight:600;">Profile</MudTh>
                            <MudTh Style="width: 10%; white-space: normal; font-weight:600;">Credential</MudTh>
                            <!-- // TODO P2 Auto-Sign headers indicator <MudTh Style="width: 15%; white-space: normal; font-weight:600;">Auto-sign Http Request Headers that have no side effects?</MudTh>
                                -->
                            <MudTh Style="width: 10%; white-space: normal; font-weight:600;">Edit</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Website" Style="word-break: break-all;"><MudLink Href="@context.Origin.OriginalString" Target="@((DeterministicHash.ComputeHash(context.Origin.OriginalString)).ToString())">@context.Origin.OriginalString</MudLink></MudTd>
                            <MudTd DataLabel="Profile">
                                @if (context.RememberedPrefixOrNothing is not null)
                                {
                                    <MudIcon ViewBox="0 0 100 100" Icon="@(Helper.Identicon.MakeIdenticon(context.RememberedPrefixOrNothing))" Class="bt-identicon" />
                                }
                            </MudTd>
                            <MudTd DataLabel="Credential">
                                @if (!string.IsNullOrEmpty(context.RememberedCredSaidOrNothing))
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Close" Style="opacity: 0.3;" Size="Size.Small" />
                                }
                            </MudTd>
                            <!--  // TODO P2 Auto-Sign headers indicator
                            <MudTd DataLabel="AutoSign">@(context.IsAutoSignSafeHeaders ? "Yes" : "No")</MudTd>
                            -->
                            <MudTd DataLabel="Edit">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => navigateToWebsitePage(@context.Origin.OriginalString))"></MudIconButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            }
            else
            {
                <MudText>After navigating to a website supporting KERI browser extensions (using polaris-web interfaces and others) and then interacting with this extension, that website will be listed here.</MudText>
            }
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer></MudSpacer>
    </MudStack>
</div>

<style>
    .mud-select .mud-select-input .mud-input-slot {
        height: auto;
    }

    .selected-item {
        border-left: 4px solid blue;
    }
</style>
