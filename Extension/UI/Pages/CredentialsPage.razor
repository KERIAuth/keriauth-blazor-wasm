@page "/Credentials.html"
@layout Layouts.MainLayout
@using Extension.Services.Storage
@using Extension.Services.Port
@using Extension.Models.Messages.AppBw
@inherits AuthenticatedPageBase

@using System.Collections.Immutable

@inject NavigationManager navManager
@inject IJSRuntime js
@inject ILogger<CredentialsPage> logger
@inject AppCache appCache
@inject IAppBwPortService appBwPortService

@code {
    // fields
    List<RecursiveDictionary> credentials = new();

    // properties
    bool IsFiltered { get; set; } = true;
    bool IsCredentialsFetched;
    List<RecursiveDictionary> DisplayedCredentials => IsFiltered ? IssuerCredentials : credentials;

    // reactive properties
    Preferences Prefs => appCache.MyPreferences;
    string SelectedPrefix => appCache.SelectedPrefix ?? "";
    string CountLabel => IssuedAndHeldCredentials.Count.ToString();
    List<RecursiveDictionary> IssueeCredentials => (credentials is null || string.IsNullOrEmpty(SelectedPrefix)) ? new List<RecursiveDictionary>() : WebsiteConfigDisplay.filterCredentials(credentials, [("sad.a.i", SelectedPrefix)]);
    List<RecursiveDictionary> IssuerCredentials => (credentials is null || string.IsNullOrEmpty(SelectedPrefix)) ? new List<RecursiveDictionary>() : WebsiteConfigDisplay.filterCredentials(credentials, [("sad.i", SelectedPrefix)]);
    List<RecursiveDictionary> IssuedAndHeldCredentials => (credentials is null || string.IsNullOrEmpty(SelectedPrefix)) ? new List<RecursiveDictionary>() : WebsiteConfigDisplay.filterCredentials(credentials, [("sad.a.i", SelectedPrefix), ("sad.i", SelectedPrefix)]);

    // TODO P2 what about other presented credentials for verification?

    string Identicon => Helper.Identicon.MakeIdenticon(SelectedPrefix);

    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation($"OnInitializedAsync");

        // Initialize base class for authentication-based render suppression
        InitializeAppCache(appCache);

        // Subscribe to AppCache changes - will trigger StateHasChanged when state updates
        await this.SubscribeToAppCache(appCache);
    }

    protected override async Task OnParametersSetAsync()
    {
        await getCredentials();
        IsCredentialsFetched = true;
        StateHasChanged();
    }

    // Fetch credentials from BackgroundWorker via RPC
    private async Task getCredentials()
    {
        if (!appCache.IsConnectedToKeria)
        {
            logger.LogDebug("Not connected to KERIA, skipping credentials fetch");
            credentials = [];
            return;
        }

        try
        {
            var response = await appBwPortService.SendRpcRequestAsync(
                AppBwMessageType.Values.RequestGetCredentials,
                new { });

            if (!response.Ok)
            {
                logger.LogWarning("Failed to fetch credentials via RPC: {Error}", response.Error);
                credentials = [];
                return;
            }

            // Parse the response payload (use PortMessaging for RecursiveDictionary support)
            var credentialsResult = response.Result is System.Text.Json.JsonElement jsonEl
                ? System.Text.Json.JsonSerializer.Deserialize<GetCredentialsResponsePayload>(jsonEl.GetRawText(), Helper.JsonOptions.PortMessaging)
                : null;

            if (credentialsResult is not null && credentialsResult.Success && credentialsResult.Credentials is not null)
            {
                credentials = credentialsResult.Credentials;
                logger.LogInformation("Fetched {Count} credentials via RPC", credentials.Count);
            }
            else
            {
                logger.LogWarning("Failed to fetch credentials: {Error}", credentialsResult?.Error ?? "Unknown error");
                credentials = [];
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error fetching credentials via RPC");
            credentials = [];
        }
    }

    private void setIsFiltered(bool b)
    {
        IsFiltered = b;
        StateHasChanged();
    }
}


<div id="@this.GetType().Name" class="bt-body-page">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <div style="display:flex;">
                <MudStack Row="true">
                    <MudText Class="bt-page-title">Credentials</MudText>
                    <MudText Class="bt-page-title">
                        (@if (!IsCredentialsFetched)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="bt-inline-progress" />
                        }
                        else
                        {
                            @CountLabel
                        })
                    </MudText>
                    <MudTooltip Delay="0.5"
                                Text="Shows credentials involving the selected Profile">
                        <MudIcon Icon="@Icons.Material.Outlined.Info" Class="bt-info-icon" />
                    </MudTooltip>
                </MudStack>
            </div>



        @if (IsCredentialsFetched)
            {
                @if (credentials.Any())
                {
                    @if (IssueeCredentials.Any())
                    {
                        <MudText Typo="Typo.h6" Class="mb-2">Held as Issuee (@IssueeCredentials.Count)</MudText>
                        <MudExpansionPanels MultiExpansion="true" Class="credential-panels">
                            @foreach (var credential in IssueeCredentials)
                            {
                                <CredentialPanel Credential="@credential" />
                            }
                        </MudExpansionPanels>
                    }

                    @if (IssuerCredentials.Any())
                    {
                        <MudText Typo="Typo.h6" Class="mb-2 mt-4">Issued as Issuer (@IssuerCredentials.Count)</MudText>
                        <MudExpansionPanels MultiExpansion="true" Class="credential-panels">
                            @foreach (var credential in IssuerCredentials)
                            {
                                <CredentialPanel Credential="@credential" />
                            }
                        </MudExpansionPanels>
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No credentials found.</MudAlert>
                }
            }
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer></MudSpacer>
    </MudStack>
</div>
<style>
    .bt-inline-progress {
        width: 1em !important;
        height: 1em !important;
        vertical-align: middle;
    }
</style>
