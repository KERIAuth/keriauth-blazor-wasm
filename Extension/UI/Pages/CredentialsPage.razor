@page "/Credentials.html"
@layout Layouts.MainLayout
@using Extension.Models
@using Extension.Services.Storage
@inherits AuthenticatedPageBase
@implements IDisposable

@using System.Collections.Immutable

@inject NavigationManager navManager
@inject IStorageService storageService
@inject IJSRuntime js
@inject ILogger<CredentialsPage> logger
@inject AppCache appCache

@code {
    // fields
    List<RecursiveDictionary> credentials = new();
    bool IsCredentialsFetched;
    string selectedViewDefId = ViewDefIds.CredHeldOrIssued;

    // reactive properties
    string SelectedPrefix => appCache.SelectedPrefix ?? "";

    // TODO P2 what about other presented credentials for verification?

    string Identicon => Helper.Identicon.MakeIdenticon(SelectedPrefix);

    // Filter predicates for ViewDefs
    bool IsHeldByPrefix(RecursiveDictionary c) =>
        !string.IsNullOrEmpty(SelectedPrefix) && c.GetValueByPath("sad.a.i")?.Value as string == SelectedPrefix;

    bool IsIssuedByPrefix(RecursiveDictionary c) =>
        !string.IsNullOrEmpty(SelectedPrefix) && c.GetValueByPath("sad.i")?.Value as string == SelectedPrefix;

    // ViewDef
    List<FilterSet<RecursiveDictionary>> ProfileSubtotalFilterSets =>
    [
        new("Held", [IsHeldByPrefix]),
        new("Issued", [IsIssuedByPrefix])
    ];

    List<ViewDef<RecursiveDictionary>> CredentialViewDefs =>
    [
        new(ViewDefIds.CredHeld, "Held (active profile)",
            FilterSets: [new("Held", [IsHeldByPrefix])],
            SubtotalFilterSets: ProfileSubtotalFilterSets,
            CountStyle: CountStyle.OfSubTotal),
        new(ViewDefIds.CredIssued, "Issued (active profile)",
            FilterSets: [new("Issued", [IsIssuedByPrefix])],
            SubtotalFilterSets: ProfileSubtotalFilterSets,
            CountStyle: CountStyle.OfSubTotal),
        new(ViewDefIds.CredHeldOrIssued, "Held or issued (active profile)",
            FilterSets: [
                new("Held", [IsHeldByPrefix]),
                new("Issued", [IsIssuedByPrefix])
            ],
            CountStyle: CountStyle.ForProfile),
        new(ViewDefIds.CredAll, "All profiles",
            CountStyle: CountStyle.Total)
    ];

    ViewDef<RecursiveDictionary>? SelectedViewDef => CredentialViewDefs.FirstOrDefault(v => v.Id == selectedViewDefId);
    List<RecursiveDictionary> FilteredCredentials => ViewDefHelper.Apply(credentials, SelectedViewDef);

    int? SubtotalCount => SelectedViewDef?.SubtotalFilterSets is { Count: > 0 }
        ? ViewDefHelper.ApplySubtotalCount(credentials, SelectedViewDef)
        : (int?)null;

    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation($"OnInitializedAsync");

        // Initialize base class for authentication-based render suppression
        InitializeAppCache(appCache);

        // Subscribe to AppCache changes - will trigger StateHasChanged when state updates
        // Re-read credentials from session storage when AppCache notifies of changes
        await this.SubscribeToAppCache(appCache, onChanged: async () => await getCredentials());

        // Restore persisted ViewDef selection
        var pageKey = GetType().Name;
        if (appCache.MyPreferences.SelectedViewDefIds.TryGetValue(pageKey, out var savedId)
            && CredentialViewDefs.Any(v => v.Id == savedId))
        {
            selectedViewDefId = savedId;
        }
    }

    async Task OnViewDefChanged(string newId)
    {
        selectedViewDefId = newId;
        var updatedIds = new Dictionary<string, string>(appCache.MyPreferences.SelectedViewDefIds)
        {
            [GetType().Name] = newId
        };
        await storageService.SetItem(appCache.MyPreferences with { SelectedViewDefIds = updatedIds });
    }

    protected override async Task OnParametersSetAsync()
    {
        await getCredentials();
        IsCredentialsFetched = true;
    }

    private async Task getCredentials()
    {
        try
        {
            var cached = await storageService.GetItem<CachedCredentials>(StorageArea.Session);
            if (cached.IsSuccess && cached.Value?.RawJson is not null)
            {
                credentials = Helper.CredentialHelper.DeserializeCredentialsRawJson(cached.Value.RawJson);
                logger.LogInformation("Loaded {Count} credentials from session storage", credentials.Count);
            }
            else
            {
                credentials = [];
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error reading credentials from session storage");
            credentials = [];
        }
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
    }
}


<div id="@this.GetType().Name" class="bt-body-page">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="Credentials" InfoTooltip="Shows credentials involving the selected Profile" />
            <ViewSelector T="RecursiveDictionary"
                          ViewDefs="@CredentialViewDefs"
                          SelectedViewDefId="@selectedViewDefId"
                          SelectedViewDefIdChanged="@OnViewDefChanged"
                          FilteredCount="@(IsCredentialsFetched ? FilteredCredentials.Count : (int?)null)"
                          SubtotalCount="@(IsCredentialsFetched ? SubtotalCount : null)"
                          TotalCount="@(IsCredentialsFetched ? credentials.Count : (int?)null)" />

            @if (IsCredentialsFetched)
            {
                @if (FilteredCredentials.Any())
                {
                    <MudExpansionPanels MultiExpansion="true" Class="credential-panels">
                        @foreach (var credential in FilteredCredentials)
                        {
                            <CredentialPanel Credential="@credential" />
                        }
                    </MudExpansionPanels>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No credentials found.</MudAlert>
                }
            }
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer></MudSpacer>
    </MudStack>
</div>
