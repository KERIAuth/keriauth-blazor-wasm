@page "/Dashboard.html"
@using Extension.Services.Storage
@using Extension.Services.Port
@using Extension.Models.Messages.AppBw
@inherits AuthenticatedPageBase
@inject NavigationManager navManager
@inject IStorageService storageService
@inject IJSRuntime js
@inject ILogger<DashboardPage> logger
@inject IWebsiteConfigService websiteConfigService
@inject AppCache appCache  // Reactive: subscribes in OnInitializedAsync via SubscribeToAppCache()
@inject IAppPortService appPortService

@implements IDisposable

@using Extension.Services.SignifyService.Models

@code {
    // fields
    bool _credentialsLoading = true;

    // properties


    int NumWebsites { get; set; } = 0;
    List<RecursiveDictionary> Credentials = [];

    // reactive properties
    int? IdentifiersCount => appCache?.MyKeriaConnectionInfo?.IdentifiersList?.Count > 0 ? appCache.MyKeriaConnectionInfo.IdentifiersList[0].Aids.Count : 0;
    // TODO P2 FilteredCredentials should also include what a verifier might see.  What's the filter expression for that?
    // TODO P2 confirm what we want to show
    string KeriaConnectStatusText => appCache.IsConnectedToKeria ? "Connected to" : appCache.IsAuthenticated ? "Not Connected with" : "Locked. Configured to";
    Color KeriaConnectStatusColor => appCache.IsConnectedToKeria ? Color.Success : appCache.IsAuthenticated ? Color.Warning : Color.Error;
    List<RecursiveDictionary> FilteredCredentials => WebsiteConfigDisplay.filterCredentials(Credentials, [("sad.a.i", SelectedPrefix), ("sad.i", SelectedPrefix)]);
    int NumCredentialsThisIdentifier => FilteredCredentials.Count();
    string SelectedPrefix => appCache.SelectedPrefix ?? "";

    // Pluralized labels (count is shown separately, so just singular/plural here)
    string ProfilesLabel => IdentifiersCount == 1 ? "Profile" : "Profiles";
    string WebsitesLabel => NumWebsites == 1 ? "Website" : "Websites";
    string CredentialsLabel => NumCredentialsThisIdentifier == 1 ? "Credential" : "Credentials";
    string SelectedIdenticon => Helper.Identicon.MakeIdenticon(SelectedPrefix);
    string? SelectedAlias => SelectedAid?.Name ?? "";

    Aid? SelectedAid => appCache?.MyKeriaConnectionInfo?.IdentifiersList?
        .SelectMany(id => id.Aids)
        .FirstOrDefault(aid => aid.Prefix == SelectedPrefix);

    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation($"OnInitializedAsync");

        // Initialize base class for authentication-based render suppression
        InitializeAppCache(appCache);

        // Subscribe to AppCache changes - will trigger StateHasChanged when state updates
        // TODO P2: Remove redundant StateHasChanged callback - SubscribeToAppCache already calls StateHasChanged automatically
        await this.SubscribeToAppCache(appCache, async () => await InvokeAsync(StateHasChanged));
    }

    protected override async Task OnParametersSetAsync()
    {
        logger.LogInformation("OnParemetersSetAsync");
        var x = await websiteConfigService.GetList();
        if (x.IsSuccess && x.Value is not null)
        {
            NumWebsites = x.Value.WebsiteList.Count();
        }
        else
        {
            NumWebsites = 0;
        }

        // Fetch credentials from BackgroundWorker via RPC
        // TODO P2 See filterCredentials in WebsiteConfigDisplay, and move that into a helper
        await FetchCredentialsAsync();
    }

    private async Task FetchCredentialsAsync()
    {
        _credentialsLoading = true;

        if (!appCache.IsConnectedToKeria)
        {
            logger.LogDebug("Not connected to KERIA, skipping credentials fetch");
            Credentials = [];
            _credentialsLoading = false;
            return;
        }

        try
        {
            var response = await appPortService.SendRpcRequestAsync(
                AppBwMessageType.Values.RequestGetCredentials,
                new { });

            if (!response.Ok)
            {
                logger.LogWarning("Failed to fetch credentials via RPC: {Error}", response.Error);
                Credentials = [];
                return;
            }

            // Parse the response payload (use PortMessaging for RecursiveDictionary support)
            var credentialsResult = response.Result is System.Text.Json.JsonElement jsonEl
                ? System.Text.Json.JsonSerializer.Deserialize<GetCredentialsResponsePayload>(jsonEl.GetRawText(), Helper.JsonOptions.PortMessaging)
                : null;

            if (credentialsResult is not null && credentialsResult.Success && credentialsResult.Credentials is not null)
            {
                Credentials = credentialsResult.Credentials;
                logger.LogInformation("Fetched {Count} credentials via RPC", Credentials.Count);
            }
            else
            {
                logger.LogWarning("Failed to fetch credentials: {Error}", credentialsResult?.Error ?? "Unknown error");
                Credentials = [];
            }
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error fetching credentials via RPC");
            Credentials = [];
        }
        finally
        {
            _credentialsLoading = false;
        }
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main">
        <div class="bt-main-inside-scroll" style="align-items:center; justify-content: center; display:flex; flex-direction:column;">
            <MudText Class="bt-page-title">Dashboard</MudText>
            <MudStack AlignItems="AlignItems.Center" Class="mudstack-full-width">
                <!-- Independent of selected profile -->
                <MudStack Class="bt-home-background-box" Style="background: var(--mud-palette-background-gray); width: -webkit-fill-available; padding:0.714rem;">
                    <!-- Connected to KERIA -->
                    <MudStack Row>
                        <div Class="mudtext-half-width-left">
                            <MudText Typo="Typo.body1">@KeriaConnectStatusText</MudText>
                        </div>
                        <MudText Class="mudtext-half-width-right">
                            <MudTooltip Text="@appCache.SessionKeriaAlias">
                                <MudLink OnClick="() => navManager.NavigateTo(Routes.PathFor<KeriaConfigsPage>())">KERIA Cloud Service</MudLink>
                            </MudTooltip>
                        </MudText>
                    </MudStack>
                    <!-- Profiles -->
                    <MudStack Row>
                        <MudText Class="mudtext-half-width-left bt-home-status-number">@IdentifiersCount</MudText>
                        <MudText Class="mudtext-half-width-right">
                            <MudLink OnClick="() => navManager.NavigateTo(Routes.PathFor<ProfilesPage>())">@ProfilesLabel</MudLink>
                        </MudText>
                    </MudStack>
                    <!-- Websites -->
                    <MudStack Row>
                        <MudText Class="mudtext-half-width-left bt-home-status-number">@NumWebsites</MudText>
                        <MudText Class="mudtext-half-width-right">
                            <MudLink OnClick="() => navManager.NavigateTo(Routes.PathFor<WebsitesPage>())">@WebsitesLabel</MudLink>
                        </MudText>
                    </MudStack>
                </MudStack>
                <!-- Depending on selected Profile -->
                <MudStack Class="bt-home-background-box" Style="background: var(--mud-palette-action-default-hover); width: -webkit-fill-available; padding:0.714rem;">
                    <!-- Selected Profile -->
                    <MudStack Row>
                        <MudText Class="mudtext-half-width-left bt-home-status-number">@SelectedAlias</MudText>
                        <MudText Class="mudtext-half-width-right">
                            <MudLink OnClick="() => navManager.NavigateTo(Routes.PathFor<ProfilePage>() + SelectedPrefix)">Selected Profile</MudLink>
                        </MudText>
                    </MudStack>
                    <!-- Credentials -->
                    <MudStack Row>
                        <MudText Class="mudtext-half-width-left bt-home-status-number">
                            @if (_credentialsLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="bt-inline-progress" />
                            }
                            else
                            {
                                @NumCredentialsThisIdentifier
                            }
                        </MudText>
                        <MudText Class="mudtext-half-width-right">
                            <MudLink OnClick="() => navManager.NavigateTo(Routes.PathFor<CredentialsPage>())">@CredentialsLabel</MudLink>
                        </MudText>
                    </MudStack>
                </MudStack>
            </MudStack>
        </div>
    </div>
</div>
<style>
    .mudstack-full-width {
        width: 100%;
    }

    .mudtext-half-width-left {
        width: 50%;
        text-align: right
    }

    .mudtext-half-width-right {
        width: 50%;
        text-align: left
    }

    .bt-home-status-number {
        padding-left: 0.929rem;
    }

    .bt-home-status-icon {
        margin-left: 0.357rem;
        margin-right: 1.286rem;
        padding-left: 0;
    }

    .bt-home-background-box {
        border-radius: 0.857rem;
    }

    .bt-inline-progress {
        width: 1em !important;
        height: 1em !important;
        vertical-align: middle;
    }
</style>
