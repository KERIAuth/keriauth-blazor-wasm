@page "/KeriaConfigs.html"
@layout Layouts.MainLayout
@using Extension.Models
@using Extension.Services
@using Extension.Services.Storage
@using Extension.Utilities
@using static Extension.Helper.PreviousPage

@inject NavigationManager navManager
@inject IJSRuntime js
@inject AppCache appCache
@inject IStorageService storageService
@inject IWebauthnService webauthnService
@inject ILogger<KeriaConfigsPage> logger

@implements IDisposable

@code {
    private StoredPasskeys _storedPasskeys = new();

    // Computed properties (reactive via appCache subscription)
    List<KeyValuePair<string, KeriaConnectConfig>> AllConfigs =>
        [.. appCache.MyKeriaConnectConfigs.Configs];

    string? SelectedDigest => appCache.MyPreferences.KeriaPreference.SelectedKeriaConnectionDigest;

    // ViewDef
    List<ViewDef<KeyValuePair<string, KeriaConnectConfig>>> ViewDefs =>
    [
        new("keria-all", "All configs",
            SortSets: [new("Alias", [new SortExpression<KeyValuePair<string, KeriaConnectConfig>>(kvp => kvp.Value.Alias ?? "")])])
    ];
    string selectedViewDefId = "keria-all";
    ViewDef<KeyValuePair<string, KeriaConnectConfig>>? SelectedViewDef => ViewDefs.FirstOrDefault(v => v.Id == selectedViewDefId);
    List<KeyValuePair<string, KeriaConnectConfig>> ConfigsList => ViewDefHelper.Apply(AllConfigs, SelectedViewDef);

    bool IsMultiKeriaConfigEnabled => appCache.MyPreferences.IsMultiKeriaConfigEnabled;

    // Get passkey count for a specific config digest
    int GetPasskeyCount(string digest) =>
        _storedPasskeys.Passkeys.Count(p => p.KeriaConnectionDigest == digest);

    string GetPasskeyCountLabel(string digest) {
        var count = GetPasskeyCount(digest);
        return count switch {
            0 => "",
            1 => "1 passkey",
            _ => $"{count} passkeys"
        };
    }

    // Left-edge highlight style for active config
    static string CardBorderStyle(string? selectedDigest, string configDigest) =>
        selectedDigest == configDigest
            ? "border-left: 4px solid var(--mud-palette-primary);"
            : "border-left: 4px solid transparent;";

    protected override async Task OnInitializedAsync() {
        // Subscribe to AppCache changes - will trigger StateHasChanged when state updates
        await this.SubscribeToAppCache(appCache);

        // Load passkeys to show count per config
        var passkeysResult = await webauthnService.GetStoredPasskeysAsync();
        if (passkeysResult.IsSuccess) {
            _storedPasskeys = passkeysResult.Value;
        }

        logger.LogInformation("KeriaConfigsPage OnInitializedAsync");
    }

    private void NavigateToConfigDetail(string digest) {
        navManager.NavigateTo($"/KeriaConfig.html/{digest}");
    }

    private void NavigateToAddConfig() {
        // For now, navigate to ConfigurePage
        // Phase 4 will implement proper add flow
        navManager.NavigateTo(Routes.PathFor<ConfigurePage>());
    }

    public void Dispose() {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="KERIA Cloud Service Connections" InfoTooltip="Manage connections to KERIA Cloud Services" />
            <ViewSelector T="KeyValuePair<string, KeriaConnectConfig>"
                          ViewDefs="@ViewDefs"
                          SelectedViewDefId="@selectedViewDefId"
                          FilteredCount="@ConfigsList.Count"
                          TotalCount="@AllConfigs.Count" />

            @if (ConfigsList.Count == 0)
            {
                <MudStack Class="pt-4" Spacing="3">
                    <MudText Typo="Typo.body1">
                        No KERIA connections configured.
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Add a connection to get started, or reset all data to start fresh.
                    </MudText>
                </MudStack>
            }
            else
            {
                @foreach (var kvp in ConfigsList)
                {
                    var digest = kvp.Key;
                    var config = kvp.Value;
                    var isSelected = SelectedDigest == digest;
                    var passkeyLabel = GetPasskeyCountLabel(digest);

                    <MudCard Elevation="0" Class="py-0 my-1 cursor-pointer" @onclick="() => NavigateToConfigDetail(digest)">
                        <div class="d-flex align-center" style="@CardBorderStyle(SelectedDigest, digest)">
                            <MudIcon Icon="@Icons.Material.Filled.Cloud"
                                     Color="@(isSelected ? Color.Primary : Color.Default)"
                                     Class="mx-3" />
                            <MudStack Class="py-2 flex-grow-1" Spacing="0">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.h6">@(config.Alias ?? "(unnamed)")</MudText>
                                    @if (isSelected)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">Active</MudChip>
                                    }
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@config.AdminUrl</MudText>
                                @if (!string.IsNullOrEmpty(passkeyLabel))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Tertiary">@passkeyLabel</MudText>
                                }
                            </MudStack>
                            <MudIcon Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Secondary" Class="mx-2" />
                        </div>
                    </MudCard>
                }
            }
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text"
                       OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer />
        @if (IsMultiKeriaConfigEnabled)
        {
            <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="NavigateToAddConfig">
                Add Config
            </MudButton>
        }
    </MudStack>
</div>

<style>
    .cursor-pointer {
        cursor: pointer;
    }
    .cursor-pointer:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
</style>
