@page "/Profiles.html"
@using Extension.Models
@using Extension.Services.Storage
@inherits AuthenticatedPageBase
@implements IDisposable

@inject IStorageService storageService
@inject NavigationManager navManager
@inject IJSRuntime js
@inject ILogger<ProfilesPage> logger
@inject IDialogService dialogService
@inject ISnackbar snackbar
@inject AppCache appCache
@inject IAppPortService appPortService

@using Extension.Services.Port
@using Extension.Services.SignifyService.Models
@using Extension.Models.Messages.AppBw
@using Extension.Models.Messages.AppBw.Requests
@using Extension.Models.Messages.AppBw.Responses

@code {
    // fields
    string DialogResult { get; set; } = "unknown";

    // properties
    bool IsAddingAid { get; set; }
   
    // computed properties
     List<Aid> MyIdentifiers => appCache?.MyKeriaConnectionInfo?.IdentifiersList is { Count: > 0 } list && list[0].Aids is not null
        ? list[0].Aids.OrderBy(a => a.Name).ToList()
        : [];
    string CountLabel => "(" + MyIdentifiers.Count + ")";
    public static string CardClass(string activeAid2, string rowIdentifier) => (string)activeAid2 == rowIdentifier ? "4px solid var(--mud-palette-primary);" : "4px solid transparent;";

    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation($"OnInitializedAsync");

        // Initialize base class for authentication-based render suppression
        InitializeAppCache(appCache);

        await this.SubscribeToAppCache(appCache, async () =>
        {
            await InvokeAsync(StateHasChanged);
        });
    }

    protected override void OnParametersSet()
    {
        logger.LogInformation($"OnParametersSet");
    }

    private async Task AddIdentifier()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true,
                BackdropClick = false,
                CloseButton = true,
                Position = DialogPosition.Center,
            };
        var dialog = await dialogService.ShowAsync<AddProfileDialog>("Add Profile", parameters, options);
        var result = await dialog.Result;
        if (result is null || result.Canceled)
        {
            DialogResult = "Dialog was canceled";
        }
        else
        {
            var alias = result.Data?.ToString() ?? String.Empty;
            if (string.IsNullOrWhiteSpace(alias))
            {
                logger.LogWarning("AddIdentifier: alias is empty");
                snackbar.Add("Profile alias cannot be empty", Severity.Warning);
                return;
            }

            DialogResult = $"Dialog result: {alias}";
            logger.LogInformation("AddIdentifier: Sending request to BackgroundWorker with alias '{Alias}'", alias);
            IsAddingAid = true;
            StateHasChanged();

            try
            {
                // Send request to BackgroundWorker and await response
                var message = new AppBwRequestAddIdentifierMessage(alias);
                var addResult = await appPortService.SendRequestAsync<RequestAddIdentifierPayload, AddIdentifierResponse>(message);

                if (addResult.IsFailed)
                {
                    // Communication/timeout error
                    logger.LogWarning("AddIdentifier: Request failed - {Error}", addResult.Errors.FirstOrDefault()?.Message);
                    snackbar.Add(addResult.Errors.FirstOrDefault()?.Message ?? "Request failed", Severity.Error);
                }
                else if (addResult.Value is null)
                {
                    logger.LogWarning("AddIdentifier: No response received from BackgroundWorker");
                    snackbar.Add("No response from background worker", Severity.Error);
                }
                else if (!addResult.Value.Success)
                {
                    // BackgroundWorker returned an error in the response
                    logger.LogWarning("AddIdentifier: Failed - {Error}", addResult.Value.Error);
                    snackbar.Add(addResult.Value.Error ?? "Failed to add profile", Severity.Error);
                }
                else
                {
                    logger.LogInformation("AddIdentifier: Success");
                    snackbar.Add($"Profile '{alias}' created successfully", Severity.Success);
                }
            }
            finally
            {
                IsAddingAid = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    async Task SetActiveAid(string prefix)
    {
        var prefs = appCache.MyPreferences;
        var updatedPrefs = prefs with {
            KeriaPreference = prefs.KeriaPreference with { SelectedPrefix = prefix }
        };
        await storageService.SetItem<Preferences>(updatedPrefs);
    }

    public void Dispose()
    {
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <MudStack Row="true">
                <MudText Class="bt-page-title">Profiles</MudText>
                <MudText Class="bt-page-title">@CountLabel</MudText>
                <MudTooltip Delay="0.5"
                            Text="">
                    <MudIcon Icon="@Icons.Material.Outlined.Info" Class="bt-info-icon" />
                </MudTooltip>

            </MudStack>

            @foreach (Aid aid in MyIdentifiers)
            {
                <MudLink OnClick="() => navManager.NavigateTo(Routes.PathFor<ProfilePage>() + aid.Prefix)">
                    <MudCard Elevation="0" Class="py-0 my-1">
                        <div class="d-flex" style=@("align-items:center; border-left: " + CardClass(appCache.MyPreferences.SelectedPrefix, aid.Prefix))>
                            <MudTooltip Text="Set Profile as active" Delay="1000">
                                <MudButton OnClick="async () => await SetActiveAid(aid.Prefix)">
                                    <MudIcon ViewBox="0 0 100 100" Icon="@Helper.Identicon.MakeIdenticon(aid.Prefix)" Class="bt-identicon" />
                                </MudButton>
                            </MudTooltip>
                            <MudText Typo="Typo.h6">@aid.Name</MudText>
                        </div>
                    </MudCard>
                </MudLink>
            }
            @if (IsAddingAid)
            {
                // non-reachable code path for now - kept for reference.  IsAddingAid is set to true when adding an identifier, but...
                <div style="display:flex; align-items: center; justify-content:center; position:absolute; z-index:999; top:50%; left:50%; transform: translate(-50%, -50%); width:300px; height:200px;  ">
                    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
                </div>
            }
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@( async () => await GoBack(js) )' Class="justify-start" />
        <MudSpacer />
        <MudButton StartIcon="@Icons.Material.Filled.Add" Disabled="@IsAddingAid" OnClick="async () => await AddIdentifier()" Variant="Variant.Filled" Color="Color.Primary">Add Profile</MudButton>
    </MudStack>
</div>
