@page "/Connecting.html"
@using Extension.Services.Storage
@using Extension.Services.Port
@using Extension.Models.Messages.AppBw

@using Extension.Utilities
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@using static System.Net.WebRequestMethods

@inject IStorageService storageService
@inject ILogger<ConnectingPage> logger
@inject HttpClient http
@inject NavigationManager navManager
@inject IJSRuntime js
@inject IAppPortService appPortService
@inject AppCache appCache

<div id="@this.GetType().Name" class="bt-body-page">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <MudStack Row="true">
                <MudText Class="bt-page-title">@(_connectionFailed ? "Connection Failed" : "Connecting to KERIA Cloud Service...")</MudText>
            </MudStack>
            @if (_connectionFailed)
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
            }
            else
            {
                <div style="height: 70vh; background-color:transparent; align-items:center; justify-content: center; display:flex;">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                </div>
            }
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudSpacer></MudSpacer>
        @if (_connectionFailed)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@RetryConnection" Class="justify-end" data-testid="retry">Retry</MudButton>
        }
    </MudStack>
</div>

@code {
    private bool _connectionFailed;
    private string _errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation("OnInitializedAsync");
        await AttemptConnection();
    }

    private async Task AttemptConnection()
    {
        _connectionFailed = false;
        _errorMessage = string.Empty;
        StateHasChanged();

        var res = await ConnectAndFetchIdentifiers();
        if (res.IsSuccess)
        {
            await appCache.WaitForAppCache([() => appCache.MyKeriaConnectionInfo.IdentifiersList is not null && appCache.MyKeriaConnectionInfo.IdentifiersList.Count > 0]);
            // TODO P2 following check seems unecessary
            // Only navigate if we're still on ConnectingPage (another handler may have navigated away, e.g., to handle a pending request)
            if (navManager.Uri.Contains("Connecting"))
            {
                navManager.NavigateTo(Routes.PathFor<Index>());
            }
        }
        else
        {
            _connectionFailed = true;
            _errorMessage = res.Errors.FirstOrDefault()?.Message ?? "An unknown error occurred";
            StateHasChanged();
        }
    }

    private async Task RetryConnection()
    {
        await AttemptConnection();
    }

    private async Task<Result> ConnectAndFetchIdentifiers()
    {
        // Send connect request to BackgroundWorker via RPC
        var connectResponse = await appPortService.SendRpcRequestAsync(
            AppBwMessageType.Values.RequestConnect,
            new { payload = new ConnectRequestPayload(
                appCache.MyKeriaConnectConfig.AdminUrl!,
                appCache.MyPasscodeModel.Passcode,
                appCache.MyKeriaConnectConfig.BootUrl,
                false,
                appCache.MyKeriaConnectConfig.PasscodeHash) });

        if (!connectResponse.Ok)
        {
            var openWalletError = connectResponse.Error ?? "Could not connect to KERIA Cloud Service";
            logger.LogWarning(openWalletError);
            return Result.Fail(openWalletError);
        }

        // Parse the response payload
        var connectRes = connectResponse.Result is System.Text.Json.JsonElement jsonEl
            ? System.Text.Json.JsonSerializer.Deserialize<ConnectResponsePayload>(jsonEl.GetRawText(), Extension.Helper.JsonOptions.CamelCase)
            : null;

        if (connectRes is null || !connectRes.Success)
        {
            var openWalletError = connectRes?.Error ?? "Could not connect to KERIA Cloud Service";
            logger.LogWarning(openWalletError);
            return Result.Fail(openWalletError);
        }

        // Confirm Client and Agent AIDs are as expected from initial connection response
        if (connectRes.ClientAidPrefix != appCache.MyKeriaConnectConfig.ClientAidPrefix)
        {
            var msg = "Connected KERIA Client AID does not match expected value";
            logger.LogError(msg);
            return Result.Fail(msg);
        }
        if (connectRes.AgentAidPrefix != appCache.MyKeriaConnectConfig.AgentAidPrefix)
        {
            var msg = "Connected KERIA AID does not match expected value";
            logger.LogError(msg);
            return Result.Fail(msg);
        }

        // BackgroundWorker's Connect handler fetches identifiers and stores them in session storage.
        // Wait for the storage update to be reflected in appCache.
        var waitSuccess = await appCache.WaitForAppCache([
            () => appCache.MyKeriaConnectionInfo.IdentifiersList is not null &&
                  appCache.MyKeriaConnectionInfo.IdentifiersList.Count > 0
        ], 30000, 100);

        if (!waitSuccess)
        {
            return Result.Fail("Timed out waiting for identifiers from BackgroundWorker");
        }

        // BackgroundWorker has already set KeriaConnectionInfo with digest and identifiers
        // Just verify the digest is present before proceeding
        await appCache.WaitForAppCache([() => !string.IsNullOrEmpty(appCache.MyKeriaConnectionInfo.KeriaConnectionDigest)]);

        logger.LogInformation("Connected to KERIA");
        return Result.Ok();
    }
    }
}
