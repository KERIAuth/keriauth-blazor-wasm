@page "/RequestSignData.html"
@layout Layouts.DialogLayout
@inherits Extension.UI.Components.TabDialogPageBase

@using Extension.Helper
@using Extension.Models.Messages.AppBw
@using Extension.Models.Messages.BwApp
@using Extension.Models.Messages.BwApp.Requests
@using Extension.Services
@using FluentResults
@using MudBlazor

@inject ILogger<RequestSignDataPage> logger
@inject ISnackbar snackbar

@code {
    // Page-specific fields
    private MudButton? signDataButton;

    // Page-specific properties
    string? SelectedPrefix { get; set; }
    string? SelectedAlias { get; set; }
    RecursiveDictionary? SelectedCredentialOrNothing { get; set; }

    /// <summary>
    /// The message from the requesting page to display to user.
    /// </summary>
    string? RequestMessage { get; set; }

    /// <summary>
    /// The data items to be signed.
    /// </summary>
    string[] DataItems { get; set; } = [];

    string RequestTitleText { get; set; } = "Sign Data";
    string ItemsLabel { get; set; } = "Data items to sign";
    string ButtonText { get; set; } = "Sign Data";

    // Computed properties
    bool IsSignDisabled => SelectedPrefix is null;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        logger.LogInformation("OnInitializedAsync");

        var payload = await InitializeFromPendingRequestAsync<RequestSignDataPayload>(
            BwAppMessageType.Values.RequestSignData);
        if (payload is null)
        {
            return;
        }

        // Extract page-specific values from the payload
        DataItems = payload.Items;

        if (!string.IsNullOrEmpty(payload.Message))
        {
            if (TryParseUiCustomization(payload.Message))
            {
                logger.LogInformation("OnInitializedAsync: using JSON-customized UI");
            }
            else
            {
                RequestMessage = payload.Message;
            }
        }

        logger.LogInformation("OnInitializedAsync: itemCount={ItemCount}", DataItems.Length);

        // Load the active tab for display
        await LoadActiveTabAsync();

        IsInitialized = true;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetSignDataFocus();
        }
    }

    async Task SetSignDataFocus()
    {
        if (signDataButton is not null)
        {
            logger.LogInformation("setting focus on Sign Data button");
            await signDataButton.FocusAsync();
        }
    }

    /// <summary>
    /// Sign the data items with the selected identifier.
    /// </summary>
    async Task<Result> SignData()
    {
        await BeginActionAsync();

        if (TabId <= 0)
        {
            var error = new ValidationError("TabId", "Invalid tab ID");
            snackbar.Add(error.Message, Severity.Error);
            return Result.Fail(error);
        }

        if (SelectedPrefix is null || SelectedAlias is null)
        {
            var error = new ValidationError("Selection", "Identifier selection is incomplete");
            snackbar.Add(error.Message, Severity.Error);
            return Result.Fail(error);
        }

        try
        {
            logger.LogInformation("SignData: Requesting signing of {ItemCount} items with identifier {Prefix}", DataItems.Length, SelectedPrefix);

            // Send approval with identifier and data items to BackgroundWorker
            // BackgroundWorker will perform the actual signing via signify-ts
            var approvalPayload = new SignDataApprovalPayload(
                Prefix: SelectedPrefix,
                DataItems: DataItems
            );
            var message = new AppBwReplySignDataApprovalMessage(TabId, OriginStr, PageRequestId, approvalPayload);
            await AppBwPortService.SendToBackgroundWorkerAsync(message);
            MarkAsReplied();

            // Clear the pending request now that approval is sent
            await ClearPendingRequestAsync();
            await WaitForAppCacheClearAsync();
            await ReturnToPriorUIAsync();
            return Result.Ok();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to send sign-data approval");
            snackbar.Add($"Failed to send sign-data approval: {ex.Message}", Severity.Error);
            return Result.Fail(new JavaScriptInteropError("SignData", ex.Message, ex));
        }
    }

    async Task Cancel()
    {
        await CancelAndReturnAsync("User canceled sign-data request");
    }

    private async Task HandleIdOrCredChanged((string selectedPrefix, string selectedAlias, RecursiveDictionary? selectedCredentialOrNothing, WebsiteConfig? websiteConfig) value)
    {
        logger.LogInformation($"HandleValueChanged prefix {value.selectedPrefix} | selectedCredential {value.selectedCredentialOrNothing is not null}");
        SelectedPrefix = value.selectedPrefix;
        SelectedAlias = value.selectedAlias;
        SelectedCredentialOrNothing = value.selectedCredentialOrNothing;
        StateHasChanged();
        await SetSignDataFocus();
    }

    private async Task SignDataHandler()
    {
        var result = await SignData();
        if (result.IsFailed)
        {
            logger.LogError("Sign-data failed: {error}", result.Errors.FirstOrDefault()?.Message);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Code == "NumpadEnter")
        {
            await SignDataHandler();
        }
    }

    bool TryParseUiCustomization(string message)
    {
        try
        {
            using var doc = JsonDocument.Parse(message);
            if (doc.RootElement.ValueKind != JsonValueKind.Object)
                return false;

            var root = doc.RootElement;
            bool hasRecognizedField = false;

            if (root.TryGetProperty("requestTitleText", out var titleEl) && titleEl.ValueKind == JsonValueKind.String)
            {
                RequestTitleText = titleEl.GetString()!;
                hasRecognizedField = true;
            }
            if (root.TryGetProperty("requestText", out var textEl) && textEl.ValueKind == JsonValueKind.String)
            {
                RequestMessage = textEl.GetString();
                hasRecognizedField = true;
            }
            if (root.TryGetProperty("itemsLabel", out var itemsEl) && itemsEl.ValueKind == JsonValueKind.String)
            {
                ItemsLabel = itemsEl.GetString()!;
                hasRecognizedField = true;
            }
            if (root.TryGetProperty("buttonText", out var buttonEl) && buttonEl.ValueKind == JsonValueKind.String)
            {
                ButtonText = buttonEl.GetString()!;
                hasRecognizedField = true;
            }

            return hasRecognizedField;
        }
        catch (JsonException)
        {
            return false;
        }
    }
}

@if (IsInitialized)
{
    <div id="@this.GetType().Name" class="bt-body-page">
        <MudStack Class="bt-main">
            <div class="bt-main-inside-scroll">
                <PageHeading Title="@($"Request to {RequestTitleText}")" />

                @if (ActiveTab is not null)
                {
                    <TabInteractionDisplay ActiveTab=@ActiveTab />
                }
                else
                {
                    <MudText Typo="Typo.body1" Class="mb-4">Unknown Page (tab not found)</MudText>
                }

                @if (!string.IsNullOrEmpty(RequestMessage))
                {
                    <MudText Class="bt-section-title">Message from page:</MudText>
                    <MudAlert Severity="Severity.Info">
                        <MudText Typo="Typo.body2">@RequestMessage</MudText>
                    </MudAlert>
                }
                <WebsiteConfigDisplay OriginStr="@OriginStr" IsOriginShown="false" IsCredentialShown="false" IsAutoSignShown="false" ValueChanged="async (v) => await HandleIdOrCredChanged(v)" />

                <MudText Class="bt-section-title">@ItemsLabel (@DataItems.Length):</MudText>
                <MudPaper Elevation="1" Class="pa-3 mb-4" Style="max-height: 150px; overflow-y: auto; background-color: var(--mud-palette-background-grey);">
                    @foreach (var item in DataItems)
                    {
                        <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all;">@item</MudText>
                    }
                </MudPaper>

            </div>
        </MudStack>

        <MudStack Row="true" class="bt-button-tray">
            <MudButton StartIcon="@Icons.Material.Filled.Cancel" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@(async (_) => await Cancel())">Cancel</MudButton>
            <MudButton @ref="signDataButton"
                       StartIcon="@Icons.Material.Filled.Draw"
                       Disabled="IsSignDisabled"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="SignDataHandler"
                       @onkeydown="HandleKeyDown">
                @ButtonText
            </MudButton>
        </MudStack>
    </div>
}

