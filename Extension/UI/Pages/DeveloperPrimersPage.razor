@page "/DeveloperPrimers.html"
@using Extension.Models
@using Extension.Services
@using Extension.Services.Port
@using System.Reactive.Linq
@inject NavigationManager navManager
@using static Extension.AppConfig;
@inject IJSRuntime js
@using static Extension.Helper.PreviousPage
@inject ILogger<PreferencesPage> logger
@inject AppCache appCache
@inject IAppBwPortService appBwPortService  // For port connection status
@using System.Linq.Expressions
@inject ISnackbar snackbar

@implements IDisposable

@code
{
    private class BoolItem
    {
        public Expression<Func<bool>> Condition { get; set; } = default!;
        public string? Label { get; set; }
        public int Indent { get; set; }
        public BoolItem(Expression<Func<bool>> condition, string? label = null, int indent = 0)
        {
            Condition = condition;
            Label = label;
            Indent = indent;
        }
    }

    // private const string popupTestUrl = "chrome-extension://dkjahajaknoahpngklccdmbgdnjlempj/index.html?message=%257B%2522type%2522%253A%2522%252Fsignify%252Fauthorize%2522%252C%2522requestId%2522%253A%252247705f1b-d4ba-43b0-ac3b-7637bcd9c572%2522%252C%2522payload%2522%253A%257B%2522message%2522%253A%2522Message%25201765134849911%2522%257D%257D&origin=\"http%3a%2f%2flocalhost%3a5173%2f\"&popupType=SelectAuthorize&tabId=1716420357&environment=ActionPopup";
    private List<BoolItem> Conditions = new();

    // Computed properties for consistency checks
    bool IsSelectedPrefixConsistent => appCache.ValidateSelectedPrefixAmongIdentifiers();

    protected override async Task OnInitializedAsync()
    {
        await this.SubscribeToAppCache(appCache);

        logger.LogInformation("OnInitializedAsync");
        // Hierarchy of state dependencies (indentation shows parent-child relationships)
        // NOTE: This list reflects actual AppCache property definitions
        Conditions = new()
        {
            // Root-level prerequisites
            new BoolItem(() => appCache.IsBwReady, "BW initialized, storage trustworthy", 0),
            new BoolItem(() => appBwPortService.IsConnected, "Appâ†”BW port connected", 0),

            // Main state tree
            new BoolItem(() => appCache.IsReadyToTransact, null, 0),
            new BoolItem(() => appCache.IsNotWaiting, null, 1),
            new BoolItem(() => appCache.IsNotWaitingOnKeria, null, 2),
            new BoolItem(() => appCache.IsNotWaitingOnUser, null, 2),
            new BoolItem(() => appCache.IsNotWaitingOnPendingRequests, null, 2),
            new BoolItem(() => appCache.IsBwNotWaitingOnApp, null, 2),
            new BoolItem(() => appCache.IsAppNotWaitingOnBw, null, 2),
            new BoolItem(() => appCache.IsConnectedToKeria, null, 1),
            new BoolItem(() => appCache.IsIdentifierFetched, null, 2),
            new BoolItem(() => IsSelectedPrefixConsistent, "SelectedPrefix among identifiers (diagnostic)", 3),
            new BoolItem(() => appCache.IsAuthenticated, null, 2),
            new BoolItem(() => appCache.IsSessionUnlocked, null, 3),
            new BoolItem(() => appCache.IsSessionNotExpired, null, 4),
            new BoolItem(() => appCache.IsSessionPasscodeLocallyValid, "passcode matches config hash", 4),
            new BoolItem(() => appCache.IsPasscodeHashSet, null, 5),
            new BoolItem(() => appCache.IsSessionPasscodeSet, null, 5),
            new BoolItem(() => appCache.IsInitialized, null, 3),
            new BoolItem(() => appCache.IsConfigured, null, 4),
            new BoolItem(() => appCache.IsKeriaConfigValidated, null, 5),
            new BoolItem(() => appCache.IsProductOnboarded, null, 5),
            new BoolItem(() => appCache.MyOnboardState.IsWelcomed, null, 6),
            new BoolItem(() => appCache.MyOnboardState.InstallVersionAcknowledged != null, "InstallVersionAcknowledged set", 6),
            new BoolItem(() => appCache.IsCurrentTosAndPrivacyAgreed, null, 6),
                new BoolItem(() => appCache.IsCurrentTosAgreed, "ToS agreed (full check)", 7),
                    new BoolItem(() => appCache.IsTosAgreedUtc, null, 8),
                    new BoolItem(() => appCache.IsTosHashExpected, null, 8),
            new BoolItem(() => appCache.IsCurrentPrivacyAgreed, "Privacy agreed (full check)", 7),
                    new BoolItem(() => appCache.IsPrivacyAgreedUtc, null, 8),
                    new BoolItem(() => appCache.IsPrivacyHashExpected, null, 8),

            new BoolItem(() => appCache.IsInstallAcknowledged, null, 7),
            new BoolItem(() => appCache.IsInstalledVersionAcknowledged, null, 8),
            new BoolItem(() => appCache.MyOnboardState.IsWelcomed, null, 8),
            
            new BoolItem(() => appCache.MyPreferences.IsStored, "Preferences stored", 0),
            
        };
    }

    public void Dispose() {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="Developer Primers" />
        </div>
    </div>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer />
    </MudStack>
</div>
