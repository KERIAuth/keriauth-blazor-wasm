@page "/OfferPasskey.html"
@layout Layouts.MainLayout
@using Extension.Services.Storage
@using static Extension.AppConfig

@inject NavigationManager navManager
@inject ILogger<OfferPasskeyPage> logger
@inject IJSRuntime js

@code {
    private MudButton? createPasskeyButton;
    private bool _shouldFocusButton = true;

    protected override void OnInitialized()
    {
        logger.LogInformation("OfferPasskeyPage OnInitialized");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldFocusButton && createPasskeyButton is not null)
        {
            _shouldFocusButton = false;
            await createPasskeyButton.FocusAsync();
        }
    }

    void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            DeclineOffer();
        }
    }

    void AcceptOffer()
    {
        logger.LogInformation("User accepted passkey offer");
        App.OfferCreatePasskeyState = OfferCreatePasskeyState.Yes;
        navManager.NavigateTo(Routes.PathFor<Index>());
    }

    void DeclineOffer()
    {
        logger.LogInformation("User declined passkey offer");
        App.OfferCreatePasskeyState = OfferCreatePasskeyState.No;
        navManager.NavigateTo(Routes.PathFor<Index>());
    }
}

<div id="@this.GetType().Name" class="bt-body-page" @onkeydown="HandleKeyDown" tabindex="0">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <MudText Class="bt-page-title">Create a Passkey?</MudText>
            <MudStack Class="mt-4">
                <MudText>
                    You may now (or later) create a convenient passkey that lets you unlock KERI Auth instead of typing your passcode.
                </MudText>
                <MudText Class="mt-4">
                    You must still securely store and protect your passcode, as it will be required at some point.
                </MudText>
            </MudStack>
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudSpacer />
        <MudButton Variant="Variant.Text" OnClick="DeclineOffer">Maybe Later</MudButton>
        <MudButton @ref="createPasskeyButton" Variant="Variant.Filled" Color="Color.Primary" OnClick="AcceptOffer">Create Passkey</MudButton>
    </MudStack>
</div>
