@page "/ManagePreferences.html"
@layout Layouts.MainLayout
@using Extension.Models
@using Extension.Models.Messages.AppBw
@using Extension.Services
@using Extension.Utilities
@using System.Reactive.Linq
@using Extension.Services.Storage
@using static Extension.AppConfig;
@using static Extension.Helper.PreviousPage

@inject NavigationManager navManager
@inject IStorageService storageService
@inject IJSRuntime js
@inject AppCache appCache
@inject ILogger<PreferencesPage> logger
@inject IAppBwPortService appBwPortService
@inject ISnackbar snackbar
@inject SessionManager sessionManager

@using Extension.Services.Port

@implements IDisposable

@code
{
    // types
    enum DrawerVariantSupportedInTab
    {
        Persistent = MudBlazor.DrawerVariant.Persistent,
        Temporary = MudBlazor.DrawerVariant.Temporary,
        Responsive = MudBlazor.DrawerVariant.Responsive
        // Mini = MudBlazor.DrawerVariant.Mini, // has layout issues
    }
    enum DrawerVariantSupportedInSidePanel
    {
        Persistent = MudBlazor.DrawerVariant.Persistent,
        Temporary = MudBlazor.DrawerVariant.Temporary,
        Responsive = MudBlazor.DrawerVariant.Responsive
        // Mini = MudBlazor.DrawerVariant.Mini, // has layout issues
    }

    // fields

    // properties

    // reactive properties
    Preferences Prefs => appCache.MyPreferences;
    float InactivityTimeout => Prefs.InactivityTimeoutMinutes;
    string InactivityTimeoutLabel => InactivityTimeout.ToString() + " " + (InactivityTimeout <= 1.0f ? "minute" : "minutes");
    bool IsDarkTheme => Prefs.IsDarkTheme;
    MudBlazor.DrawerVariant DrawerVariantInTab => Prefs.DrawerVariantInTab;
    MudBlazor.DrawerVariant DrawerVariantInSidePanel => Prefs.DrawerVariantInSidePanel;
    bool IsMultiKeriaConfigEnabled => Prefs.IsMultiKeriaConfigEnabled;
    bool IsMultiKeriaOnUnlock => Prefs.IsMultiKeriaOnUnlock;

    // KERIA config selection
    private const string ManageKeriaConfigsValue = "__MANAGE__";
    private string _selectedKeriaConfigDigest = "";
    private List<(string Digest, string Alias)> _availableKeriaConfigItems = new();

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to AppCache changes - will trigger StateHasChanged when state updates
        await this.SubscribeToAppCache(appCache);
        logger.LogInformation("OnInitializedAsync");

        // Initialize KERIA config list - compute digests once at init time to avoid re-computation on each render
        var configs = appCache.GetAvailableKeriaConfigs();
        _availableKeriaConfigItems = configs
            .Select(c => {
                var digestResult = KeriaConnectionDigestHelper.Compute(c);
                return (Digest: digestResult.IsSuccess ? digestResult.Value : "", Alias: c.Alias ?? "(unnamed)");
            })
            .Where(item => !string.IsNullOrEmpty(item.Digest))
            .ToList();
        _selectedKeriaConfigDigest = appCache.MyPreferences.KeriaPreference.SelectedKeriaConnectionDigest ?? "";
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }

    async Task Persist(Preferences prefs)
    {
        await storageService.SetItem<Preferences>(prefs);
        // Note: reactive update of AppCache will trigger this page's StateHasChanged via SubscribeToAppCache()

        // Note: timer updates in MainLayout.razor are reactive via AppCache subscription
        // BackgroundWorker timer reset should also be updated because of reactive to this preferences change, or app activity in general

        // TODO P2 Perf BW can be reactive, too...
        // Notify BW so it can reset its inactivity timer with new value?
        // Or, does BW know to treat any Prefs change as user activity?
        await appBwPortService.SendEventAsync(AppBwMessageType.Values.UserActivity);
    }

    async Task SetAndPersistIsDarkTheme(bool isDarkTheme)
    {
        await Persist(Prefs with { IsDarkTheme = isDarkTheme });
    }

    async Task SetAndPersistDVIT(DrawerVariant dv)
    {
        await Persist(Prefs with { DrawerVariantInTab = dv });
    }

    async Task SetAndPersistDVISP(DrawerVariant dv)
    {
        await Persist(Prefs with { DrawerVariantInSidePanel = dv });
    }

    async Task SetAndPersistInactivityTimeout(float inactivityTimeout)
    {
        await Persist(Prefs with { InactivityTimeoutMinutes = inactivityTimeout });
    }

    async Task SetAndPersistIsMultiKeriaConfigEnabled(bool isEnabled)
    {
        await Persist(Prefs with { IsMultiKeriaConfigEnabled = isEnabled });
    }

    async Task SetAndPersistIsMultiKeriaOnUnlock(bool isEnabled)
    {
        await Persist(Prefs with { IsMultiKeriaOnUnlock = isEnabled });
    }

    private async Task OnKeriaConfigDigestChanged(string digest)
    {
        if (digest == ManageKeriaConfigsValue)
        {
            navManager.NavigateTo(Routes.PathFor<KeriaConfigsPage>());
            return;
        }

        if (_selectedKeriaConfigDigest != digest)
        {
            // Clear ALL session storage to lock the session
            await sessionManager.ClearSessionForConfigChangeAsync();

            _selectedKeriaConfigDigest = digest;

            var newKeriaPreference = Prefs.KeriaPreference with {
                SelectedKeriaConnectionDigest = digest
            };
            await Persist(Prefs with { KeriaPreference = newKeriaPreference });

            // Wait for appCache to reflect the new preference
            await appCache.WaitForAppCache([
                () => appCache.MyPreferences.KeriaPreference.SelectedKeriaConnectionDigest == digest
            ]);

            snackbar.Add("Configuration changed. Session locked.", Severity.Info);
            // Stay on PreferencesPage (no navigation)
        }
    }

    // Reset preferences to default, preserving selected prefix, KERIA preferences, and drawer open states
    private async Task ResetToDefault()
    {
        await Persist(AppConfig.DefaultPreferences with
        {
            KeriaPreference = Prefs.KeriaPreference, // Preserve KERIA selection
            IsPersistentDrawerOpenInSidePanel = Prefs.IsPersistentDrawerOpenInSidePanel,
            IsPersistentDrawerOpenInTab = Prefs.IsPersistentDrawerOpenInTab,
            IsMultiKeriaConfigEnabled = Prefs.IsMultiKeriaConfigEnabled,
            IsMultiKeriaOnUnlock = Prefs.IsMultiKeriaOnUnlock,
            IsStored = true
        });
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="Preferences" />
            <MudStack>
                <MudText Class="bt-pref-group-label0">
                    Theme
                </MudText>
                <MudStack Row="true" Class="ml-5">
                    <MudIcon Icon="@Icons.Material.Filled.WbSunny" Title="Light" Class="mt-2"></MudIcon>
                    <MudSwitch Value="IsDarkTheme" id="asdfasdf" ValueChanged="async (bool isOn) => await SetAndPersistIsDarkTheme(isOn)" T="bool" Color="Color.Primary" Class="mr-n2 mb-0 ml-1" />
                    <MudIcon Icon="@Icons.Material.Filled.Nightlight" Title="Dark" Class="mt-2"></MudIcon>
                </MudStack>
            </MudStack>

            <MudStack Row="false">
                <MudText Class="bt-pref-group-label0">
                    Menu Mode
                </MudText>
                <MudStack Row="false" Class="ml-5" Style="width:14.286rem;">
                    <MudSelect T="DrawerVariant" MultiSelection="false" Value="DrawerVariantInTab" ValueChanged="async (DrawerVariant a) => await SetAndPersistDVIT(a)" Label="In Browser Tab" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        @foreach (DrawerVariant item in Enum.GetValues(typeof(DrawerVariantSupportedInTab)))
                        {
                            <MudSelectItem Value="item">@item</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
                <MudStack Row="false" Class="ml-5" Style="width:14.286rem;">
                    <MudSelect T="DrawerVariant" MultiSelection="false" Value="DrawerVariantInSidePanel" ValueChanged="async (DrawerVariant a) => await SetAndPersistDVISP(a)" Label="In SidePanel" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        @foreach (DrawerVariant item in Enum.GetValues(typeof(DrawerVariantSupportedInSidePanel)))
                        {
                            <MudSelectItem Value="item">@item</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
            </MudStack>

            <MudStack Row="false">
                <MudText Class="bt-pref-group-label0">
                    Inactivity Timeout
                </MudText>
                <MudStack Row="false" Class="ml-5" Style="width:14.286rem;">
                    @*
                        // TODO P3 perf: update so the change is on mouse-up, not on mouse-move or click
                    *@
                    <MudSlider T="float" Value="InactivityTimeout" ValueChanged="async (float v) => await SetAndPersistInactivityTimeout(v)" Min="0.5f" Max="AppConfig.MaxInactivityTimeoutMins" Step="0.5f" />
                    <p>@InactivityTimeoutLabel</p>
                </MudStack>
            </MudStack>

            <MudStack Row="false">
                <MudText Class="bt-pref-group-label0">
                    Optional Features
                </MudText>
                <MudText Class="bt-pref-group-label1">Multiple KERIA Cloud Service Configurations</MudText>
                <MudStack Row="true" Class="ml-5" AlignItems="AlignItems.Center">
                    <MudSwitch Value="IsMultiKeriaConfigEnabled"
                               ValueChanged="async (bool isOn) => await SetAndPersistIsMultiKeriaConfigEnabled(isOn)"
                               T="bool" Color="Color.Primary" />
                    <MudText>Enable</MudText>
                    @if (IsMultiKeriaConfigEnabled)
                    {
                        <MudStack Row="true" Class="ml-5 mt-2" AlignItems="AlignItems.Center">
                        <MudSwitch Value="IsMultiKeriaOnUnlock"
                                   ValueChanged="async (bool isOn) => await SetAndPersistIsMultiKeriaOnUnlock(isOn)"
                                   T="bool" Color="Color.Primary" />
                        <MudText>Show on Unlock page</MudText>
                    </MudStack>
                    @if (_availableKeriaConfigItems.Count > 0)
                    {
                        <MudStack Row="false" Class="ml-5 mt-3" Style="width:18rem;">
                            <MudText>Selected</MudText>
                            <MudSelect Class="ml-5" T="string"
                                       Label="KERIA Cloud Service"
                                       Value="@_selectedKeriaConfigDigest"
                                       ValueChanged="OnKeriaConfigDigestChanged"
                                       Variant="Variant.Outlined">
                                @foreach (var item in _availableKeriaConfigItems)
                                {
                                    <MudSelectItem Value="@item.Digest">@item.Alias</MudSelectItem>
                                }
                                <MudSelectItem Value="@ManageKeriaConfigsValue">Manage...</MudSelectItem>
                            </MudSelect>
                        </MudStack>
                    }
                }
                </MudStack>
            </MudStack>
        </div>
    </div>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer />
        <MudButton OnClick="ResetToDefault" Color="Color.Secondary" Variant="Variant.Filled" Class="ml-8" Style="justify-content:left;">Reset to Default</MudButton>
    </MudStack>
</div>

<style>
    .bt-pref-radiogroup {
        padding-left: 4.286rem;
    }

    .bt-pref-radio {
    }

    .bt-pref-group-label0 {
        font-weight: bold;
        padding-top: 1.143rem;
    }

    .bt-pref-group-label1 {
        padding-left: 0.714rem;
    }

    .bt-pref-group-label2 {
        padding-left: 2.857rem;
    }

    .bt-pref-stack1 {
        width: auto;
        margin-left: 1.429rem;
        gap: 0;
    }
</style>
