@page "/Delete.html"
@using Extension.Models
@using Extension.Services.Storage
@using Extension.Services
@inject IJSRuntime js
@inject NavigationManager navManager
@inject IStorageService storageService
@using static Extension.AppConfig;
@inject IDialogService dialogService
@inject ILogger<DeletePage> logger
@inject IWebExtensionsApi webExtensions
@using static Extension.Helper.PreviousPage

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main">
        <div class="bt-main-inside-scroll">
            <MudText Typo="Typo.h6">Delete Local Configuration</MudText>
            <MudStack class="d-flex mt-2 justify-center">
                <MudText>Are you sure you want to delete your local configuration? </MudText>
                <MudText>
                    If in the future you want to reconnect to your same KERI Agent Service to access your agent, identifiers, credentials, and other data there, make sure you have its URLs and your passcode safely recorded.
                </MudText>
            </MudStack>
        </div>
    </div>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@( async () => await GoBack(js) )' Class="justify-start" />
        <MudSpacer></MudSpacer>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="async () => await DeleteWallet()" Class="justify-end">Delete</MudButton>
    </MudStack>
</div>

@code {
    private async Task DeleteWallet()
    {
        bool isRemoveConfirmed;

        // show a dialog to confirm deletion
        var result = await dialogService.ShowMessageBox(
            "Delete Configuration",
            $"Are you sure you want to delete your local configuration and reload the extension?",
            yesText: "Yes, Delete",
            cancelText: "Cancel",
             options: new DialogOptions()
                 {
                     CloseOnEscapeKey = true,
                 }
         );
        isRemoveConfirmed = result.GetValueOrDefault();
        if (isRemoveConfirmed)
        {
            // Preserve RegisteredAuthenticators before clearing storage
            var authenticatorsResult = await storageService.GetItem<RegisteredAuthenticators>(StorageArea.Local);
            var preservedAuthenticators = authenticatorsResult.IsSuccess ? authenticatorsResult.Value : null;

            await storageService.Clear(StorageArea.Local);
            await storageService.Clear(StorageArea.Sync);
            await storageService.Clear(StorageArea.Session);

            // Restore RegisteredAuthenticators after clearing
            if (preservedAuthenticators is not null)
            {
                await storageService.SetItem(preservedAuthenticators, StorageArea.Local);
            }

            webExtensions.Runtime.Reload();
            // unreachable
        } else
        {
            navManager.NavigateTo(RouteToDashboard);
        }
    }
}
