@page "/RequestCreateCredential.html"
@layout Layouts.DialogLayout

@using Extension.Services.Storage
@using System;
@using System.Collections.Generic;
@using System.Diagnostics
@using System.Linq
@using System.Text.Json
@using System.Text.Json.Serialization
@using System.Web
@using Extension.Helper
@using Extension.Models
@using Extension.Models.Messages.AppBw
@using Extension.Models.Messages.BwApp
@using Extension.Models.Messages.BwApp.Requests
@using Extension.Models.Messages.CsBw
@using Extension.Services
@using Extension.Services.JsBindings
@using Extension.Services.Port
@using Extension.Services.SignifyService
@using Extension.Services.SignifyService.Models
@using FluentResults
@using MudBlazor
@using static Extension.AppConfig
@using WebExtensions.Net.Runtime
@using WebExtensions.Net.Tabs
@using BrowserTab = WebExtensions.Net.Tabs.Tab

@implements IAsyncDisposable

@inject IStorageService storageService
@inject NavigationManager navManager
@inject IJSRuntime js
@using static Extension.Helper.PreviousPage
@inject ILogger<RequestCreateCredentialPage> logger
@inject ISignifyClientService signifyClientService
@inject IDialogService dialogService
@inject ISnackbar snackbar
@inject IWebsiteConfigService websiteConfigService
@inject IStorageService storageService
@inject IAppPortService appPortService
@inject IPendingBwAppRequestService pendingBwAppRequestService
@inject AppCache appCache
@inject IJSRuntime jsRuntime
@inject ISignifyClientBinding signifyClientBinding
@inject IWebExtensionsApi webExtensionsApi

@code {
    [CascadingParameter] public DialogLayout? Layout { get; set; }

    // fields and types
    private MudButton? createButton;

    // properties
    public BrowserTab? ActiveTab { get; set; }
    /// <summary>
    /// The original requestId from the web page that initiated this create-credential request.
    /// This must be returned in replies so the page can correlate the response.
    /// </summary>
    public string PageRequestId { get; set; } = "";
    public int TabId { get; set; } = -1;
    string? SelectedPrefix { get; set; }
    string? SelectedAlias { get; set; }
    RecursiveDictionary? SelectedCredentialOrNothing { get; set; }
    bool IsInitialized { get; set; }
    /// <summary>
    /// Tracks whether a reply (success or cancel) has been sent to the page.
    /// Used to avoid sending duplicate cancel messages on dispose.
    /// </summary>
    bool HasRepliedToPage { get; set; } = false;
    string OriginStr { get; set; } = "unset";

    /// <summary>
    /// The credential data to be attested.
    /// </summary>
    object? CredData { get; set; }

    /// <summary>
    /// The schema SAID for the credential.
    /// </summary>
    string SchemaSaid { get; set; } = "";

    /// <summary>
    /// Processing state when creating credential
    /// </summary>
    bool IsProcessing { get; set; } = false;

    // computed properties
    bool IsCreateDisabled => SelectedPrefix is null || IsProcessing;


    protected override async Task OnInitializedAsync()
    {
        logger.LogInformation("OnInitializedAsync");

        // Get the pending request from storage (set by BackgroundWorker before opening popup)
        var pendingRequest = appCache.NextPendingBwAppRequest;
        if (pendingRequest?.Type != BwAppMessageType.Values.RequestCreateCredential)
        {
            logger.LogError("OnInitializedAsync: No pending RequestCreateCredential request found");
            return;
        }

        OriginStr = pendingRequest.TabUrl ?? "unknown";
        var payload = pendingRequest.GetPayload<RequestCreateCredentialPayload>();
        if (payload is null)
        {
            logger.LogError("OnInitializedAsync: Failed to deserialize pending request payload to RequestCreateCredentialPayload");
            return;
        }

        // Extract values from the pending request payload
        // pageRequestId is the original request ID from the web page - must be returned in replies
        PageRequestId = pendingRequest.RequestId;
        TabId = payload.TabId;
        CredData = payload.CredData;
        SchemaSaid = payload.SchemaSaid;

        logger.LogInformation("OnInitializedAsync: pageRequestId={PageRequestId}, tabId={TabId}, origin={Origin}, schemaSaid={SchemaSaid}",
            PageRequestId, TabId, payload.Origin, SchemaSaid);

        // Get the active tab
        ActiveTab = await webExtensionsApi.Tabs.Get(TabId);

        IsInitialized = true;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetCreateButtonFocus();
        }
    }

    async Task SetCreateButtonFocus()
    {
        if (createButton is not null)
        {
            logger.LogInformation("setting focus on Create Credential button");
            await createButton.FocusAsync();
        }
    }

    /// <summary>
    /// Create the data attestation credential with the selected identifier.
    /// This sends a message to BackgroundWorker which will actually issue the credential via signify-ts.
    /// </summary>
    async Task<Result> CreateCredential(string pageRequestIdParam)
    {
        if (TabId <= 0)
        {
            var error = new ValidationError("TabId", "Invalid tab ID");
            snackbar.Add(error.Message, Severity.Error);
            return Result.Fail(error);
        }

        if (SelectedPrefix is null || SelectedAlias is null)
        {
            var error = new ValidationError("Selection", "Identifier selection is incomplete");
            snackbar.Add(error.Message, Severity.Error);
            return Result.Fail(error);
        }

        try
        {
            IsProcessing = true;
            StateHasChanged();

            logger.LogInformation("CreateCredential: Creating credential with identifier {Prefix} for schema {SchemaSaid}", SelectedPrefix, SchemaSaid);

            // Send approval message to BackgroundWorker with the selected identifier
            // BackgroundWorker will then issue the credential via signify-ts and send the result to ContentScript
            var approvalPayload = new CreateCredentialApprovalPayload(
                AidName: SelectedAlias,
                AidPrefix: SelectedPrefix,
                CredData: CredData!,
                SchemaSaid: SchemaSaid
            );

            var message = new AppBwMessage<CreateCredentialApprovalPayload>(
                AppBwMessageType.ReplyCreateCredential, TabId, OriginStr, PageRequestId, approvalPayload);
            await appPortService.SendToBackgroundWorkerAsync(message);
            HasRepliedToPage = true;

            // Clear the pending request now that creation is approved
            await ClearPendingRequestAsync();
            await Layout!.ReturnToPriorUI();
            return Result.Ok();
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Failed to send create credential approval");
            snackbar.Add($"Failed to create credential: {ex.Message}", Severity.Error);
            return Result.Fail(new Error(ex.Message));
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    async Task Cancel(MouseEventArgs _)
    {
        logger.LogInformation("Cancel: User initiated cancel for pageRequestId={PageRequestId}", PageRequestId);

        var message = new AppBwReplyCanceledMessage(TabId, OriginStr, PageRequestId, "User canceled create-credential");
        try
        {
            await appPortService.SendToBackgroundWorkerAsync(message);
            HasRepliedToPage = true;
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Cancel: Failed to send cancel message to BackgroundWorker");
            // Continue to clear pending request and close popup even if message send failed
        }

        await Layout!.ReturnToPriorUI();
        return;
    }

    public async ValueTask DisposeAsync()
    {
        // If user closes popup without previously clicking Create or Cancel,
        // send a cancel reply to the page so it's not left waiting
        if (!HasRepliedToPage && TabId > 0 && !string.IsNullOrEmpty(PageRequestId))
        {
            logger.LogInformation("DisposeAsync: Sending cancel reply for pageRequestId={PageRequestId} (popup closed without action)", PageRequestId);
            try
            {
                var message = new AppBwReplyCanceledMessage(TabId, OriginStr, PageRequestId, "User closed create-credential dialog");
                await appPortService.SendToBackgroundWorkerAsync(message);
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "DisposeAsync: Failed to send cancel message to BackgroundWorker");
            }
        }

        // Clear pending request if user closes popup without explicit action
        await ClearPendingRequestAsync();
    }

    /// <summary>
    /// Clears the pending request from storage using the pageRequestId captured during initialization.
    /// This ensures we clear the correct request even if multiple requests are queued.
    /// </summary>
    async Task ClearPendingRequestAsync()
    {
        if (string.IsNullOrEmpty(PageRequestId))
        {
            logger.LogWarning("ClearPendingRequestAsync: No pageRequestId available to clear");
            return;
        }

        logger.LogInformation("ClearPendingRequestAsync: Clearing pending request, pageRequestId={PageRequestId}", PageRequestId);
        var result = await pendingBwAppRequestService.RemoveRequestAsync(PageRequestId);
        if (result.IsFailed)
        {
            logger.LogError("ClearPendingRequestAsync: Failed to remove request - {Errors}", string.Join(", ", result.Errors.Select(e => e.Message)));
        }
    }

    private async Task HandleIdOrCredChanged((string selectedPrefix, string selectedAlias, RecursiveDictionary? selectedCredentialOrNothing) value)
    {
        logger.LogInformation($"HandleValueChanged prefix {value.selectedPrefix} | selectedCredential {value.selectedCredentialOrNothing is not null}");
        SelectedPrefix = value.selectedPrefix;
        SelectedAlias = value.selectedAlias;
        SelectedCredentialOrNothing = value.selectedCredentialOrNothing;
        StateHasChanged();
        await SetCreateButtonFocus();
    }

    private async Task CreateCredentialHandler()
    {
        var result = await CreateCredential(PageRequestId);
        if (result.IsFailed)
        {
            logger.LogError("Create-credential failed: {error}", result.Errors.FirstOrDefault()?.Message);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Code == "NumpadEnter")
        {
            await CreateCredentialHandler();
        }
    }

    /// <summary>
    /// Format credential data for display.
    /// </summary>
    private string FormatCredData()
    {
        if (CredData is null) return "No data";
        try
        {
            return JsonSerializer.Serialize(CredData, JsonOptions.DisplayIndented);
        }
        catch
        {
            return CredData.ToString() ?? "Unable to display";
        }
    }
}

@if (IsInitialized)
{
    <div id="@this.GetType().Name" class="bt-body-page">
        <MudStack Class="bt-main">
            <div class="bt-main-inside-scroll">
                <MudText Class="bt-page-title">Request to Create Credential</MudText>

                @if (ActiveTab is not null)
                {
                    <TabInteractionDisplay ActiveTab=@ActiveTab />
                }
                else
                {
                    <MudText Typo="Typo.body1" Class="mb-4">Unknown Page (tab not found)</MudText>
                }

                <MudAlert Severity="Severity.Warning" Class="mt-4 mb-2">
                    <MudText Typo="Typo.body2">This website is requesting to create a data attestation credential using your profile.</MudText>
                </MudAlert>

                <MudText Class="mt-4 mb-2"><b>Schema SAID:</b></MudText>
                <MudPaper Elevation="1" Class="pa-2 mb-4" Style="background-color: var(--mud-palette-background-grey);">
                    <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all;">@SchemaSaid</MudText>
                </MudPaper>

                <MudText Class="mt-4 mb-2"><b>Credential data to attest:</b></MudText>
                <MudPaper Elevation="1" Class="pa-3 mb-4" Style="max-height: 150px; overflow-y: auto; background-color: var(--mud-palette-background-grey);">
                    <pre style="margin: 0; font-size: 0.75rem; white-space: pre-wrap; word-break: break-all;">@FormatCredData()</pre>
                </MudPaper>

                <MudText Class="mt-4 mb-2"><b>Select profile to issue credential:</b></MudText>
                <WebsiteConfigDisplay OriginStr="@OriginStr" IsOriginShown="true" IsCredentialShown="false" IsAutoSignShown="false" ValueChanged="async (v) => await HandleIdOrCredChanged(v)" />
            </div>
        </MudStack>

        <MudStack Row="true" class="bt-button-tray">
            <MudButton StartIcon="@Icons.Material.Filled.Cancel" Variant="Variant.Filled" Color="Color.Tertiary" OnClick=Cancel Disabled="@IsProcessing">Cancel</MudButton>
            <MudButton @ref="createButton"
                       StartIcon="@Icons.Material.Filled.AddCircle"
                       Disabled="IsCreateDisabled"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="CreateCredentialHandler"
                       @onkeydown="HandleKeyDown">
                @if (IsProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Creating...</span>
                }
                else
                {
                    <span>Create Credential</span>
                }
            </MudButton>
        </MudStack>
    </div>
}

<style>
    .mud-select .mud-select-input .mud-input-slot {
        height: auto;
    }

    .selected-item {
        border-left: 4px solid blue;
    }
</style>
