@page "/ManageKeriAgentServices.html"
@layout Layouts.MainLayout
@using Extension.Models
@using Extension.Services
@using Extension.Services.Storage
@using Extension.Utilities
@using static Extension.Helper.PreviousPage

@inject NavigationManager navManager
@inject IJSRuntime js
@inject AppCache appCache
@inject IStorageService storageService
@inject ILogger<ManageKeriAgentServicesPage> logger

@implements IDisposable

@code {
    private bool _isAdding = false;

    // Computed properties (reactive via appCache subscription)
    List<KeyValuePair<string, KeriaConnectConfig>> ConfigsList =>
        appCache.MyKeriaConnectConfigs.Configs
            .OrderBy(kvp => kvp.Value.Alias)
            .ToList();

    string? SelectedDigest => appCache.MyPreferences.KeriaPreference.SelectedKeriaConnectionDigest;

    string CountLabel => $"({ConfigsList.Count})";

    // Left-edge highlight style for active config
    static string CardClass(string? selectedDigest, string configDigest) =>
        selectedDigest == configDigest
            ? "4px solid var(--mud-palette-primary);"
            : "4px solid transparent;";

    protected override async Task OnInitializedAsync() {
        await this.SubscribeToAppCache(appCache, async () =>
        {
            await InvokeAsync(StateHasChanged);
        });
        logger.LogInformation("ManageKeriAgentServicesPage OnInitializedAsync");
    }

    private async Task SetActiveConfig(string digest)
    {
        var prefs = appCache.MyPreferences;
        var updatedPrefs = prefs with {
            KeriaPreference = prefs.KeriaPreference with { SelectedKeriaConnectionDigest = digest }
        };
        await storageService.SetItem<Preferences>(updatedPrefs);
        logger.LogInformation("Set active KERIA config to digest: {Digest}", digest);
    }

    private async Task AddConfigCopy()
    {
        if (_isAdding) return;
        _isAdding = true;

        try
        {
            // Get the first config to copy
            var firstConfig = appCache.MyKeriaConnectConfigs.Configs.Values.FirstOrDefault();
            if (firstConfig is null)
            {
                logger.LogWarning("No existing config to copy");
                return;
            }

            // Create a new config with a different alias and random PasscodeHash
            // The random PasscodeHash ensures a unique digest since digest = SHA256(ClientAidPrefix + AgentAidPrefix + PasscodeHash)
            var newAlias = $"{firstConfig.Alias} (Copy {DateTime.UtcNow:HH:mm:ss})";
            var randomPasscodeHash = Random.Shared.Next();
            var newConfig = firstConfig with {
                Alias = newAlias,
                PasscodeHash = randomPasscodeHash
            };

            // Compute the digest for the new config (will be unique due to different PasscodeHash)
            var digestResult = KeriaConnectionDigestHelper.Compute(newConfig);
            if (digestResult.IsFailed)
            {
                logger.LogError("Failed to compute digest for new config: {Errors}", digestResult.Errors);
                return;
            }

            // Add to the configs dictionary
            var updatedConfigs = new Dictionary<string, KeriaConnectConfig>(appCache.MyKeriaConnectConfigs.Configs)
            {
                [digestResult.Value] = newConfig
            };

            var updatedModel = appCache.MyKeriaConnectConfigs with
            {
                Configs = updatedConfigs,
                IsStored = true
            };

            await storageService.SetItem(updatedModel);
            logger.LogInformation("Added new config copy with alias: {Alias}, digest: {Digest}", newAlias, digestResult.Value);
        }
        finally
        {
            _isAdding = false;
        }
    }

    public void Dispose() {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <MudStack Class="bt-main">
        <div class="bt-main-inside-scroll">
            <MudStack Row="true">
                <MudText Class="bt-page-title">KERIA Connections</MudText>
                <MudText Class="bt-page-title">@CountLabel</MudText>
                <MudTooltip Delay="500" Text="Manage your KERIA Cloud Service connections">
                    <MudIcon Icon="@Icons.Material.Outlined.Info" Class="bt-info-icon" />
                </MudTooltip>
            </MudStack>

            @if (ConfigsList.Count == 0)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pt-4">
                    No KERIA connections configured.
                </MudText>
            }
            else
            {
                @foreach (var kvp in ConfigsList)
                {
                    <MudCard Elevation="0" Class="py-0 my-1">
                        <div class="d-flex" style="@($"align-items:center; border-left: {CardClass(SelectedDigest, kvp.Key)}")">
                            <MudTooltip Text="Set as active connection" Delay="1000">
                                <MudButton OnClick="async () => await SetActiveConfig(kvp.Key)">
                                    <MudIcon Icon="@Icons.Material.Filled.Cloud" Color="@(SelectedDigest == kvp.Key ? Color.Primary : Color.Default)" />
                                </MudButton>
                            </MudTooltip>
                            <MudStack Class="py-2" Spacing="0">
                                <MudText Typo="Typo.h6">@(kvp.Value.Alias ?? "(unnamed)")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@kvp.Value.AdminUrl</MudText>
                            </MudStack>
                        </div>
                    </MudCard>
                }
            }
        </div>
    </MudStack>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text"
                       OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer />
        @if (ConfigsList.Count > 0)
        {
            <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary"
                       Disabled="@_isAdding"
                       OnClick="AddConfigCopy">
                Add Config
            </MudButton>
        }
    </MudStack>
</div>
