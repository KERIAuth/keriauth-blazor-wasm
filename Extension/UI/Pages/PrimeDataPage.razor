@page "/PrimeData.html"
@using System.Text.Json
@using Extension.Helper
@using Extension.Models
@using Extension.Models.Messages.AppBw
@using Extension.Services
@using Extension.Services.Port
@using static Extension.AppConfig;
@using static Extension.Helper.PreviousPage
@inject NavigationManager navManager
@inject IJSRuntime js
@inject ILogger<PrimeDataPage> logger
@inject AppCache appCache
@inject IAppBwPortService appBwPortService

@implements IDisposable

@code
{
    enum StepStatus { Blank, Running, Success, Error }
    StepStatus goStatus;
    string? goError;
    string prepend = "001";

    protected override async Task OnInitializedAsync()
    {
        await this.SubscribeToAppCache(appCache);
        logger.LogInformation("OnInitializedAsync");
    }

    async Task OnGo()
    {
        goStatus = StepStatus.Running;
        goError = null;
        StateHasChanged();

        try
        {
            var response = await appBwPortService.SendRpcRequestAsync(
                AppBwMessageType.Values.RequestPrimeDataGo,
                new { payload = new PrimeDataGoPayload(prepend) },
                TimeSpan.FromMinutes(5));

            if (!response.Ok)
            {
                goStatus = StepStatus.Error;
                goError = response.Error ?? "RPC failed";
            }
            else
            {
                var result = response.Result is JsonElement jsonEl
                    ? JsonSerializer.Deserialize<PrimeDataGoResponse>(jsonEl.GetRawText(), JsonOptions.PortMessaging)
                    : null;

                if (result is not null && result.Success)
                {
                    goStatus = StepStatus.Success;
                }
                else
                {
                    goStatus = StepStatus.Error;
                    goError = result?.Error ?? "Unknown error";
                }
            }
        }
        catch (Exception ex)
        {
            goStatus = StepStatus.Error;
            goError = ex.Message;
        }

        StateHasChanged();
    }

    void OnReset()
    {
        goStatus = StepStatus.Blank;
        goError = null;
        StateHasChanged();
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }
}

<div id="@this.GetType().Name" class="bt-body-page">
    <div class="d-flex gap-3 bt-main">
        <div class="bt-main-inside-scroll">
            <PageHeading Title="Prime Data" />

            <MudText Class="bt-pref-group-label0">
                Input Fields
            </MudText>
            <MudStack Class="ml-5">
                <MudTextField T="string" Label="Prepend" @bind-Value="prepend" Variant="Variant.Outlined" />
            </MudStack>

            <MudText Class="bt-pref-group-label0">
                Execute
            </MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="ml-5">
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           OnClick="OnGo" Disabled="@(goStatus == StepStatus.Running)">
                    Go
                </MudButton>
                @if (goStatus == StepStatus.Running)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                @if (goStatus == StepStatus.Success)
                {
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                }
                @if (goStatus == StepStatus.Error)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Title="@goError" />
                    <MudText Color="Color.Error" Typo="Typo.body2">@goError</MudText>
                }
            </MudStack>

        </div>
    </div>
    <MudStack Row="true" class="bt-button-tray">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" OnClick='@(async () => await GoBack(js))' Class="justify-start" />
        <MudSpacer />
        <MudButton Variant="Variant.Text" OnClick="OnReset" Disabled="@(goStatus == StepStatus.Running)">Reset</MudButton>
    </MudStack>
</div>

<style>
    .bt-pref-group-label0 {
        font-weight: bold;
        padding-top: 1.143rem;
    }
</style>
