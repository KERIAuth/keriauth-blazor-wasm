@page "/RequestConnect.html"
@layout Layouts.DialogLayout
@inherits Extension.UI.Components.TabDialogPageBase

@using Extension.Models
@using Extension.Models.Messages.AppBw
@using Extension.Models.Messages.AppBw.Requests
@using Extension.Models.Messages.BwApp
@using Extension.Models.Messages.BwApp.Requests
@using Extension.Services
@using FluentResults
@using MudBlazor

@inject ILogger<RequestConnectPage> logger
@inject ISnackbar snackbar

@code {
    private MudButton? connectButton;

    private string? SelectedAidName { get; set; }
    private string? SelectedPrefix { get; set; }
    private string? ConnectionName { get; set; }
    private string FriendlyName { get; set; } = "";
    private string? OobiName { get; set; }

    ConnectionInviteRequestPayload? payload;

    bool IsApproveDisabled => SelectedAidName is null || string.IsNullOrWhiteSpace(ConnectionName) || string.IsNullOrWhiteSpace(FriendlyName);

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        logger.LogInformation("OnInitializedAsync");

        payload = await InitializeFromPendingRequestAsync<ConnectionInviteRequestPayload>(
            BwAppMessageType.Values.RequestConnectionInvite);
        if (payload is null)
        {
            return;
        }

        logger.LogInformation("OnInitializedAsync: oobi={Oobi}", payload.Oobi);

        // Extract suggested connection name from OOBI ?name= parameter
        if (!string.IsNullOrEmpty(payload.Oobi))
        {
            try
            {
                var uri = new Uri(payload.Oobi);
                var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
                var name = query["name"];
                if (!string.IsNullOrEmpty(name))
                {
                    ConnectionName = name;
                }
            }
            catch { }
        }

        // Fall back to resolved alias if no ?name= found
        if (string.IsNullOrEmpty(ConnectionName) && !string.IsNullOrEmpty(payload.ResolvedAlias))
        {
            ConnectionName = payload.ResolvedAlias;
        }

        OobiName = ConnectionName;

        if (payload.ResolvedAidPrefix is null)
        {
            logger.LogError("OnInitializedAsync: ResolvedAidPrefix is null for oobi={Oobi}", payload.Oobi);
        }

        await LoadActiveTabAsync();

        IsInitialized = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && connectButton is not null)
        {
            // await connectButton.FocusAsync();
        }
    }

    async Task<Result> Approve()
    {
        await BeginActionAsync();

        if (SelectedAidName is null)
        {
            var error = new ValidationError("Selection", "No profile selected");
            snackbar.Add(error.Message, Severity.Error);
            return Result.Fail(error);
        }

        var replyPayload = new ConnectionInviteReplyPayload(
            AidName: SelectedAidName,
            ConnectionName: ConnectionName,
            FriendlyName: FriendlyName);
        var message = new AppBwReplyConnectionInviteMessage(TabId, OriginStr, PageRequestId, replyPayload);
        await AppBwPortService.SendToBackgroundWorkerAsync(message);
        MarkAsReplied();

        try
        {
            await ClearPendingRequestAsync();
            await WaitForAppCacheClearAsync();
            await ReturnToPriorUIAsync();
            return Result.Ok();
        }
        catch (Exception ex)
        {
            logger.LogError("Failed to complete connection approval: {error}", ex.Message);
            return Result.Fail(new JavaScriptInteropError("SendToServiceWorker", ex.Message, ex));
        }
    }

    async Task Cancel()
    {
        await CancelAndReturnAsync("User canceled connection request");
    }

    private async Task HandleAidChanged((string selectedPrefix, string selectedAlias, RecursiveDictionary? selectedCredentialOrNothing, WebsiteConfig? websiteConfig) value)
    {
        logger.LogInformation("HandleAidChanged: prefix={Prefix}, alias={Alias}", value.selectedPrefix, value.selectedAlias);
        SelectedPrefix = value.selectedPrefix;
        SelectedAidName = value.selectedAlias;
        // Intentionally clear friendly name when profile changes
        FriendlyName = "";
        if (connectButton is not null)
        {
            // await connectButton.FocusAsync();
        }
    }

    private async Task ApproveHandler()
    {
        var result = await Approve();
        if (result.IsFailed)
        {
            logger.LogError("Connection approval failed: {error}", result.Errors.FirstOrDefault()?.Message);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Code == "NumpadEnter")
        {
            await ApproveHandler();
        }
    }
}

@if (IsInitialized)
{
    <div id="@this.GetType().Name" class="bt-body-page">
        <MudStack Class="bt-main">
            <div class="bt-main-inside-scroll">
                <PageHeading Title="Request to Connect" />
                @if (ActiveTab is not null)
                {
                    <TabInteractionDisplay ActiveTab=@ActiveTab />
                }
                else
                {
                    <MudText Typo="Typo.body1" Class="mb-4">Unknown Page (tab not found)</MudText>
                }
                <MudText Typo="Typo.body1" Class="bt-help-text">
                    This website is requesting you to establish a mutual KERI connection.<br/>
                    ① Select one of your profiles to share with the them; <br/>
                    ② Name your connection to them, which you can later see from the Websites menu; and<br/>
                    ③ Suggest a name for their connection to you that is unambiguous, such as your full name.
                </MudText>

                <style>
                    .color-incoming {
                        color: var(--mud-palette-info);
                    }
                    #tf-name3 .mud-input-outlined-border {
                        border-color: var(--mud-palette-info) !important;
                    }
                    #tf-name3 .mud-input-label {
                        color: var(--mud-palette-info) !important;
                    }
                </style>

                <div style="max-width: 600px;">
                    <MudPaper id="paper1" Class="pa-2" Elevation="2" Outlined="true">
                        <WebsiteConfigDisplay OriginStr="@OriginStr" Heading="① Your Profile" IsOriginShown="false" IsCredentialShown="false" IsAutoSignShown="false" ValueChanged="async (v) => await HandleAidChanged(v)" />
                    </MudPaper>
                    <div style="position: relative;">
                        <!-- Background boxes -->
                        <div style="display: flex; flex-direction: column; padding: 0 10%;">
                            <MudPaper id="paper2" Class="pa-2 flex-grow-1 d-flex justify-end" Elevation="0" Style="background:transparent;">
                                <MudStack Style="gap:0;">
                                    <MudText Class="bt-section-title" Style="margin-top:0; margin-bottom:0;">② Your connection</MudText>
                                    <MudTextField @bind-Value="ConnectionName"
                                                  Label="Name"
                                                  Variant="Variant.Outlined"
                                                  Immediate="true" />
                                </MudStack>
                            </MudPaper>
                            <MudPaper id="paper3" Class="pa-2 flex-grow-1 d-flex align-end" Elevation="0" Style="background:transparent; padding-right:75px !important;">
                                <MudStack Class="color-incoming" Style="gap:0;">
                                    <MudText Class="bt-section-title" Style="margin-top:0; margin-bottom:0;">Invitation for their connection</MudText>
                                    <div id="tf-name3">
                                        @if (SelectedAidName is null)
                                        {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                        }
                                        else
                                        {
                                            <MudTextField @bind-Value="FriendlyName"
                                                          Label="③ Name"
                                                          Variant="Variant.Outlined"
                                                          Immediate="true" />
                                        }
                                    </div>
                                </MudStack>
                            </MudPaper>
                        </div>

                        <!-- Arrow overlay -->
                        <svg width="100%" height="100%" preserveAspectRatio="none"
                             style="position: absolute; inset: 0; z-index: 1; pointer-events: none;">
                            <defs>
                                <marker id="arrow" markerWidth="10" markerHeight="7"
                                        refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#757575"/>
                                </marker>
                                <marker id="arrow1" markerWidth="10" markerHeight="7"
                                        refX="9" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
                                    <polygon points="0 0, 10 3.5, 0 7" style="fill: var(--mud-palette-info)"/>
                                </marker>
                            </defs>
                            <!-- Left: upward arrow (bottom box → top box) -->
                            <line x1="10%" y1="100%" x2="10%" y2="0%"
                                  style="stroke: var(--mud-palette-info); stroke-width: 2;" marker-end="url(#arrow1)"/>
                            <!-- Right: downward arrow (top box → bottom box) -->
                            <line x1="90%" y1="0%" x2="90%" y2="100%"
                                  stroke="#757575" stroke-width="2" marker-end="url(#arrow)"/>
                        </svg>
                    </div>

                    @if (payload?.ResolvedAidPrefix is not null)
                    {
                        <MudPaper id="paper4" Class="pa-2" Elevation="2" Outlined="true">
                            <MudText Class="bt-section-title" Style="margin-top:0; margin-bottom:0;">Their Profile</MudText>
                            <AidPrefixDisplay Prefix="@payload.ResolvedAidPrefix" Name="@OobiName" ShowCopyButton="false" />
                        </MudPaper>
                    }
                </div>
            </div>
        </MudStack>

        <MudStack Row="true" class="bt-button-tray">
            <MudButton StartIcon="@Icons.Material.Filled.Cancel" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@(async (_) => await Cancel())">Cancel</MudButton>
            <MudButton @ref="connectButton"
                       StartIcon="@Icons.Material.Filled.Handshake"
                       Disabled="IsApproveDisabled"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="ApproveHandler"
                       @onkeydown="HandleKeyDown">
                Connect
            </MudButton>
        </MudStack>
    </div>
}
