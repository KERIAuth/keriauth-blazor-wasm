@using Microsoft.VisualBasic
@using Extension.Services.Storage
@using System.Diagnostics.CodeAnalysis
@using Extension.UI.Components
@using System.Text.Json.Serialization
@inject ILogger<CredentialCardGeneric> logger
@inject IJSRuntime js
@inject ISnackbar snackbar
@inject IStorageService storageService

@code {
    [Parameter] public bool IsDense { get; set; } = true;
    [Parameter] public CredDetail DisplayDetail { get; set; } = CredDetail.Typical;
    [Parameter] public string CredentialTypeName { get; set; } = "unspecified";
    [Parameter] public RenderFragment? IssueeDetail { get; set; }
    [Parameter] public RenderFragment? IssuerDetail { get; set; }
    [Parameter]
    [NotNull]
    public RecursiveDictionary? credential { get; init; }

    // fields and types
    public enum CredDetail
    {
        Minimal,
        Typical
    }

    // fields
    static private JsonSerializerOptions options = new()
    {
        WriteIndented = true,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
    };

    // computed properties
    TypedValue? SchemaPropertiesTypeValue => credential?.GetValueByPath("schema.properties.a.oneOf");
    List<object>? SchemaProperties => SchemaPropertiesTypeValue?.Value as List<object>;
    string? CredentialJson => JsonSerializer.Serialize(credential?.ToObjectDictionary(), options);
    RecursiveDictionary? SchemaProperties1 => (SchemaProperties is null || SchemaProperties[1] is null) ? null : SchemaProperties[1] as RecursiveDictionary ?? RecursiveDictionary.FromObjectDictionary((Dictionary<string, object>)SchemaProperties[1]);

    // Common schema properties
    string? SchemaId => credential?.GetValueByPath("schema.$id")?.Value?.ToString() ?? string.Empty;
    string? CredentialType => credential?.GetValueByPath("schema.$credentialType")?.Value?.ToString() ?? string.Empty;
    string? SchemaTitle => credential?.GetValueByPath("schema.title")?.Value?.ToString() ?? string.Empty;
    string? SchemaDescr => credential?.GetValueByPath("schema.description")?.Value?.ToString() ?? string.Empty;
    string? IssuerLabel => credential?.GetValueByPath("schema.properties.i.description")?.Value?.ToString() ?? String.Empty;
    string? IssuerValue => credential?.GetValueByPath("sad.i")?.Value.ToString() ?? String.Empty;
    string? IssuedDate => credential?.GetValueByPath("sad.a.dt")?.Value?.ToString()?.Substring(0, 10) ?? string.Empty;

    // Credential-specific schema properties
    string? PersonLegalNameLabel => (SchemaProperties1 is null) ? null : SchemaProperties1?.GetValueByPath("properties.personLegalName.description")?.Value.ToString() ?? String.Empty;
    string? PersonLegalNameValue => credential?.GetValueByPath("sad.a.personLegalName")?.Value.ToString() ?? String.Empty;
    string? OfficialRoleLabel => (SchemaProperties1 is null) ? null : SchemaProperties1?.GetValueByPath("properties.officialRole.description")?.Value.ToString() ?? String.Empty;
    string? OfficialRoleValue => credential?.GetValueByPath("sad.a.officialRole")?.Value.ToString() ?? String.Empty;
    string? RequestingLEILabel => (SchemaProperties1 is null) ? null : SchemaProperties1.GetValueByPath("properties.LEI.description")?.Value.ToString() ?? String.Empty;
    string? RequestingLEIValue => credential?.GetValueByPath("sad.a.LEI")?.Value.ToString() ?? String.Empty;
    string? IssueeLabel => (SchemaProperties1 is null) ? null : SchemaProperties1.GetValueByPath("properties.i.description")?.Value.ToString() ?? String.Empty;
    string? IssueeValue => credential?.GetValueByPath("sad.a.i")?.Value.ToString() ?? String.Empty;
    string? EcrDescription => (SchemaProperties1 is null) ? null : @SchemaProperties1.GetValueByPath("properties.engagementContextRole.description")?.Value.ToString() ?? String.Empty;
    string? EcrValue => @credential?.GetValueByPath("sad.a.engagementContextRole")?.Value.ToString() ?? String.Empty;
    string? UsageDisclaimerLabel => (SchemaProperties1 is null) ? null : @SchemaProperties1.GetValueByPath("properties.usageDisclaimer.description")?.Value.ToString() ?? String.Empty;
    string? UsageDisclaimerValue => @credential?.GetValueByPath("sad.a.usageDisclaimer")?.Value.ToString() ?? String.Empty;
    string? PrivacyDisclaimerLabel => (SchemaProperties1 is null) ? null : @SchemaProperties1.GetValueByPath("properties.privacyDisclaimer.description")?.Value.ToString() ?? String.Empty;
    string? PrivacyDisclaimerValue => @credential?.GetValueByPath("sad.a.privacyDisclaimer")?.Value.ToString() ?? String.Empty;


    // TBD P2 implement usage of this
    // Check whether the expected credential type matches the schema id. Assumes the current versions as of 2025-08-26
    private Boolean CheckExpectedCredentialType() => (SchemaId) switch
    {
        "EBNaNu-M9P5cgrnfl2Fvymy4E_jvxxyjb70PRtiANlJy" => OOR_Cred == CredentialType,
        "EH6ekLjSr8V32WyFbGe1zXjTzFs9PkTYmupJ9H65O14g" => ECRAuth_Cred == CredentialType,
        "EEy9PkikFcANV1l7EHukCeXqrzT1hNZjGlUk7wuMO5jw" => ECR_Cred == CredentialType,
        "ENPXp1vQzRF6JwIuS-mp2U8Uf1MoADoP_GqQ62VsDZWY" => VLEI_Cred == CredentialType,
        "EKA57bKBKxr_kN7iN5i7lMUxpMG-s19dRcmov1iDxz-E" => OORAuth_Cred == CredentialType,
        "EBfdlu8R27Fbx-ehrqwImnK-8Cm79sqbAQ4MmvEAYqao" => QVI_Cred == CredentialType,
        "EMhvwOlyEJ9kN4PrwCpr9Jsv7TxPhiYveZ0oP3lJzdEi" => XBRL_Attest == CredentialType,
        // otherwise, an unknown schema id or unexpected mismatch
        _ => false
    };

    const string OOR_Cred = "LegalEntityOfficialOrganizationalRolevLEICredential";
    const string ECRAuth_Cred = "ECRAuthorizationvLEICredential";
    const string ECR_Cred = "LegalEntityEngagementContextRolevLEICredential";
    const string VLEI_Cred = "LegalEntityvLEICredential";
    const string OORAuth_Cred = "OORAuthorizationvLEICredential";
    const string QVI_Cred = "QualifiedvLEIIssuervLEICredential";
    const string XBRL_Attest = "iXBRLDataAttestation";

    private async Task CopyJsonToClipboard()
    {
        if (CredentialJson is not null)
        {
            // TODO P2 warn user about sensitive data.  Graduated disclosure.
            await js.InvokeVoidAsync("navigator.clipboard.writeText", CredentialJson);
            snackbar.Add("Credential JSON copied to clipboard.", Severity.Success);
        }
        else
        {
            snackbar.Add("No Credential JSON to copy.", Severity.Warning);
        }
    }

    private Task NextDetail()     {
        DisplayDetail = DisplayDetail switch
        {
            CredDetail.Minimal => CredDetail.Typical,
            CredDetail.Typical => CredDetail.Minimal,
            _ => CredDetail.Typical
        };
        return Task.CompletedTask;
    }
}

<CredentialCardWrapper IsDense="@IsDense" Style="background:#EFFFF8;">
    <Header>
        <MudText Typo="Typo.subtitle1"><b>@SchemaTitle</b>  <em>@EcrValue @OfficialRoleValue</em></MudText>
    </Header>

    <HeaderActions>
        <MudIconButton Icon="@Icons.Material.Filled.ExpandMore" Size="Size.Small" OnClick="NextDetail" />

    </HeaderActions>

    <ChildContent>
        @if (DisplayDetail == CredDetail.Typical)
        {
            <MudStack>
                <MudText><em>@SchemaDescr</em></MudText>

                @* Credential-level details, if present *@
                @if (!string.IsNullOrEmpty(EcrDescription))
                {
                    <MudText><b>ECR Details</b></MudText>
                    <MudStack Row Class="ml-2" Style="align-items: center;">
                        <MudText><b>@EcrDescription: </b>@EcrValue</MudText>
                    </MudStack>
                }

                <MudText><b>Issued</b> @IssuedDate</MudText>

                <MudText><b>Issuer</b></MudText>
                <MudStack Class="ml-2">
                    <MudStack Row Style="align-items: center;">
                        <MudIcon ViewBox="0 0 100 100" Icon="@MakeIdenticon(IssuerValue)"
                                 Class="bt-identicon" />
                        <MudText Style="overflow-wrap: anywhere;">@IssuerLabel: <br /><b>@IssuerValue</b></MudText>
                    </MudStack>

                    @* Optional RenderFragement parameter *@
                    @IssuerDetail
                    @* TODO P0 Is this the "LE Issuer AID" the Issuee requesting? *@
                    @if (!String.IsNullOrWhiteSpace(RequestingLEILabel))
                    {
                        var leiLink = "https://search.gleif.org/#/search/criteria%5B0%5D%5BrelId%5D=FILTER_LEIREC&criteria%5B0%5D%5BfieldId%5D=LEIREC_LEI&criteria%5B0%5D%5Bvalue%5D=" + @RequestingLEIValue + "&criteria%5B0%5D%5Boperator%5D=MATCH&criteria%5B0%5D%5BdataType%5D=STRING&currentPage=1&perPage=15&expertMode=true#search-form";
                        <MudText>
                            @RequestingLEILabel: <b>@RequestingLEIValue</b>
                            <MudLink Href=@leiLink Target="_blank">Query LEI Details</MudLink>
                        </MudText>
                    }

                </MudStack>

                @* Issuee, which may not be present in attestations *@
                @if (IssueeLabel is not null && IssueeLabel != String.Empty && IssueeValue is not null)
                {
                    <MudText><b>Issuee</b></MudText>
                    <MudStack class="ml-2">
                        <MudStack Row Style="align-items: center;">
                            <MudIcon ViewBox="0 0 100 100" Icon="@MakeIdenticon(IssueeValue)"
                                     Class="bt-identicon" />
                            <MudText Style="overflow-wrap: anywhere;">@IssueeLabel: <br /><b>@IssueeValue</b></MudText>
                        </MudStack>
                        @* Optional RenderFragement parameter *@
                        @IssueeDetail

                        @* TODO P2 Note these are dependant on Credential Type / Schema Type. Some apply to more than one *@
                        @if (!String.IsNullOrWhiteSpace(PersonLegalNameLabel))
                        {
                            <MudText><b>@PersonLegalNameLabel: </b>@PersonLegalNameValue</MudText>
                        }
                        @if (!String.IsNullOrWhiteSpace(OfficialRoleLabel))
                        {
                            <MudText><b>@OfficialRoleLabel: </b>@OfficialRoleValue</MudText>
                        }
                    </MudStack>
                }

                @if (!String.IsNullOrWhiteSpace(UsageDisclaimerLabel))
                {
                    <MudText><b>@UsageDisclaimerLabel:</b> @UsageDisclaimerValue</MudText>
                }
                @if (!String.IsNullOrWhiteSpace(PrivacyDisclaimerLabel))
                {
                    <MudText><b>@PrivacyDisclaimerLabel:</b> @PrivacyDisclaimerValue</MudText>
                }

                @* TODO P2 Add Credential tree view here *@

                <MudExpansionPanels>
                    <MudExpansionPanel Text="Raw JSON">
                        <MudPaper Elevation="1"
                                  Class="pa-3"
                                  Style="overflow-x: auto;">
                            <MudText Style="white-space: pre; font-family: monospace;">
                                @CredentialJson
                            </MudText>
                            <MudButton Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.ContentCopy"
                                       OnClick="CopyJsonToClipboard">
                                Copy JSON
                            </MudButton>
                        </MudPaper>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudStack>
        }
    </ChildContent>

    <Footer>
        @if (DisplayDetail == CredDetail.Typical)
        {
            <MudButton Variant="Variant.Text" Size="Size.Small">Details</MudButton>
            <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary">Verify</MudButton>
        }
    </Footer>

</CredentialCardWrapper>
