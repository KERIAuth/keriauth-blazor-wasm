@using static Extension.Helper.Identicon
@using static Extension.Helper.CredentialHelper

@code {
    [Parameter, EditorRequired]
    public required RecursiveDictionary Credential { get; init; }

    [Parameter]
    public bool Expanded { get; set; }

    [Parameter]
    public EventCallback<bool> ExpandedChanged { get; set; }

    [Parameter]
    public RenderFragment? Actions { get; set; }

    [Parameter]
    public bool ShowMenuButton { get; set; } = false;

    [Parameter]
    public bool IsSelected { get; set; }

    [Parameter]
    public EventCallback OnClick { get; set; }

    // Computed from credential
    string SchemaTitle => Credential.GetValueByPath("schema.title")?.Value?.ToString() ?? "Unknown Credential";
    string RoleOrContext => GetRoleOrContext();
    string Subtitle => GetSubtitle();
    // string StatusLabel => "Active"; // TODO P2: derive from credential status
    string PanelStyle => $"background-color: {GetBackgroundColor(Credential)};";
    string PanelClass => IsSelected ? "credential-panel selected-credential" : "credential-panel";

    string GetRoleOrContext()
    {
        var ecr = Credential.GetValueByPath("sad.a.engagementContextRole")?.Value?.ToString();
        var oor = Credential.GetValueByPath("sad.a.officialRole")?.Value?.ToString();
        return ecr ?? oor ?? string.Empty;
    }

    string GetSubtitle()
    {
        var lei = Credential.GetValueByPath("sad.a.LEI")?.Value?.ToString();
        var issuer = Credential.GetValueByPath("sad.i")?.Value?.ToString();
        var issuerShort = issuer?.Length > 12 ? issuer[..12] + "..." : issuer;
        return lei is not null && lei.Length > 8 ? $"LEI: {lei[..8]}..." : issuerShort ?? "Unknown Issuer";
    }

    async Task ToggleExpanded()
    {
        Expanded = !Expanded;
        await ExpandedChanged.InvokeAsync(Expanded);
    }

    async Task HandleClick()
    {
        if (OnClick.HasDelegate)
        {
            await OnClick.InvokeAsync();
        }
    }
}

<MudExpansionPanel Class="@PanelClass"
                   Gutters="false"
                   @bind-Expanded="Expanded"
                   Style="@PanelStyle">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="px-4 py-3" @onclick="HandleClick">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Badge" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.subtitle1">@SchemaTitle</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @Subtitle @if (!string.IsNullOrEmpty(RoleOrContext)) { <text> &bull; @RoleOrContext</text> }
                    </MudText>
                </MudStack>
                @*
                <MudChip T="string" Size="Size.Small" Label="true" Color="Color.Success">@StatusLabel</MudChip>
                *@
            </MudStack>

            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                @if (ShowMenuButton)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.MoreVert"
                                   Size="Size.Small"
                                   @onclick:stopPropagation="true" />
                }
                @Actions
                @*
                <MudIcon Icon="@(Expanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" />
                *@
            </MudStack>
        </MudStack>
        <MudDivider />
    </TitleContent>

    <ChildContent>
        <MudPaper Class="px-4 py-3" Elevation="0">
            <CredentialPanelDetail Credential="@Credential" />
        </MudPaper>
    </ChildContent>
</MudExpansionPanel>
