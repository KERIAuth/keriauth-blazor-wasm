@using static Extension.Helper.Identicon
@using System.Text.Json
@using System.Text.Json.Serialization

@inject IJSRuntime js
@inject ISnackbar snackbar

@code {
    [Parameter, EditorRequired]
    public required RecursiveDictionary Credential { get; init; }

    [Parameter]
    public RenderFragment? IssueeDetail { get; set; }

    [Parameter]
    public RenderFragment? IssuerDetail { get; set; }

    // JSON serialization options
    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true,
        DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull
    };

    // Schema properties
    TypedValue? SchemaPropertiesTypeValue => Credential.GetValueByPath("schema.properties.a.oneOf");
    List<object>? SchemaProperties => SchemaPropertiesTypeValue?.Value as List<object>;
    RecursiveDictionary? SchemaProperties1 => (SchemaProperties is null || SchemaProperties.Count < 2 || SchemaProperties[1] is null)
        ? null
        : SchemaProperties[1] as RecursiveDictionary ?? RecursiveDictionary.FromObjectDictionary((Dictionary<string, object>)SchemaProperties[1]);

    // Common schema properties
    string? SchemaDescr => Credential.GetValueByPath("schema.description")?.Value?.ToString();
    string? IssuerLabel => Credential.GetValueByPath("schema.properties.i.description")?.Value?.ToString() ?? "Issuer";
    string? IssuerValue => Credential.GetValueByPath("sad.i")?.Value?.ToString();
    string? IssuedDate => Credential.GetValueByPath("sad.a.dt")?.Value?.ToString()?.Substring(0, 10);

    // Credential-specific schema properties
    string? PersonLegalNameLabel => SchemaProperties1?.GetValueByPath("properties.personLegalName.description")?.Value?.ToString();
    string? PersonLegalNameValue => Credential.GetValueByPath("sad.a.personLegalName")?.Value?.ToString();
    string? OfficialRoleLabel => SchemaProperties1?.GetValueByPath("properties.officialRole.description")?.Value?.ToString();
    string? OfficialRoleValue => Credential.GetValueByPath("sad.a.officialRole")?.Value?.ToString();
    string? RequestingLEILabel => SchemaProperties1?.GetValueByPath("properties.LEI.description")?.Value?.ToString();
    string? RequestingLEIValue => Credential.GetValueByPath("sad.a.LEI")?.Value?.ToString();
    string? IssueeLabel => SchemaProperties1?.GetValueByPath("properties.i.description")?.Value?.ToString();
    string? IssueeValue => Credential.GetValueByPath("sad.a.i")?.Value?.ToString();
    string? EcrDescription => SchemaProperties1?.GetValueByPath("properties.engagementContextRole.description")?.Value?.ToString();
    string? EcrValue => Credential.GetValueByPath("sad.a.engagementContextRole")?.Value?.ToString();
    string? UsageDisclaimerLabel => SchemaProperties1?.GetValueByPath("properties.usageDisclaimer.description")?.Value?.ToString();
    string? UsageDisclaimerValue => Credential.GetValueByPath("sad.a.usageDisclaimer")?.Value?.ToString();
    string? PrivacyDisclaimerLabel => SchemaProperties1?.GetValueByPath("properties.privacyDisclaimer.description")?.Value?.ToString();
    string? PrivacyDisclaimerValue => Credential.GetValueByPath("sad.a.privacyDisclaimer")?.Value?.ToString();

    string? CredentialJson => JsonSerializer.Serialize(Credential.ToObjectDictionary(), JsonOptions);

    string GetLeiLink(string lei) =>
        $"https://search.gleif.org/#/search/criteria%5B0%5D%5BrelId%5D=FILTER_LEIREC&criteria%5B0%5D%5BfieldId%5D=LEIREC_LEI&criteria%5B0%5D%5Bvalue%5D={lei}&criteria%5B0%5D%5Boperator%5D=MATCH&criteria%5B0%5D%5BdataType%5D=STRING&currentPage=1&perPage=15&expertMode=true#search-form";

    async Task CopyJsonToClipboard()
    {
        if (CredentialJson is not null)
        {
            await js.InvokeVoidAsync("navigator.clipboard.writeText", CredentialJson);
            snackbar.Add("Credential JSON copied to clipboard.", Severity.Success);
        }
        else
        {
            snackbar.Add("No Credential JSON to copy.", Severity.Warning);
        }
    }
}

<MudStack Spacing="3">
    @if (!string.IsNullOrEmpty(SchemaDescr))
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary"><em>@SchemaDescr</em></MudText>
    }

    @* ECR Details *@
    @if (!string.IsNullOrEmpty(EcrDescription))
    {
        <MudStack Spacing="1">
            <MudText Typo="Typo.subtitle2"><b>ECR Details</b></MudText>
            <MudText Typo="Typo.body2" Class="ml-2"><b>@EcrDescription:</b> @EcrValue</MudText>
        </MudStack>
    }

    <MudText Typo="Typo.body2"><b>Issued:</b> @IssuedDate</MudText>

    @* Issuer section *@
    <MudStack Spacing="1">
        <MudText Typo="Typo.subtitle2"><b>Issuer</b></MudText>
        <MudStack Class="ml-2" Spacing="2">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon ViewBox="0 0 100 100" Icon="@MakeIdenticon(IssuerValue)" Class="bt-identicon" />
                <MudText Typo="Typo.body2" Style="overflow-wrap: anywhere;">
                    @IssuerLabel:<br /><b>@IssuerValue</b>
                </MudText>
            </MudStack>

            @IssuerDetail

            @if (!string.IsNullOrWhiteSpace(RequestingLEILabel) && !string.IsNullOrWhiteSpace(RequestingLEIValue))
            {
                <MudText Typo="Typo.body2">
                    @RequestingLEILabel: <b>@RequestingLEIValue</b>
                    <MudLink Href="@GetLeiLink(RequestingLEIValue)" Target="_blank">Query LEI Details</MudLink>
                </MudText>
            }
        </MudStack>
    </MudStack>

    @* Issuee section *@
    @if (!string.IsNullOrEmpty(IssueeLabel) && !string.IsNullOrEmpty(IssueeValue))
    {
        <MudStack Spacing="1">
            <MudText Typo="Typo.subtitle2"><b>Issuee</b></MudText>
            <MudStack Class="ml-2" Spacing="2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon ViewBox="0 0 100 100" Icon="@MakeIdenticon(IssueeValue)" Class="bt-identicon" />
                    <MudText Typo="Typo.body2" Style="overflow-wrap: anywhere;">
                        @IssueeLabel:<br /><b>@IssueeValue</b>
                    </MudText>
                </MudStack>

                @IssueeDetail

                @if (!string.IsNullOrWhiteSpace(PersonLegalNameLabel))
                {
                    <MudText Typo="Typo.body2"><b>@PersonLegalNameLabel:</b> @PersonLegalNameValue</MudText>
                }
                @if (!string.IsNullOrWhiteSpace(OfficialRoleLabel))
                {
                    <MudText Typo="Typo.body2"><b>@OfficialRoleLabel:</b> @OfficialRoleValue</MudText>
                }
            </MudStack>
        </MudStack>
    }

    @* Disclaimers *@
    @if (!string.IsNullOrWhiteSpace(UsageDisclaimerLabel))
    {
        <MudText Typo="Typo.body2"><b>@UsageDisclaimerLabel:</b> @UsageDisclaimerValue</MudText>
    }
    @if (!string.IsNullOrWhiteSpace(PrivacyDisclaimerLabel))
    {
        <MudText Typo="Typo.body2"><b>@PrivacyDisclaimerLabel:</b> @PrivacyDisclaimerValue</MudText>
    }

    @* Raw JSON expansion panel *@
    <MudExpansionPanels Dense="true">
        <MudExpansionPanel Text="Raw JSON" Dense="true">
            <MudPaper Elevation="1" Class="pa-3" Style="overflow-x: auto;">
                <MudText Style="white-space: pre; font-family: monospace; font-size: 0.75rem;">
                    @CredentialJson
                </MudText>
                <MudButton Variant="Variant.Text"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.ContentCopy"
                           OnClick="CopyJsonToClipboard">
                    Copy JSON
                </MudButton>
            </MudPaper>
        </MudExpansionPanel>
    </MudExpansionPanels>
</MudStack>
