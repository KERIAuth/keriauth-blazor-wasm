@inherits BaseLayout

@using Extension.Models.Storage
@using Extension.Services
@using Extension.Services.Storage
@using System
@using Extension.Services.SignifyService.Models
@using static WebExtensions.Net.Runtime.ContextType
@using System.Reactive.Linq
@using WebExtensions.Net.Extension

@inject HttpClient http
@inject IJSRuntime js
@inject NavigationManager navManager
@inject IStorageService storageService
@inject ISnackbar snackbar
@inject ILogger<MainLayout> logger
@inject IWebExtensionsApi webExtensionsApi
@inject IJsRuntimeAdapter jsRuntimeAdapter
@inject AppCache appCache
@inject SessionManager sessionManager

@code {
    // fields...
    const string miniWidth = "var(--mud-drawer-mini-width-left)";
    const string openWidth = "var(--mud-drawer-width-left)";
    string version = "";
    string version_name = "";

    // properties...
    bool IsProfilePanelOpen { get; set; }
    bool IsPersistentDrawerOpenInPopup { get; set; }

    // computed properties ...
    Object ActiveAidObject => (object?)ActivePrefix ?? "";
    string ActivePrefix => appCache.SelectedPrefix ?? "";
    string ActivePrefixIdenticon => Helper.Identicon.MakeIdenticon(ActivePrefix);
    string ActiveAlias => string.IsNullOrEmpty(ActivePrefix) || appCache.Aids.Count == 0
        ? ""
        : appCache.Aids.Find(x => x.Prefix == ActivePrefix)?.Name ?? "";
    bool IsIdenticonShown => appCache.IsConnectedToKeria && !string.IsNullOrEmpty(ActivePrefix);
    string? KeriaAlias => appCache.GetSelectedKeriaConnectConfig()?.Alias;
    bool IsMultiKeriaConfigEnabled => appCache.MyPreferences.IsMultiKeriaConfigEnabled;
    static ContextFilter contextFilterPopup => new ContextFilter() { ContextTypes = [ContextType.POPUP] };
    string MainContentStyle => (IsMenuDrawerOpen, ActiveDrawerVariant) switch
    {
        (_, DrawerVariant.Mini)
            => $"left: {miniWidth}; width:calc(100vw - {miniWidth}; padding-right: {miniWidth});",
        (_, DrawerVariant.Temporary)
            => $"left: 0; width:calc(100vw);",
        (true, DrawerVariant.Persistent)
            => $" width:calc(100vw - {openWidth}); ",
        (true, _)
            => $"left: 0; width:calc(100vw);",
        (false, DrawerVariant.Persistent)
            => $"left: 0; width:calc(100vw); padding-right: 0;",
        (false, _)
            => $"left: {openWidth}; width:calc(100vw - {openWidth});"
    };
    DrawerVariant ActiveDrawerVariant => (App.IsInPopup, App.IsInSidePanel, App.IsInTab) switch
    {
        (true, _, _) => appCache.MyPreferences.DrawerVariantInPopup,
        (_, true, _) => appCache.MyPreferences.DrawerVariantInSidePanel,
        (_, _, true) => appCache.MyPreferences.DrawerVariantInTab,
        _ => appCache.MyPreferences.DrawerVariantInTab
    };
    bool IsMenuDrawerOpen
    {
        get
        {
            if (App.IsInTab)
            {
                return appCache.MyPreferences.IsPersistentDrawerOpenInTab;
            }
            else if (App.IsInSidePanel)
            {
                return appCache.MyPreferences.IsPersistentDrawerOpenInSidePanel;
            }
            else
            {
                return IsPersistentDrawerOpenInPopup;
            }
        }
        set
        {
            // This setter is called by MudDrawer when the overlay is clicked (for Temporary variant).
            // Update the appropriate state based on the context.
            if (App.IsInTab)
            {
                _ = storageService.SetItem<Preferences>(appCache.MyPreferences with { IsPersistentDrawerOpenInTab = value });
            }
            else if (App.IsInSidePanel)
            {
                _ = storageService.SetItem<Preferences>(appCache.MyPreferences with { IsPersistentDrawerOpenInSidePanel = value });
            }
            else
            {
                IsPersistentDrawerOpenInPopup = value;
            }
        }
    }



    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        logger.LogInformation("OnInitializedAsync");

        // Initialize the currentExtensionContext
        var currentTab = await webExtensionsApi.Tabs.GetCurrent();
        var currentWindow = await webExtensionsApi.Windows.GetCurrent();
        var windowId = currentWindow?.Id ?? -1;
        // logger.LogWarning("OnInitializedAsync: currentTab Id={tabId}, currentWindow Id={windowId}", currentTab?.Id, windowId);

        // TODO P3 Perf: these (i.e., extensionId, manifestJson, version, version_name, ...) could be moved into App, and availale widely with static property
        // DRY and perf with this (e.g. setting version, version_name) in other locations including Index, NewReleasePage. Move to App.
        webExtensionsApi = new WebExtensionsApi(jsRuntimeAdapter);
        var manifestJsonElement = webExtensionsApi.Runtime.GetManifest();
        if (manifestJsonElement.TryGetProperty("version", out JsonElement versionElement) && versionElement.ValueKind == JsonValueKind.String)
        {
            version = versionElement.ToString();
        }
        if (manifestJsonElement.TryGetProperty("version_name", out JsonElement version_nameElement) && version_nameElement.ValueKind == JsonValueKind.String)
        {
            version_name = version_nameElement.ToString();
        }
    }

    async Task Lock()
    {
        await sessionManager.ClearKeriaSessionRecordsAsync();
        await appCache.WaitForAppCache([
            () => !appCache.IsAuthenticated
        ]);
        navManager.NavigateTo(Routes.PathFor<UnlockPage>());
    }

    async Task Unlock()
    {
        navManager.NavigateTo(Routes.PathFor<UnlockPage>());
    }

    protected override async Task HandleAppCacheChanged()
    {
        logger.LogInformation("HandleAppCacheChanged");
        await base.HandleAppCacheChanged();
        // Note: StateHasChanged() is called by base.HandleAppCacheChanged()
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        logger.LogInformation("OnParametersSetAsync");
    }

    async Task SetActiveAid(string prefix)
    {
        // Update SelectedPrefix in the current KeriaConnectConfig
        var selectedDigest = appCache.MyPreferences.KeriaPreference.SelectedKeriaConnectionDigest;
        if (!string.IsNullOrEmpty(selectedDigest))
        {
            var configs = appCache.MyKeriaConnectConfigs;
            if (configs.Configs.TryGetValue(selectedDigest, out var currentConfig))
            {
                var updatedConfig = currentConfig with { SelectedPrefix = prefix };
                var updatedConfigs = new Dictionary<string, KeriaConnectConfig>(configs.Configs)
                {
                    [selectedDigest] = updatedConfig
                };
                await storageService.SetItem(new KeriaConnectConfigs
                {
                    Configs = updatedConfigs,
                    IsStored = true
                });
            }
        }
        IsProfilePanelOpen = false;
    }

    async Task ClickToggleProfilePanel(MouseEventArgs _)
    {
        await ToggleProfilePanel();
    }

    async Task ToggleProfilePanel()
    {
        IsProfilePanelOpen = !IsProfilePanelOpen;
    }

    async Task ToggleMenuDrawer()
    {
        if (App.IsInTab)
        {
            var newPrefs = appCache.MyPreferences with { IsPersistentDrawerOpenInTab = !IsMenuDrawerOpen };
            await storageService.SetItem<Preferences>(newPrefs);
        }
        else if (App.IsInSidePanel)
        {
            var newPrefs = appCache.MyPreferences with { IsPersistentDrawerOpenInSidePanel = !IsMenuDrawerOpen };
            await storageService.SetItem<Preferences>(newPrefs);
        }
        else if (App.IsInPopup)
        {
            IsPersistentDrawerOpenInPopup = !IsPersistentDrawerOpenInPopup;
        }
        else
        {
            logger.LogError("ToggleMenuDrawer: Unknown App context");
        }
    }

    public override async ValueTask DisposeAsync()
    {
        await base.DisposeAsync();
    }
}


<MudThemeProvider Theme="@AppConfig.MyCustomTheme" IsDarkMode="appCache.MyPreferences.IsDarkTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider Style="z-index:9999; position:absolute;" />

<MudLayout id="@this.GetType().Name" Style="overflow-y:hidden; overflow-x:hidden; box-sizing: border-box; position:absolute; top:0; width:100vw;">
    <!-- APP BAR -->
    <MudAppBar Class="bt-appbar">
        <MudStack Style="height:inherit; width: 100%; padding:0 0.5rem 0 0.25rem;" Class="d-flex" Row="true">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" OnClick="ToggleMenuDrawer" Style="background-color:transparent;" data-testid="menuHamburger" />

            <LogoButton />

            @* // For debugging: Uncomment to confirm AppContext is correctly setting e.g. in popup, sidepanel, tab contexts
            <MudText>
                AppContext: @App.AppContext.ToString()
            </MudText>
            *@

            <MudSpacer />


            <SessionStatusIndicator IsAuthenticated="@appCache.IsAuthenticated"
                                    IsIdentifierFetched="@appCache.IsIdentifierFetched"
                                    IsConfigured="@appCache.IsConfigured"
                                    IsHovered="@isTimeoutHovered"
                                    TimeoutInfo="@TimeoutText"
                                    TimeoutTooltip="@TimeoutTooltip"
                                    SessionPercentageRemaining="@SessionPercentageRemaining"
                                    SessionDurationRemainingSeconds="@SessionDurationRemainingSeconds"
                                    OnHoverChanged="@((hovered) => isTimeoutHovered = hovered)"
                                    OnRefreshConnect="@RefreshConnect"
                                    OnLockClick="@(() => navManager.NavigateTo(Routes.PathFor<UnlockPage>()))"
                                    KeriaAlias="@KeriaAlias"
                                    IsMultiKeriaConfigEnabled="@IsMultiKeriaConfigEnabled" />

            <!-- Active Identifier Identicon -->
            <div style="align-self:center; height: 2.5rem; padding-right:0.5rem;">
                @if (IsIdenticonShown)
                {
                    <MudTooltip Text=@ActiveAlias Arrow="true" Placement="Placement.Left" Delay="500">
                        <MudIcon @onclick="async (a) => await ClickToggleProfilePanel(a)" ViewBox="0 0 100 100" Icon=@ActivePrefixIdenticon Class="bt-identicon" />
                    </MudTooltip>
                }
            </div>
        </MudStack>

        <!-- Identifier Selector overlay, which covers entire page -->
        <MudOverlay DarkBackground LightBackground @bind-Visible="@IsProfilePanelOpen" @onclick="ToggleProfilePanel" Style="display: block; width:100vw; min-height:100vh; height:fit-content; overflow-y:auto; color:var(--mud-palette-primary);">
            <div style="background:var(--mud-palette-background); position:absolute; height: auto; right: 0; display:block; width:21.429rem; margin-top: var(--bt-appbar-height); border-style: solid; border-top-style:none; border-width: 1px; border-color: #CACACA;">
                <MudList SelectedValue="ActiveAidObject" Class="bt-sad-4 pa-0">
                    @foreach (var aid in appCache.Aids)
                    {
                        <MudListItem Value="aid.Prefix" OnClick="async () => await SetActiveAid(aid.Prefix)" Style=@("border-left:" + @ProfilesPage.CardClass(ActivePrefix, aid.Prefix)) Class="bt-sad-5">
                            <MudStack Row="true" Style="display:inline-flex !important; align-items:center;">
                                <MudIcon Icon=@Helper.Identicon.MakeIdenticon(aid.Prefix) ViewBox="0 0 100 100" Class="bt-identicon" Style="margin-top: 0.214rem;" />
                                <div class="bt-sad-2" style="display:contents;">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">@aid.Name</MudText>
                                </div>
                            </MudStack>
                        </MudListItem>
                        <MudDivider DividerType="DividerType.Inset" />
                    }
                </MudList>
                <MudStack Row="true" Class="mt-3 mb-3 d-flex justify-end pr-2">
                    <MudSpacer></MudSpacer>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Href="@(Routes.PathFor<ProfilesPage>())">Manage Profiles</MudButton>
                </MudStack>
            </div>
        </MudOverlay>
    </MudAppBar>

    <!-- MENU DRAWER AND MAIN CONTENT -->
    <MudDrawerContainer id="MudDrawerContainer" Style="height:calc(100vh - var(--mud-appbar-height)); top:calc(var(--mud-appbar-height) + 0.5rem); position:absolute; width:inherit; display:flex;">
        <MudDrawer Style="background: var(--mud-palette-appbar-background);" id="MudDrawer" @bind-Open="IsMenuDrawerOpen" Elevation="0" ClipMode="DrawerClipMode.Never" Variant="@ActiveDrawerVariant" OpenMiniOnHover="true">
            <MudNavMenu Style="height:calc(100vh - var(--mud-appbar-height) - 0.5rem); overflow-y:auto;">
                <MudNavLink Href="@(Routes.PathFor<DashboardPage>())" Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Dashboard" IconColor="Color.Surface">Dashboard</MudNavLink>
                <MudNavLink Href="@(Routes.PathFor<ProfilesPage>())" Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Key" IconColor="Color.Surface">Profiles</MudNavLink>
                <MudNavLink Href="@(Routes.PathFor<CredentialsPage>())" Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Badge" IconColor="Color.Surface">Credentials</MudNavLink>
                <MudNavLink Href="@(Routes.PathFor<WebsitesPage>())" Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Web" IconColor="Color.Surface" data-testid="menuWebsites">Websites</MudNavLink>
                @if (appCache.IsAuthenticated)
                {
                    <MudNavLink OnClick=Lock Icon="@Icons.Material.Filled.Lock" IconColor="Color.Surface">Lock</MudNavLink>
                }
                else
                {
                    <MudNavLink Href="@(Routes.PathFor<UnlockPage>())" Icon="@Icons.Material.Filled.LockOpen" IconColor="Color.Surface">Unlock</MudNavLink>
                }

                <MudNavGroup Title="Advanced" Icon="@Icons.Material.Filled.Settings" IconColor="Color.Surface" Style="padding-right: 0;">
                    <MudNavLink Href="@(Routes.PathFor<PreferencesPage>())" Icon="@Icons.Material.Filled.SettingsApplications" IconColor="Color.Surface">Preferences</MudNavLink>
                    <MudNavLink Href="@(Routes.PathFor<Passkeys>())" Icon="@Icons.Material.Filled.Key" Disabled="@(!appCache.IsAuthenticated)" IconColor="Color.Surface">Passkeys</MudNavLink>
                    <MudNavLink Href="@(Routes.PathFor<KeriaConfigsPage>())" Icon="@Icons.Material.Filled.Cloud" IconColor="Color.Surface">KERIA</MudNavLink>
                    <MudNavLink Href="@(Routes.PathFor<DeletePage>())" Icon="@Icons.Material.Filled.DeleteForever" IconColor="Color.Surface">Reset All...</MudNavLink>
                    <MudNavGroup Title="Developer" Icon="@Icons.Material.Filled.Science" IconColor="Color.Surface" Style="padding-right: 0;">
                        <MudNavLink Href="@(Routes.PathFor<DeveloperStatePage>())" Icon="@Icons.Material.Filled.Label" IconColor="Color.Surface">State</MudNavLink>
                        <MudNavLink Href="@(Routes.PathFor<DeveloperPrimersPage>())" Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.AutoFixHigh" IconColor="Color.Surface">Primers</MudNavLink>
                        <MudNavLink Href="@(Routes.PathFor<DeveloperTestPage>())" Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Rule" IconColor="Color.Surface">Test</MudNavLink>
                        <MudNavLink Href="@(Routes.PathFor<PrimeDataPage>())" Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.DataObject" IconColor="Color.Surface">Prime Data</MudNavLink>
                        <MudNavLink Href="@(Routes.PathFor<MnemonicPage>())" Icon="@Icons.Material.Filled.Password" Disabled="@(!appCache.IsAuthenticated)" IconColor="Color.Surface">Recovery Phrase</MudNavLink>
                    </MudNavGroup>
                </MudNavGroup>

                <MudNavGroup Title="About" Icon="@Icons.Material.Filled.Info" IconColor="Color.Surface">
                    <!-- TODO P4 provide support help -->
                    <MudNavLink Style="display:none !important;" Href="@Routes.PathFor(ContentPage.Help)" Target="help" Icon="@Icons.Material.Filled.Help" IconColor="Color.Surface">Help</MudNavLink>
                    <MudNavLink Href="@Routes.PathFor(ContentPage.Terms)" Target="terms" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Terms</MudNavLink>
                    <MudNavLink Href="@Routes.PathFor(ContentPage.Privacy)" Target="privacy" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Privacy</MudNavLink>
                    <!-- TODO P4 provide licenses -->

                    <MudNavLink Style="display:none !important;" Href="@Routes.PathFor(ContentPage.Licenses)" Target="licenses" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Licenses</MudNavLink>
                    <MudNavLink Href="@Routes.PathFor(ContentPage.Release)" Target="releaseNotes" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Release Notes<br /><i>version @version_name</i></MudNavLink>
                    <MudNavLink Href="@Routes.PathFor(ContentPage.ReleaseHistory)" Target="releaseHistory" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Release History<br /></MudNavLink>
                </MudNavGroup>
            </MudNavMenu>
        </MudDrawer>

        <!-- MAIN CONTENT -->
        <MudMainContent Class="bt-main-content" Style="@MainContentStyle">
            <MudContainer MaxWidth="MaxWidth.Large" Style="height:inherit; min-height:inherit; padding-left:0; padding-right:0;">
                @Body
            </MudContainer>
        </MudMainContent>
    </MudDrawerContainer>
</MudLayout>
