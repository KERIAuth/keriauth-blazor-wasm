@inherits BaseLayout

@inject IJSRuntime jsRuntime
@inject AppCache appCache  // Reactive: inherits subscription from BaseLayout
@inject ILogger<BaseLayout> logger
@inject NavigationManager navManager

<MudThemeProvider Theme="@AppConfig.MyCustomTheme" IsDarkMode="@appCache.MyPreferences.IsDarkTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider Style="z-index:9999" />

<CascadingValue Value="this">
    <MudLayout id="@this.GetType().Name" Style="overflow-y:hidden; overflow-x:hidden; box-sizing: border-box; position:absolute; top:0; width:100vw;">
        <MudAppBar Class="bt-appbar">
            <MudStack Style="height:inherit; width: 100%; padding-bottom:0.571rem;" Class="d-flex pt-2 pl-2" Row="true">
                 <MudButton Href="@(Routes.PathFor<Extension.UI.Pages.Index>())" Class="bt-logo-button">
                    <img src="images/logo512.png" alt="Icon" style="width: 1.714rem; height: 1.714rem;" />
                    <MudText Style="margin-left:0.5rem; font-size:larger; color:hsl(183deg 100% 50%); font-variant: small-caps;">KeriAuth</MudText>
                </MudButton>

                <MudStack Row="true" Class="ml-4 d-flex align-center">
                    <MudText Typo="Typo.caption" Style="@TimeoutText.Style">
                        @TimeoutText.Text
                    </MudText>
                </MudStack>
                <MudSpacer />
            </MudStack>
        </MudAppBar>
        <MudMainContent Class="bt-main-content" Style="left:0; top:4.357rem;">
            <MudContainer MaxWidth="MaxWidth.Large" Style="height:inherit; min-height:inherit; padding-left:0; padding-right:0;">
                @Body
            </MudContainer>
        </MudMainContent>
    </MudLayout>
</CascadingValue>

@code {
    /// <summary>
    /// Closes the popup window (when DialogLayout is rendered in popup context)
    /// </summary>
    public async Task ClosePopupAsync() {
        try {
            await jsRuntime.InvokeVoidAsync("window.close");
        }
        catch (Exception ex) {
            logger.LogError(ex, "DialogLayout.ClosePopupAsync: Failed to close popup window");
        }
    }

    protected override async Task HandleAppCacheChanged()
    {
        await base.HandleAppCacheChanged();
        logger.LogInformation("HandleAppCacheChanged");
        StateHasChanged();
    }

    public override async ValueTask DisposeAsync()
    {
        await base.DisposeAsync();
    }

    public async Task ReturnToPriorUI()
    {
        logger.LogInformation("ReturnToPriorUI: Returning to prior UI context: {AppContextType}", App.AppContext);
        switch (App.AppContext)
        {
            case ContextType.POPUP:
                await ClosePopupAsync();
                break;
            case ContextType.SIDEPANEL:
                navManager.NavigateTo(Routes.PathFor<Extension.UI.Pages.Index>());
                break;
            case ContextType.TAB:
                navManager.NavigateTo(Routes.PathFor<Extension.UI.Pages.Index>());
                break;
            default:
                logger.LogWarning("ReturnToPriorUI: Unknown AppContextType {AppContextType}", App.AppContext);
                break;
        }
    }
}

<style>
    #DialogLayout {
        margin: 0;
    }
</style>
