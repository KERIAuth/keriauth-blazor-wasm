@inherits BaseLayout

@inject IJSRuntime jsRuntime
@inject AppCache appCache  // Reactive: inherits subscription from BaseLayout
@inject ILogger<BaseLayout> logger
@inject NavigationManager navManager

<MudThemeProvider Theme="@AppConfig.MyCustomTheme" IsDarkMode="@appCache.MyPreferences.IsDarkTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider Style="z-index:9999; position:absolute;" />

<CascadingValue Value="this">
    <MudLayout id="@this.GetType().Name" Style="overflow-y:hidden; overflow-x:hidden; box-sizing: border-box; position:absolute; top:0; width:100vw;">
        <MudAppBar Class="bt-appbar">
            <MudStack Style="height:inherit; width: 100%; padding:0 0.5rem 0 0.25rem;" Class="d-flex" Row="true">
                <LogoButton />
                
                <MudSpacer />

                <SessionStatusIndicator IsAuthenticated="@appCache.IsAuthenticated"
                                        IsIdentifierFetched="@appCache.IsIdentifierFetched"
                                        IsConfigured="@appCache.IsConfigured"
                                        IsHovered="@isTimeoutHovered"
                                        TimeoutInfo="@TimeoutText"
                                        TimeoutTooltip="@TimeoutTooltip"
                                        SessionPercentageRemaining="@SessionPercentageRemaining"
                                        SessionDurationRemainingSeconds="@SessionDurationRemainingSeconds"
                                        OnHoverChanged="@((hovered) => isTimeoutHovered = hovered)"
                                        OnRefreshConnect="@RefreshConnect"
                                        OnLockClick="@(() => navManager.NavigateTo(Routes.PathFor<UnlockPage>()))" />

            </MudStack>
        </MudAppBar>
        <MudMainContent Class="bt-main-content" Style="left:0; top:4.357rem;">
            <MudContainer MaxWidth="MaxWidth.Large" Style="height:inherit; min-height:inherit; padding-left:0; padding-right:0;">
                @Body
            </MudContainer>
        </MudMainContent>
    </MudLayout>
</CascadingValue>

@code {
    /// <summary>
    /// Closes the popup window (when DialogLayout is rendered in popup context)
    /// </summary>
    public async Task ClosePopupAsync() {
        try {
            await jsRuntime.InvokeVoidAsync("window.close");
        }
        catch (Exception ex) {
            logger.LogError(ex, "DialogLayout.ClosePopupAsync: Failed to close popup window");
        }
    }

    protected override async Task HandleAppCacheChanged()
    {
        await base.HandleAppCacheChanged();
        logger.LogInformation("HandleAppCacheChanged");
        StateHasChanged();
    }

    public override async ValueTask DisposeAsync()
    {
        await base.DisposeAsync();
    }

    public async Task ReturnToPriorUI()
    {
        logger.LogInformation("ReturnToPriorUI: Returning to prior UI context: {AppContextType}", App.AppContext);
        switch (App.AppContext)
        {
            case ContextType.POPUP:
                await ClosePopupAsync();
                break;
            case ContextType.SIDEPANEL:
                navManager.NavigateTo(Routes.PathFor<Extension.UI.Pages.Index>());
                break;
            case ContextType.TAB:
                navManager.NavigateTo(Routes.PathFor<Extension.UI.Pages.Index>());
                break;
            default:
                logger.LogWarning("ReturnToPriorUI: Unknown AppContextType {AppContextType}", App.AppContext);
                break;
        }
    }
}

<style>
    #DialogLayout {
        margin: 0;
    }
</style>
