@page "/index.html"
@using Extension.Components
@using Extension.Layouts
@using static Extension.AppConfig

@* IndexPage (from Blazor.BrowserExtension) provides base page functionality *@
@inherits IndexPage
@layout MainLayout

@inject AppCache appCache  // Reactive: subscribes in OnInitializedAsync via SubscribeToAppCache()
@inject NavigationManager navManager
@inject ILogger<IndexPage> logger

@* 
   // TODO P2: remove this loading indicator if it is always quick.
   Intentionally empty visible content to reduce flickering during navigation.
   This page serves as the routing hub - other pages navigate here when done with their step,
   and RedirectIfNeeded() determines the next appropriate page based on app state.
*@
    <MudContainer id="@this.GetType().Name" Class="bt-body-page" Style="background-color:red;">
        <MudText>Index.razor</MudText>
        <MudPaper Style="width:100vw; height: 90vh; background-color:transparent; align-items:center; justify-content: center; display:flex;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </MudPaper>
    </MudContainer>

@implements IDisposable
@code {
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        logger.LogInformation("OnInitializedAsync Index.razor");

        // Subscribe to AppCache changes - will trigger RedirectIfNeeded when state updates
        await appCache.WaitForAppCache([() => appCache.IsReady]);
        await this.SubscribeToAppCache(appCache, RedirectIfNeeded);

        await RedirectIfNeeded();
    }

    // NavigateIfNeeded navigates to newUrl only if not already on that page.
    void NavigateIfNeeded(string newUrl)
    {
        if (navManager.Uri.Contains(newUrl))
        {
            return;
        }
        navManager.NavigateTo(newUrl);
    }

    // RedirectIfNeeded checks AppCache state and navigates to appropriate page,
    // ensuring the app progresses through onboarding, configuration, authentication, etc.
    async Task RedirectIfNeeded()
    {
        logger.LogInformation("RedirectIfNeeded");

        if (!appCache.MyOnboardState.IsWelcomed)
        {
            NavigateIfNeeded(RouteToWelcome);
            return;
        }
        if (!appCache.IsInstallAcknowledged)
        {
            NavigateIfNeeded(RouteToNewRelease);
            return;
        }
        if (!appCache.IsTosAgreed)
        {
            NavigateIfNeeded(RouteToTerms);
            return;
        }
        if (!appCache.IsPrivacyAgreed)
        {
            NavigateIfNeeded(RouteToPrivacy);
            return;
        }
        // Passing above conditions must equate to IsProductOnboarded
        if (!appCache.IsProductOnboarded)
        {
            logger.LogError("RedirectIfNeeded: Not ProductOnboarded");
            return;
        }
        if (!appCache.IsConfigured)
        {
            NavigateIfNeeded(RouteToConfigure);
            return;
        }
        // Passing the above conditions must equate to IsInitialized
        if (!appCache.IsInitialized)
        {
            logger.LogError("RedirectIfNeeded: Not Initialized");
            return;
        }
        if (!appCache.IsSessionUnlocked)
        {
            NavigateIfNeeded(RouteToUnlock);
            return;
        }
        if (!appCache.IsAuthenticated)
        {
            logger.LogError("RedirectIfNeeded: Not Authenticated");
            return;
        }
        if (!appCache.IsIdentifierFetched)
        {
            NavigateIfNeeded(RouteToConnecting);
            return;
        }
        // Passing the above conditions must equate to IsConnectedToKeria
        if (!appCache.IsConnectedToKeria)
        {
            logger.LogError("RedirectIfNeeded: Not ConnectedToKeria");
            return;
        }

        // Check for query parameter routing (e.g., popup requests)
        if (App.InitialUri?.Query is not null)
        {
            var query = System.Web.HttpUtility.ParseQueryString(App.InitialUri.Query);
            if (query["page"] != null)
            {
                var pageParam = query["popupType"] switch
                {
                    "selectAuthorize" => RouteToRequestSignIn,
                    "signRequest" => RouteToRequestSignHeaders,
                    _ => null
                };
                if (pageParam != null)
                {
                    logger.LogInformation("RedirectIfNeeded: navigating to page param: {p}", pageParam);
                    NavigateIfNeeded(pageParam);
                    return;
                }
            }
        }

        // Fully authenticated and connected - navigate to Dashboard
        // logger.LogInformation("RedirectIfNeeded: No re-route conditions detected, navigating to Dashboard");
        NavigateIfNeeded(RouteToDashboard);
    }

    public void Dispose()
    {
        this.UnsubscribeFromAppCache();
        GC.SuppressFinalize(this);
    }
}
