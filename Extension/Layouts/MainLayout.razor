@inherits BaseLayout
@using Extension.Models.Storage
@using Extension.Services.Storage
@using System
@using Extension.Services.SignifyService.Models

@using Extension.Pages
@using System.Reactive.Linq
@inject HttpClient http
@inject IJSRuntime js
@inject NavigationManager navManager
@inject IStorageService storageService
@inject ISnackbar snackbar
@inject ILogger<MainLayout> logger
@inject ISignifyClientService signifyClientService
@inject IWebExtensionsApi webExtensionsApi
@inject IJsRuntimeAdapter jsRuntimeAdapter
@inject AppCache appCache // Note: will receive reactive updates via SubscribeToAppCache

@implements IDisposable

@code {
    // fields...
    static public IJSObjectReference? utilModule;
    const string miniWidth = "var(--mud-drawer-mini-width-left)";
    const string openWidth = "var(--mud-drawer-width-left)";
    string version = "";
    string version_name = "";
    bool isInPopup;

    // properties...
    bool IsProfilePanelOpen { get; set; }
    DrawerVariant ActiveDrawerVariant { get; set; } = DrawerVariant.Persistent;
    bool IsMenuDrawerOpen { get; set; }
    // TODO P1 Having one session timer at App level or a new inherited KeriAuthBaseLayout would be better, since DialogLayout and popups may also timeout and should have warning.
    Timer? appBarRefreshTimer;

    // reactive properties ...
    Object ActiveAidObject => (object)ActivePrefix;
    string ActivePrefix => appCache.MyPreferences.SelectedPrefix;
    string ActivePrefixIdenticon => Helper.Identicon.MakeIdenticon(ActivePrefix); // Identifiers.Find(x => x.Prefix == ActivePrefix) != null ? Helper.Identicon.MakeIdenticon(ActivePrefix) : "";
    string ActiveAlias => "TBD"; // Identifiers.Find(x => x.Prefix == ActivePrefix)?.Name ?? "";
    bool IsIdenticonHidden => (string.IsNullOrEmpty(ActivePrefix));
    static ContextFilter contextFilterPopup => new ContextFilter() { ContextTypes = [ContextType.POPUP] };
    TimeSpan SessionDurationRemaining => appCache.MyPasscodeModel.SessionExpirationUtc - DateTime.UtcNow;
    string MainContentStyle => (IsMenuDrawerOpen, ActiveDrawerVariant) switch
    {
        // TODO P2 consider SidePanel variant if implemented
        (_, DrawerVariant.Mini) => $"left: {miniWidth}; width:calc(100vw - {miniWidth}; padding-right: {miniWidth});",
        (_, DrawerVariant.Temporary) => $"left: 0; width:calc(100vw);",
        (true, DrawerVariant.Persistent) => $" width:calc(100vw - {openWidth}); ",
        (true, _) => $"left: 0; width:calc(100vw);",
        (false, DrawerVariant.Persistent) => $"left: 0; width:calc(100vw); padding-right: 0;",
        (false, _) => $"left: {openWidth}; width:calc(100vw - {openWidth});"
    };
    // When session is unlocked and about to expire, provide countdown Text that alternates between two color Styles
    (string Text, string Style) TimeoutText => (
            appCache.IsAuthenticated &&
            (int)SessionDurationRemaining.TotalSeconds < AppConfig.DisplaySessionExpirationAtSecondsRemaining &&
            (int)SessionDurationRemaining.TotalSeconds >= 1)
            ? (DateTime.UtcNow.Second % 2) == 0 ? ($"Timeout in {SessionDurationRemaining.Seconds:D}", "color:var(--mud-palette-warning);")
              : ($"Timeout in {SessionDurationRemaining.Seconds:D}", "color:var(--mud-palette-primary);")
            : ("", "");

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        logger.LogInformation("OnInitializedAsync");

        // TODO P3 Perf: these (i.e., extensionId, manifestJson, version, version_name, ...) could be moved into App, and availale widely with static property
        // TODO P2 DRY with this (e.g. setting version, version_name) in other locations including Index, NewReleasePage. Move to App.
        webExtensionsApi = new WebExtensionsApi(jsRuntimeAdapter);
        // var extensionId = webExtensionsApi.Runtime.Id;

        var contextFilter = new ContextFilter() { ContextTypes = [ContextType.POPUP, ContextType.TAB, ContextType.SIDEPANEL, ContextType.BACKGROUND] };
        var contexts2 = await webExtensionsApi.Runtime.GetContexts(contextFilter);
        // logger.LogInformation("OnInitializedAsync contexts: {c}", contexts2.ToList());
        isInPopup = contexts2.Any(c => c.ContextType == ContextType.POPUP);

        var manifestJsonElement = webExtensionsApi.Runtime.GetManifest();
        if (manifestJsonElement.TryGetProperty("version", out JsonElement versionElement) && versionElement.ValueKind == JsonValueKind.String)
        {
            version = versionElement.ToString();
        }
        if (manifestJsonElement.TryGetProperty("version_name", out JsonElement version_nameElement) && version_nameElement.ValueKind == JsonValueKind.String)
        {
            version_name = version_nameElement.ToString();
        }

        // Subscribe to AppCache changes - will trigger NavigateIfNeeded when state updates
        await this.SubscribeToAppCache(appCache, HandleAppCacheChanged);

        CreateAppBarRefreshTimer();
    }

    async Task HandleAppCacheChanged()
    {
        logger.LogInformation("HandleAppCacheChanged");
        StateHasChanged();
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        logger.LogInformation("OnParametersSetAsync");

        // determine drawer varient depending and open state depending on context.
        // TODO P4 This could be moved into App or BaseLayout and be cascaded, unless specific to this layout

        var contextFilter = new ContextFilter() { ContextTypes = [ContextType.POPUP, ContextType.TAB, ContextType.SIDEPANEL, ContextType.BACKGROUND] };
        var contexts2 = await webExtensionsApi.Runtime.GetContexts(contextFilter);
        logger.LogInformation("OnInitializedAsync contexts: {c}", contexts2.ToList());
        isInPopup = contexts2.Any(c => c.ContextType == ContextType.POPUP);
        var isInSidePanel = contexts2.Any(c => c.ContextType == ContextType.SIDEPANEL);
        var isInTab = contexts2.Any(c => c.ContextType == ContextType.TAB);


        ActiveDrawerVariant = (isInPopup, isInSidePanel, isInTab) switch
        {
            (true, _, _) => appCache.MyPreferences.DrawerVariantInPopup,
            (_, true, _) => appCache.MyPreferences.DrawerVariantInTab, // TODO P3 consider separate SidePanel preference
            (_, _, true) => appCache.MyPreferences.DrawerVariantInTab,
            _ => appCache.MyPreferences.DrawerVariantInTab
        };

        if (ActiveDrawerVariant == DrawerVariant.Persistent)
        {
            IsMenuDrawerOpen = appCache.MyPreferences.IsPersistentDrawerOpen;
        }
        else
        {
            IsMenuDrawerOpen = false;
        }

        StateHasChanged();
    }

    private void CreateAppBarRefreshTimer()
    {
        appBarRefreshTimer = new Timer(
            callback: (_) =>
            {
                // Periodically trigger a UI update of layout components only when helpful and necessary,
                // such as showing a timeout countdown when session is about to expire.
                // Note: the actual session expiration handling is done elsewhere. Search for various places of storage.clear of session storage.
                if (appCache.IsSessionNotExpired &&
                    (appCache.MyPasscodeModel.SessionExpirationUtc - DateTime.UtcNow).Seconds < AppConfig.DisplaySessionExpirationAtSecondsRemaining)
                {
                    // logger.LogInformation("RestartOrExtendAppBarUpdateTime");
                    StateHasChanged();
                }
            },
            state: null,
            dueTime: TimeSpan.FromSeconds(1),
            period: TimeSpan.FromSeconds(1));
    }

    async Task SetActiveAid(string prefix)
    {
        IsProfilePanelOpen = false;
        await storageService.SetItem<Preferences>(appCache.MyPreferences with { SelectedPrefix = prefix });
    }

    async Task ClickToggleProfilePanel(MouseEventArgs _)
    {
        await ToggleProfilePanel();
    }

    async Task ToggleProfilePanel()
    {
        IsProfilePanelOpen = !IsProfilePanelOpen;
    }

    async Task ToggleMenuDrawer()
    {
        IsMenuDrawerOpen = !IsMenuDrawerOpen;
        // TODO P3 Menu button: are really we toggling only the PersistentDrawer?
        // .... and page will update via AppCache subscription, assuming we want to toggle ALL layouts using the same preference ???
        // var newPrefs = a.MyPreferences with { IsPersistentDrawerOpen = IsMenuDrawerOpen };
        // await storageService.SetItem<Preferences>(newPrefs);
    }

    private async Task RefreshConnect()
    {
        // TODO P3 not yet implemented
        // snackbar.Add("Refreshing connection...", Severity.Info);
    }

    public void Dispose()
    {
        appBarRefreshTimer?.Dispose();
    }
}


<MudThemeProvider Theme="@AppConfig.MyCustomTheme" IsDarkMode="appCache.MyPreferences.IsDarkTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider Style="z-index:9999" />

<MudLayout id="MainLayout" Style="overflow-y:hidden; overflow-x:hidden; box-sizing: border-box; position:absolute; top:0; width:100vw;">
    <!-- APP BAR -->
    <MudAppBar Elevation="2" Style="padding-left: 0px; padding-right: 0px; height:var(--bt-appbar-height);">
        <MudStack Style="height:inherit; width: 100%; padding-bottom:8px;" Class="d-flex pt-2" Row="true">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleMenuDrawer" Style="padding-left: 5px;" data-testid="menuHamburger" />
            <MudButton Href="@RouteToIndex" Style="padding: 10px; height:fit-content; align-self:center; border:none; border-radius:16px; background:#00000020;">
                <img src="images/logo512.png" alt="Icon" style="width: 24px; height: 24px;" />
                <MudText Style="margin-left:7px; font-size:larger; color:hsl(183deg 100% 50%); font-variant: small-caps;">KeriAuth</MudText>
            </MudButton>

            <!-- Nice-to-have Indicators -->
            <MudStack Row="true" Style="margin-left:16px; display:flex; align-items:center;">
                <!-- Session Timeout Indicator -->
                <MudText Typo="Typo.caption" Style="@TimeoutText.Style">
                    @TimeoutText.Text
                </MudText>
            </MudStack>

            <MudSpacer />
            <!-- KERIA Connected Indicator -->
            <div style="align-self:center; height: 35px; margin-right: -8px;">
                @if (appCache.IsAuthenticated)
                {
                    @if (appCache.IsIdentifierFetched)
                    {
                        <MudTooltip Text="Connected to KERI Agent" Arrow="true" Placement="Placement.Left" Delay="1000">
                            <MudPaper Style="width: 35px; height: 35px; border-radius: 50%; display: flex; box-shadow:none; align-items: center; justify-content: center; background-color: transparent; color:var(--mud-palette-success)">
                                <MudIcon Icon="@Icons.Material.Filled.Link" Disabled="@(!appCache.IsConfigured)" @onclick="async () => await RefreshConnect()" />
                            </MudPaper>
                        </MudTooltip>
                    }
                    else
                    {
                        <MudTooltip Text="Not Connected to KERI Agent" Arrow="true" Placement="Placement.Left" Delay="1000">
                            <MudPaper Style="width: 35px; height: 35px; border-radius: 50%; display: flex; box-shadow:none; align-items: center; justify-content: center; background-color: transparent; color:var(--mud-palette-failure)">
                                <MudIcon Icon="@Icons.Material.Filled.LinkOff" Disabled="@(!appCache.IsConfigured)" @onclick="async () => await RefreshConnect()" />
                            </MudPaper>
                        </MudTooltip>
                    }
                }
                else
                {
                    <MudTooltip Text="KERI Auth is locked" Arrow="true" Placement="Placement.Left" Delay="1000">
                        <MudPaper Style="width: 35px; height: 35px; border-radius: 50%; display: flex; box-shadow:none; align-items: center; justify-content: center; background-color: transparent; color:var(--mud-palette-warning)">
                            <MudIcon Icon="@Icons.Material.Filled.Lock" Disabled="@(!appCache.IsConfigured)" @onclick="() => navManager.NavigateTo(AppConfig.RouteToUnlock)" />
                        </MudPaper>
                    </MudTooltip>
                }
            </div>

            <!-- Current AID Alias and Prefix Identicon -->
            @* // TODO P3 Fix Alias display when long - currently cuts off abruptly without ellipsis?
                <MudStack Row AlignItems=AlignItems.Center>
                    <!-- Middle Text with ellipsis -->
                    <MudText Style="max-width:100px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" Typo="Typo.body2"> @ActiveAlias </MudText>

                    <!-- Right Icon -->
                    <MudTooltip Text="@ActiveAlias" Arrow="true" Placement="Placement.Left" Delay="1000" Style="display:flex;">
                        <MudIcon @onclick="async (a) => await ClickToggleProfilePanel(a)" ViewBox="0 0 100 100" Icon="@ActivePrefixIdenticon" Style="border-style:solid; border-color:black; border-width:2px; border-radius:50%; width:35px; height:35px; overflow:hidden;" />
                    </MudTooltip>
                </MudStack>
            *@

            <!-- Current Identifier Identicon -->
            <div style="align-self:center; height: 35px; margin-right: -8px;">
                @if (!IsIdenticonHidden)
                {
                    <MudTooltip Text=@ActiveAlias Arrow="true" Placement="Placement.Left" Delay="500">
                        <MudIcon @onclick="async (a) => await ClickToggleProfilePanel(a)" ViewBox="0 0 100 100" Icon=@ActivePrefixIdenticon Style="border-style:solid; border-color:black; border-width:2px; border-radius:50%; width:35px; height:35px; overflow:hidden;" />
                    </MudTooltip>
                }
            </div>

        </MudStack>

        <!-- The Identifier Selector overlay covers entire page -->
        <MudOverlay DarkBackground LightBackground @bind-Visible="@IsProfilePanelOpen" @onclick="ToggleProfilePanel" Style="display: block; width:100vw; min-height:100vh; height:fit-content; overflow-y:auto; color:var(--mud-palette-primary);">
            <div style="background:var(--mud-palette-background); position:absolute; height: auto; right: 0px; display:block; width:300px; margin-top: var(--bt-appbar-height); border-style: solid; border-top-style:none; border-width: 1px; border-color: #CACACA;">
                <MudList SelectedValue="ActiveAidObject" onselect="async (o) => await SetActiveAid(o)" Class="bt-sad-4;" Style="padding: 0px">

                    @foreach (var aid in new List<Aid>()) // TODO P1: Get Identifiers via App Session.KeriaConnectInfo that could later be in separate collection)
                    {
                        <MudListItem Value="aid.Prefix" OnClick="async () => await SetActiveAid(aid.Prefix)" Style=@("border-left:" + @IdentifiersPage.CardClass(ActivePrefix, aid.Prefix)) Class="bt-sad-5">
                            <MudStack Row="true" Style="display:inline-flex !important; align-items:center;">
                                <MudIcon Icon=@Helper.Identicon.MakeIdenticon(aid.Prefix) ViewBox="0 0 100 100" Style="border-style:solid; border-color:black; border-width:2px; border-radius:50%; width:35px; height:35px; overflow:hidden; margin-top: 3px;" />
                                <div class="bt-sad-2" style="display:contents;">
                                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">@aid.Name</MudText>
                                </div>
                            </MudStack>
                        </MudListItem>
                        <MudDivider DividerType="DividerType.Inset" />
                    }
                </MudList>
                <MudStack Row="true" Class="mt-3 mb-3 d-flex justify-end" Style="padding-right:8px;">
                    <MudSpacer></MudSpacer>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Href=@RouteToIdentifiers>Manage Identifiers</MudButton>
                </MudStack>
            </div>
        </MudOverlay>
    </MudAppBar>

    <!-- MENU DRAWER AND MAIN CONTENT -->
    @*
        // TODO P3 the linear gradient background experiment below should either eliminated or make visually good and depending on IsDarkTheme setting
    *@
    <MudDrawerContainer id="MudDrawerContainer" Style="height:calc(100vh - var(--mud-appbar-height)); top:var(--mud-appbar-height); position:absolute; width:inherit; display:flex; background-image:linear-gradient( 135deg, HSLA(205, 45%, 44%, 0.0), HSLA(189, 100%, 50%, 0.1) );">
        <MudDrawer id="MudDrawer" @bind-Open="@IsMenuDrawerOpen" Elevation="1" ClipMode="DrawerClipMode.Never" Variant="@ActiveDrawerVariant" OpenMiniOnHover="true">
            <MudNavMenu Style="Background: var(--mud-palette-appbar-background); height:calc(100vh - var(--mud-appbar-height)); overflow-y:auto; padding-right:16px;">
                <MudNavLink Href=@RouteToDashboard Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Dashboard" IconColor="Color.Surface">Dashboard</MudNavLink>
                <MudNavLink Href=@RouteToIdentifiers Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Key" IconColor="Color.Surface">Identifiers</MudNavLink>
                <MudNavLink Href=@RouteToCredentials Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Badge" IconColor="Color.Surface">Credentials</MudNavLink>
                <MudNavLink Href=@RouteToWebsites Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Filled.Web" IconColor="Color.Surface" data-testid="menuWebsites">Websites</MudNavLink>

                <MudNavGroup Title="Advanced" Icon="@Icons.Material.Filled.Settings" IconColor="Color.Surface" Style="padding-right: 0;">
                    <MudNavLink Href=@RouteToAuthenticators Icon="@Icons.Material.Filled.Key" Disabled="@(!appCache.IsAuthenticated)" IconColor="Color.Surface">Authenticators</MudNavLink>
                    <MudNavLink Href=@RouteToManagePrefs Icon="@Icons.Material.Filled.SettingsApplications" IconColor="Color.Surface">Preferences</MudNavLink>
                    <MudNavLink Href=@RouteToManageAgents Disabled="@(!appCache.IsAuthenticated)" Icon="@Icons.Material.Outlined.PeopleOutline" IconColor="Color.Surface">KERI Agent</MudNavLink>
                    @if (appCache.IsAuthenticated)
                    {
                        <MudNavLink OnClick="async () => await storageService.Clear(StorageArea.Session)" Icon="@Icons.Material.Filled.Lock" IconColor="Color.Surface">Lock</MudNavLink>
                    }
                    else
                    {
                        <MudNavLink OnClick="() => navManager.NavigateTo(RouteToIndex)" Icon="@Icons.Material.Filled.LockOpen" IconColor="Color.Surface">Unlock</MudNavLink>
                    }
                    <MudNavLink Href=@RouteToDelete Icon="@Icons.Material.Filled.DeleteForever" IconColor="Color.Surface">Delete Config&hellip;</MudNavLink>
                    <MudNavLink Href=@RouteToTest Icon="@Icons.Material.Filled.TempleBuddhist" IconColor="Color.Surface">Test</MudNavLink>
                </MudNavGroup>

                <MudNavGroup Title="About" Icon="@Icons.Material.Filled.Info" IconColor="Color.Surface">
                    <!-- TODO P4 provide help -->
                    <MudNavLink Style="display:none !important;" Href=@RouteToHelp Target="help" Icon="@Icons.Material.Filled.Help" IconColor="Color.Surface">Help</MudNavLink>
                    <MudNavLink Href=@RouteToTermsHtml Target="terms" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Terms</MudNavLink>
                    <MudNavLink Href=@RouteToPrivacyHtml Target="privacy" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Privacy</MudNavLink>
                    <!-- TODO P4 provide licenses -->

                    <MudNavLink Style="display:none !important;" Href=@RouteToLicensesHtml Target="licenses" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Licenses</MudNavLink>
                    <MudNavLink Href=@RouteToReleaseHtml Target="releaseNotes" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Release Notes<br /><i>version @version_name</i></MudNavLink>
                    <MudNavLink Href=@RouteToReleaseHistoryHtml Target="releaseHistory" Icon="@Icons.Material.Filled.StickyNote2" IconColor="Color.Surface">Release History<br /></MudNavLink>
                </MudNavGroup>
            </MudNavMenu>
        </MudDrawer>

        <!-- MAIN CONTENT -->
        <MudMainContent Class="bt-main-content" Style="@MainContentStyle">
            <MudContainer MaxWidth="MaxWidth.Large" Style="height:inherit; min-height:inherit; padding-left:0; padding-right:0;">
                @Body
            </MudContainer>
        </MudMainContent>
    </MudDrawerContainer>
</MudLayout>
